{
  "file_name": "06_cashback_utilisation.sql",
  "timestamp": "/Users/sharlenechew/redshift-semantic",
  "business_question": "How effective is the cashback program at driving repeat business from our QR ordering feature in Malaysia? I need to see the cashback utilization rate for Beep orders over the last 12 months, with the total amounts claimed and redeemed standardized in SGD.",
  "golden_sql": "select \n    date_trunc('month', cast(dateadd(hour,8,lc.eventtime) as date)) as month,\n    --count(distinct lc.receiptnumber) as \"claimed cashback #\",\n    --count(distinct tr.receiptnumber) as bdtxn_count,\n    --count(distinct tr.consumerid) as \"claimed cashback unique consumer #\",\n    sum(case\n            when lc.eventtype = 'earned' and b.country = 'MY' then lc.amount * 0.31\n            when lc.eventtype = 'earned' and b.country = 'PH' then lc.amount * 0.025\n            when lc.eventtype = 'earned' and b.country = 'TH' then lc.amount * 0.039\n            when lc.eventtype = 'earned' and b.country = 'SG' then lc.amount\n        end) as \"claimed cashback amount (SGD)\",\n    -sum(case\n            when lc.eventtype = 'expense' and b.country = 'MY' then lc.amount * 0.31\n            when lc.eventtype = 'expense' and b.country = 'PH' then lc.amount * 0.025\n            when lc.eventtype = 'expense' and b.country = 'TH' then lc.amount * 0.03\n            when lc.eventtype = 'expense' and b.country = 'SG' then lc.amount\n        end) as \"redeemed cashback amount (SGD)\",\n    \"redeemed cashback amount (SGD)\" / \"claimed cashback amount (SGD)\" as \"cashback utilisation rate\"\n    --cast(\"claimed cashback amount (SGD)\" as float) / cast(\"claimed cashback unique consumer #\" as float) as \"avg claimed cashback amount per consumer (SGD)\"\n        \nfrom storehub_mongo.loyaltychangelogs lc\n\nleft join transformations.mask_businesses b\n    on lc.business = b.name\n\nleft join storehub_mongo.transactionrecords tr\n    on lc.receiptnumber = tr.receiptnumber\n    \nwhere lc.eventtype in ('earned','expense')\n    and lc.rewardtype = 'cashback' \n    and lc.source = 'QR_ORDERING'\n    and CHARINDEX('internal', b.planid) = 0 \n    and CHARINDEX('@storehub.com', b.email) = 0\n    and tr.channel = 3 \n    and tr.shippingtype in ('delivery', 'pickup', 'dineIn', 'takeaway') \n    and tr.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    and b.country in ('MY')\n    and lc.eventtime BETWEEN dateadd(hour,-8,date_trunc('month', cast(getdate() + INTERVAL '-12 month' as date))) and dateadd(hour,16,cast(getdate() as date))\n\n\ngroup by 1\norder by 1 DESC",
  "ai_generated_sql": "SELECT\n    date_trunc('month', cast(dateadd(hour, 8, lc.eventtime) AS date)) AS transaction_month,\n    sum(CASE WHEN lc.eventtype = 'earned' THEN lc.amount * 0.31 ELSE 0 END) AS claimed_cashback_amount_sgd,\n    -sum(CASE WHEN lc.eventtype = 'expense' THEN lc.amount * 0.31 ELSE 0 END) AS redeemed_cashback_amount_sgd,\n    redeemed_cashback_amount_sgd / NULLIF(claimed_cashback_amount_sgd, 0) AS cashback_utilization_rate\nFROM\n    storehub_mongo.loyaltychangelogs AS lc\nLEFT JOIN\n    transformations.mask_businesses AS b ON lc.business = b.name\nLEFT JOIN\n    storehub_mongo.transactionrecords AS tr ON lc.receiptnumber = tr.receiptnumber\nWHERE\n    lc.eventtime >= dateadd(hour, -8, date_trunc('month', dateadd('month', -12, getdate())))\n    AND lc.eventtype IN ('earned', 'expense')\n    AND lc.rewardtype = 'cashback'\n    AND lc.source = 'QR_ORDERING'\n    AND b.country = 'MY'\n    AND tr.channel = 3\n    AND tr.shippingtype IN ('delivery', 'pickup', 'dineIn', 'takeaway')\n    AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    AND CHARINDEX('internal', b.planid) = 0\n    AND CHARINDEX('@storehub.com', b.email) = 0\nGROUP BY\n    1\nORDER BY\n    1 DESC",
  "api_result": {
    "success": false,
    "status_code": null,
    "error": "HTTPSConnectionPool(host='metabase.shub.us', port=443): Read timed out. (read timeout=30)",
    "query": "SELECT\n    date_trunc('month', cast(dateadd(hour, 8, lc.eventtime) AS date)) AS transaction_month,\n    sum(CASE WHEN lc.eventtype = 'earned' THEN lc.amount * 0.31 ELSE 0 END) AS claimed_cashback_amount_sgd,\n    -sum(CASE WHEN lc.eventtype = 'expense' THEN lc.amount * 0.31 ELSE 0 END) AS redeemed_cashback_amount_sgd,\n    redeemed_cashback_amount_sgd / NULLIF(claimed_cashback_amount_sgd, 0) AS cashback_utilization_rate\nFROM\n    storehub_mongo.loyaltychangelogs AS lc\nLEFT JOIN\n    transformations.mask_businesses AS b ON lc.business = b.name\nLEFT JOIN\n    storehub_mongo.transactionrecords AS tr ON lc.receiptnumber = tr.receiptnumber\nWHERE\n    lc.eventtime >= dateadd(hour, -8, date_trunc('month', dateadd('month', -12, getdate())))\n    AND lc.eventtype IN ('earned', 'expense')\n    AND lc.rewardtype = 'cashback'\n    AND lc.source = 'QR_ORDERING'\n    AND b.country = 'MY'\n    AND tr.channel = 3\n    AND tr.shippingtype IN ('delivery', 'pickup', 'dineIn', 'takeaway')\n    AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    AND CHARINDEX('internal', b.planid) = 0\n    AND CHARINDEX('@storehub.com', b.email) = 0\nGROUP BY\n    1\nORDER BY\n    1 DESC"
  }
}