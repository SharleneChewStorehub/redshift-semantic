{
  "file_name": "07_engage_active_campaign.sql",
  "timestamp": "/Users/sharlenechew/redshift-semantic",
  "business_question": "I need an operational dashboard to monitor all currently active Engage campaigns in Malaysia. For each campaign, I need to see its performance metrics like total SMS sent, the merchant's current SMS credit balance, and what percentage of the eligible customer base has been targeted.",
  "golden_sql": "select \n    c.business,\n    b.businesstype,\n    c.name as \"campaign\",\n    count(distinct case when cj.pushstatus = 'SUCCESS' and cj.createdtime >= '2022-09-23' then cj._id end) as total_sms_sent,\n    min(case when cj.createdtime >= '2022-09-23' then dateadd(hour,8,cj.createdtime) end) as first_sms_sent_time, -- start of Engage\n    cust.\"phone\" as customers_with_phones,\n    cust.\"cb count\" as customers_with_cashback,\n    cust.\"bday count\" as customers_with_birthday,\n    b.smscredits as sms_credit_balance,\n    case \n\t    when total_sms_sent > 0 and customers_with_cashback > 0 and c.name in ('Cashback Reminder','Expiring Cashback Alert') then cast(total_sms_sent as float) / cast(customers_with_cashback as float) \n\t    when total_sms_sent > 0 and c.name in ('Win Back Lost Customers','Boost Google Reviews','Welcome New Customers') then cast(total_sms_sent as float) / cast(customers_with_phones as float)\n\t    when total_sms_sent > 0 and customers_with_birthday > 0 and c.name = 'Birthday Promotion' then cast(total_sms_sent as float) / cast(customers_with_birthday as float) \n\t    else 0\n\tend as \"% customer targeted\",\n    --cast(total_sms_sent as float) / cast(customers_with_phones as float) as \"% customer targeted\",\n    REGEXP_REPLACE (c.template, '&#39;', '''') as template,\n    dateadd(hour,8,c.starttime) as campaign_start_time\n\nfrom storehub_mongo.campaigns c\n\nleft join storehub_mongo.campaignjobs cj\n    on c.business = cj.business\n    and c.globalcampaigninformationid = cj.globalcampaigninformationid\n\nleft join storehub_mongo.businesses b\n    on c.business = b.name\n    \nleft join (\n    SELECT \n        cu.business AS \"business\", \n        count(distinct cu.customerid) AS \"count\",\n        count(distinct cu.phone) as \"phone\",\n        count(distinct case when cu.storecreditsbalance > 0 then cu.customerid end) as \"cb count\",\n        count(distinct case when (cu.birthday is not null or co.birthday is not null) then cu.customerid end) as \"bday count\"\n    \n    FROM transformations.mask_customers cu\n    \n    left join transformations.mask_consumers co\n        on cu.consumerid = co._id\n            \n    where cu.isdeleted is NOT TRUE\n    \n    group by 1\n    ) cust\n    on cust.\"business\" = b.name\n    \nwhere CHARINDEX('internal', b.planid) = 0 \n    and CHARINDEX('@storehub.com', b.email) = 0\n    and b.subscriptionstatus = 'Active'\n    and c.status = 'ACTIVE'\n    --and cj.pushstatus = 'SUCCESS'\n    and b.country 'MY'\n\ngroup by 1,2,3,6,7,8,9,11,12\norder by 4 DESC",
  "ai_generated_sql": "WITH customer_base AS (\n    SELECT\n        cu.business,\n        COUNT(DISTINCT cu.phone) AS customers_with_phones,\n        COUNT(DISTINCT CASE WHEN cu.storecreditsbalance > 0 THEN cu.customerid END) AS customers_with_cashback,\n        COUNT(DISTINCT CASE WHEN cu.birthday IS NOT NULL OR co.birthday IS NOT NULL THEN cu.customerid END) AS customers_with_birthday\n    FROM\n        transformations.mask_customers AS cu\n    LEFT JOIN\n        transformations.mask_consumers AS co\n        ON cu.consumerid = co._id\n    WHERE\n        cu.isdeleted IS NOT TRUE\n    GROUP BY\n        1\n)\nSELECT\n    c.business,\n    c.name AS campaign_name,\n    COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS total_sms_sent,\n    b.smscredits AS sms_credit_balance,\n    CASE\n        WHEN c.name IN ('Cashback Reminder', 'Expiring Cashback Alert') AND cust.customers_with_cashback > 0\n        THEN CAST(COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS REAL) / cust.customers_with_cashback\n        WHEN c.name = 'Birthday Promotion' AND cust.customers_with_birthday > 0\n        THEN CAST(COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS REAL) / cust.customers_with_birthday\n        WHEN cust.customers_with_phones > 0\n        THEN CAST(COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS REAL) / cust.customers_with_phones\n        ELSE 0\n    END AS percentage_of_eligible_customers_targeted\nFROM\n    storehub_mongo.campaigns AS c\nLEFT JOIN\n    storehub_mongo.campaignjobs AS cj\n    ON c.business = cj.business AND c.globalcampaigninformationid = cj.globalcampaigninformationid\nLEFT JOIN\n    storehub_mongo.businesses AS b\n    ON c.business = b.name\nLEFT JOIN\n    customer_base AS cust\n    ON b.name = cust.business\nWHERE\n    c.status = 'ACTIVE'\n    AND b.country = 'MY'\n    AND b.subscriptionstatus = 'Active'\n    AND CHARINDEX('internal', b.planid) = 0\n    AND CHARINDEX('@storehub.com', b.email) = 0\nGROUP BY\n    c.business,\n    c.name,\n    b.smscredits,\n    cust.customers_with_phones,\n    cust.customers_with_cashback,\n    cust.customers_with_birthday\nORDER BY\n    total_sms_sent DESC;",
  "api_result": {
    "success": false,
    "status_code": null,
    "error": "HTTPSConnectionPool(host='metabase.shub.us', port=443): Read timed out. (read timeout=30)",
    "query": "WITH customer_base AS (\n    SELECT\n        cu.business,\n        COUNT(DISTINCT cu.phone) AS customers_with_phones,\n        COUNT(DISTINCT CASE WHEN cu.storecreditsbalance > 0 THEN cu.customerid END) AS customers_with_cashback,\n        COUNT(DISTINCT CASE WHEN cu.birthday IS NOT NULL OR co.birthday IS NOT NULL THEN cu.customerid END) AS customers_with_birthday\n    FROM\n        transformations.mask_customers AS cu\n    LEFT JOIN\n        transformations.mask_consumers AS co\n        ON cu.consumerid = co._id\n    WHERE\n        cu.isdeleted IS NOT TRUE\n    GROUP BY\n        1\n)\nSELECT\n    c.business,\n    c.name AS campaign_name,\n    COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS total_sms_sent,\n    b.smscredits AS sms_credit_balance,\n    CASE\n        WHEN c.name IN ('Cashback Reminder', 'Expiring Cashback Alert') AND cust.customers_with_cashback > 0\n        THEN CAST(COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS REAL) / cust.customers_with_cashback\n        WHEN c.name = 'Birthday Promotion' AND cust.customers_with_birthday > 0\n        THEN CAST(COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS REAL) / cust.customers_with_birthday\n        WHEN cust.customers_with_phones > 0\n        THEN CAST(COUNT(DISTINCT CASE WHEN cj.pushstatus = 'SUCCESS' THEN cj._id END) AS REAL) / cust.customers_with_phones\n        ELSE 0\n    END AS percentage_of_eligible_customers_targeted\nFROM\n    storehub_mongo.campaigns AS c\nLEFT JOIN\n    storehub_mongo.campaignjobs AS cj\n    ON c.business = cj.business AND c.globalcampaigninformationid = cj.globalcampaigninformationid\nLEFT JOIN\n    storehub_mongo.businesses AS b\n    ON c.business = b.name\nLEFT JOIN\n    customer_base AS cust\n    ON b.name = cust.business\nWHERE\n    c.status = 'ACTIVE'\n    AND b.country = 'MY'\n    AND b.subscriptionstatus = 'Active'\n    AND CHARINDEX('internal', b.planid) = 0\n    AND CHARINDEX('@storehub.com', b.email) = 0\nGROUP BY\n    c.business,\n    c.name,\n    b.smscredits,\n    cust.customers_with_phones,\n    cust.customers_with_cashback,\n    cust.customers_with_birthday\nORDER BY\n    total_sms_sent DESC;"
  }
}