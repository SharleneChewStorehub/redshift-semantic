{
  "file_name": "08_imika_stockvalue.sql",
  "timestamp": "/Users/sharlenechew/redshift-semantic",
  "business_question": "I need to get the current inventory valuation for the merchant 'imikaempiresdnbhd'. Can you give me a report that shows the total monetary value of all stock on hand for each of their stores, based on the latest inventory levels?",
  "golden_sql": "with s as (\nselect distinct\n    bs._id,\n    REGEXP_REPLACE (REGEXP_REPLACE (bs.name, '&#39;', ''''), '%7C;', ' - ') as storename\nfrom storehub_mongo.businesses b\nleft join storehub_mongo.businesses__stores bs\n    on b._id = bs.businesses_foreignkey\nwhere b.name = 'imikaempiresdnbhd'\n    --and bs._id in ('5a7815aecfe019834b13c699','65c4e47bff562e00072771b8','610c9bfd4be17100065080a2')\n),\n\np as (\nSELECT distinct\n    a.original_id,\n    a.cost\n        \nfrom storehub_mongo.products a \n    \nleft join storehub_mongo.businesses b \n    on a.business = b.\"name\" \n        \nleft join storehub_mongo.businesses__stores c \n    on b.\"_id\" = c.businesses_foreignkey \n    \n/*left join storehub_mongo.serialnumbers s\n    on s.business = a.business\n    and s.productid = a.original_id*/\n        \nwhere a.isdeleted is not true \n    and a.trackInventory is true \n    and a.inventorytype <> 'Composite'\n    and a.business ='imikaempiresdnbhd'      \n    --and c.\"_id\" in ('5a7815aecfe019834b13c699','65c4e47bff562e00072771b8','610c9bfd4be17100065080a2')\n    and (a.productType = 'Simple' or a.parentProductId <> '' or a.parentProductId is not null or a.isChild is true)\n),\n\nse as (\nselect \n    s.productid, \n    s.storeid, \n    count(*) as \"count\"\nfrom storehub_mongo.serialnumbers s\nwhere s.business = 'imikaempiresdnbhd'\ngroup by 1,2\n)\n\nselect \n    tmp.storename,\n    sum(tmp.\"quantityonhand\") as total_items,\n    sum(case \n            when tmp.\"quantityonhand\" is not null then cast(tmp.\"quantityonhand\" as float) * cast(tmp.cost as float)\n            else 0\n        end) as total_value\nfrom (\n    select \n        s.storename,\n        i.productid,\n        case \n            when i.isserialized = true then se.\"count\"\n            else i.quantityonhand\n        end as \"quantityonhand\",\n        p.cost\n        /*case \n            when \"quantityonhand\" is not null then cast(\"quantityonhand\" as float) * cast(p.cost as float)\n            else 0\n        end as value*/\n        \n    from storehub_mongo.inventories i\n    \n    left join s\n        on i.storeid = s._id\n    \n    left join p\n        on i.productid = p.original_id\n    \n    left join se\n        on se.productid = i.productid\n        and se.storeid = i.storeid\n        \n    where i.productid in (select p.original_id from p)\n        and i.business = 'imikaempiresdnbhd'\n        --and i.storeid in ('5a7815aecfe019834b13c699','65c4e47bff562e00072771b8','610c9bfd4be17100065080a2')\n        --and i.productid in ('66ed3011df00fc00071d5acc','67074fef4a53790007f8212e')\n    ) tmp\n\ngroup by 1\norder by 2 DESC",
  "ai_generated_sql": "WITH StoreData AS (\r\n    SELECT bs._id AS store_id, REGEXP_REPLACE(REGEXP_REPLACE(bs.name, '&#39;', ''''), '%7C;', ' - ') AS store_name\r\n    FROM storehub_mongo.businesses b\r\n    JOIN storehub_mongo.businesses__stores bs ON b._id = bs.businesses_foreignkey\r\n    WHERE b.name = 'imikaempiresdnbhd'\r\n),\r\nProductData AS (\r\n    SELECT p.original_id AS product_id, p.cost\r\n    FROM storehub_mongo.products p\r\n    WHERE p.business = 'imikaempiresdnbhd'\r\n      AND p.isdeleted IS NOT TRUE\r\n      AND p.trackInventory IS TRUE\r\n      AND p.inventorytype <> 'Composite'\r\n      AND (p.productType = 'Simple' OR p.parentProductId <> '' OR p.parentProductId IS NOT NULL OR p.isChild IS TRUE)\r\n),\r\nSerialNumberData AS (\r\n    SELECT s.productid, s.storeid, COUNT(*) AS serial_count\r\n    FROM storehub_mongo.serialnumbers s\r\n    WHERE s.business = 'imikaempiresdnbhd'\r\n    GROUP BY s.productid, s.storeid\r\n)\r\nSELECT sd.store_name, \r\n       SUM(CASE WHEN i.isserialized THEN COALESCE(snd.serial_count, 0) ELSE i.quantityonhand END) AS total_quantity,\r\n       SUM(CASE WHEN i.isserialized THEN COALESCE(snd.serial_count, 0) * pd.cost ELSE i.quantityonhand * pd.cost END) AS total_value\r\nFROM storehub_mongo.inventories i\r\nJOIN StoreData sd ON i.storeid = sd.store_id\r\nJOIN ProductData pd ON i.productid = pd.product_id\r\nLEFT JOIN SerialNumberData snd ON i.productid = snd.productid AND i.storeid = snd.storeid\r\nWHERE i.business = 'imikaempiresdnbhd'\r\nGROUP BY sd.store_name;",
  "api_result": {
    "success": false,
    "status_code": null,
    "error": "HTTPSConnectionPool(host='metabase.shub.us', port=443): Read timed out. (read timeout=30)",
    "query": "WITH StoreData AS (\r\n    SELECT bs._id AS store_id, REGEXP_REPLACE(REGEXP_REPLACE(bs.name, '&#39;', ''''), '%7C;', ' - ') AS store_name\r\n    FROM storehub_mongo.businesses b\r\n    JOIN storehub_mongo.businesses__stores bs ON b._id = bs.businesses_foreignkey\r\n    WHERE b.name = 'imikaempiresdnbhd'\r\n),\r\nProductData AS (\r\n    SELECT p.original_id AS product_id, p.cost\r\n    FROM storehub_mongo.products p\r\n    WHERE p.business = 'imikaempiresdnbhd'\r\n      AND p.isdeleted IS NOT TRUE\r\n      AND p.trackInventory IS TRUE\r\n      AND p.inventorytype <> 'Composite'\r\n      AND (p.productType = 'Simple' OR p.parentProductId <> '' OR p.parentProductId IS NOT NULL OR p.isChild IS TRUE)\r\n),\r\nSerialNumberData AS (\r\n    SELECT s.productid, s.storeid, COUNT(*) AS serial_count\r\n    FROM storehub_mongo.serialnumbers s\r\n    WHERE s.business = 'imikaempiresdnbhd'\r\n    GROUP BY s.productid, s.storeid\r\n)\r\nSELECT sd.store_name, \r\n       SUM(CASE WHEN i.isserialized THEN COALESCE(snd.serial_count, 0) ELSE i.quantityonhand END) AS total_quantity,\r\n       SUM(CASE WHEN i.isserialized THEN COALESCE(snd.serial_count, 0) * pd.cost ELSE i.quantityonhand * pd.cost END) AS total_value\r\nFROM storehub_mongo.inventories i\r\nJOIN StoreData sd ON i.storeid = sd.store_id\r\nJOIN ProductData pd ON i.productid = pd.product_id\r\nLEFT JOIN SerialNumberData snd ON i.productid = snd.productid AND i.storeid = snd.storeid\r\nWHERE i.business = 'imikaempiresdnbhd'\r\nGROUP BY sd.store_name;"
  }
}