{
  "file_name": "11_sales_by_paymentmethod.sql",
  "timestamp": "/Users/sharlenechew/redshift-semantic",
  "business_question": "I need a sales report for 'signaturebeefnoodles' for the first half of 2025, broken down by each payment method. Can you show me the final Net Sales for each payment type, making sure to correctly account for both returns and preorder deposits?",
  "golden_sql": "with base as (\nSELECT\n    dateadd(hour,8,tr.createdtime) as txn_createdtime,\n    tr.storeid AS \"Store ID\",\n    bs.name AS \"Store Name\",\n    tr._id,\n    tr.transactiontype,\n    CASE \n        WHEN bpo.name <> '' THEN bpo.name\n        ELSE trp.paymentmethod \n    END AS \"Payment Method\",\n    /*CASE \n        WHEN trp.paymentmethod = '' or trp.paymentmethod is null THEN tr.paymentmethod \n        ELSE trp.paymentmethod \n    END AS \"Payments paymentmethod\",*/\n    CASE \n        WHEN trp.paymentmethod = '' or trp.paymentmethod is null THEN tr.total \n        ELSE trp.amount \n    END AS \"Payment Amount\"\n    \nFROM storehub_mongo.transactionrecords tr\n\nleft join storehub_mongo.transactionrecords__payments trp \n    on trp.transactionrecords_foreignkey = tr._id\n\nleft join storehub_mongo.businesses b \n    on b.name = tr.business\n    \nleft join storehub_mongo.businesses__paymentoptions bpo \n    on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod)\n    \nleft join storehub_mongo.businesses__stores bs\n    on tr.storeid = bs._id\n\nWHERE tr.business = 'signaturebeefnoodles'\n    and (tr.createdtime >= dateadd(hour,-8,'2025-01-01') and tr.createdtime < dateadd(hour,-8,'2025-07-01')) \n    AND tr.status not in ('pendingPayment','failed','created','paymentCancelled')\n    AND tr.iscancelled is not true\n    --AND tr.transactiontype <> 'PreOrder'  \n\nGROUP BY 1,2,3,4\nORDER BY \"Store Name\" ASC, txn_createdtime ASC \n-- LIMIT 50\n-- OFFSET 0\n)\n\n\nselect \n    --tmp.\"month\",\n    --tmp.\"Store Name\",\n    tmp.\"Payment Method\",\n    tmp.\"Total Sales\",\n    tmp.\"Total Transactions\",\n    tmp.\"Total Sales Returned\",\n    tmp.\"Total Items Returned\",\n    tmp.\"PreOrder Deposits\",\n    tmp.\"PreOrder Transactions\",\n    tmp.\"Total Sales\" + tmp.\"PreOrder Deposits\" - tmp.\"Total Sales Returned\" AS \"Net Sales\" -- paymentNetSales\nfrom (\n    select\n        --date_trunc('month',cast(base.txn_createdtime as date)) AS \"month\", -- change this line accordingly to get other time variable, eg. hourly, daily, weekly, etc\n        --to_char(cast(base.txn_createdtime as date),'Day') as \"day of week\", -- use this instead of the date_trunc line to get day of week\n        --base.\"Store Name\",\n        base.\"Payment Method\",\n        SUM(CASE WHEN base.transactiontype = 'Sale' THEN COALESCE(+ base.\"Payment Amount\",0) ELSE COALESCE(0,0) END) AS \"Total Sales\", -- paymentSales\n        SUM(CASE WHEN base.transactiontype = 'Sale' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS \"Total Transactions\", -- salesCount\n        SUM(CASE WHEN base.transactiontype = 'Return'THEN COALESCE(+ base.\"Payment Amount\",0) ELSE COALESCE(0,0) END) AS \"Total Sales Returned\", -- paymentReturns\n        SUM(CASE WHEN base.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0, 0) END) AS \"Total Items Returned\", -- returnsCount\n        SUM(CASE WHEN base.transactiontype = 'PreOrder' THEN COALESCE(+ base.\"Payment Amount\",0) ELSE COALESCE(0,0) END) AS \"PreOrder Deposits\", -- preOrderDeposits\n        SUM(CASE WHEN base.transactiontype = 'PreOrder' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS \"PreOrder Transactions\" -- preorderCount\n\n    from base\n    \n    group by 1--,2,3\n    --order by \"Store Name\" asc, \"month\" asc\n    ) tmp\n\n--order by tmp.\"Store Name\" asc, tmp.\"month\" asc\n\n\n\n\n------------------------------------------------------------------------------------------\n-- Other useful sales report logic for ref (just not relevant to payment method report) --\n------------------------------------------------------------------------------------------\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(0,0) ELSE COALESCE(+tr.total,0) END) AS \"Total Sales\", --sales\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.tax,0) ELSE COALESCE(+tr.tax,0) END) AS \"Tax\", --tax\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.servicecharge,0) ELSE COALESCE(+tr.servicecharge,0) END) AS \"Service Charge\", --serviceCharge\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.roundedamount,0) ELSE COALESCE(+tr.roundedamount,0) END) AS \"Rounding\" --rounding\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(+tr.total,0) ELSE COALESCE(0,0) END) AS \"Total Sales Returned Amount\" --returns\n--COUNT(*) AS \"Total Transactions\", --count\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.discount,0) ELSE COALESCE(+tr.discount,0) END) AS \"Total Discount\", --discount\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS \"Total Sales Returned Count\", --returnsCount\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(+tr.total,0) ELSE COALESCE(0,0) END) AS \"Total Sales Returned Amount\", --returns\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.subtotal,0) ELSE COALESCE(+tr.subtotal,0) END) AS \"SubTotal\", --subtotal\n--SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.cost,0) ELSE COALESCE(+tr.cost,0) END) AS \"Total Cost\" --cost",
  "ai_generated_sql": "WITH base AS (\n    SELECT\n        DATEADD(hour, 8, tr.createdtime) AS txn_createdtime,\n        CASE\n            WHEN bpo.name <> '' THEN bpo.name\n            ELSE trp.paymentmethod\n        END AS \"Payment Method\",\n        CASE\n            WHEN trp.paymentmethod = '' OR trp.paymentmethod IS NULL THEN tr.total\n            ELSE trp.amount\n        END AS \"Payment Amount\",\n        tr.transactiontype\n    FROM storehub_mongo.transactionrecords tr\n    LEFT JOIN storehub_mongo.transactionrecords__payments trp\n        ON trp.transactionrecords_foreignkey = tr._id\n    LEFT JOIN storehub_mongo.businesses b\n        ON b.name = tr.business\n    LEFT JOIN storehub_mongo.businesses__paymentoptions bpo\n        ON bpo.businesses_foreignkey = b._id\n        AND bpo.paymentid = trp.paymentmethod\n    WHERE\n        tr.business = 'signaturebeefnoodles'\n        AND tr.createdtime >= DATEADD(hour, -8, '2025-01-01')\n        AND tr.createdtime < DATEADD(hour, -8, '2025-07-01')\n        AND tr.status NOT IN ('pendingPayment', 'failed', 'created', 'paymentCancelled')\n        AND tr.iscancelled IS NOT TRUE\n)\nSELECT\n    \"Payment Method\",\n    SUM(CASE\n        WHEN transactiontype = 'Sale' THEN \"Payment Amount\"\n        WHEN transactiontype = 'PreOrder' THEN \"Payment Amount\"\n        WHEN transactiontype = 'Return' THEN -\"Payment Amount\"\n        ELSE 0\n    END) AS \"Net Sales\"\nFROM base\nGROUP BY\n    \"Payment Method\";",
  "api_result": {
    "success": false,
    "status_code": null,
    "error": "HTTPSConnectionPool(host='metabase.shub.us', port=443): Read timed out. (read timeout=30)",
    "query": "WITH base AS (\n    SELECT\n        DATEADD(hour, 8, tr.createdtime) AS txn_createdtime,\n        CASE\n            WHEN bpo.name <> '' THEN bpo.name\n            ELSE trp.paymentmethod\n        END AS \"Payment Method\",\n        CASE\n            WHEN trp.paymentmethod = '' OR trp.paymentmethod IS NULL THEN tr.total\n            ELSE trp.amount\n        END AS \"Payment Amount\",\n        tr.transactiontype\n    FROM storehub_mongo.transactionrecords tr\n    LEFT JOIN storehub_mongo.transactionrecords__payments trp\n        ON trp.transactionrecords_foreignkey = tr._id\n    LEFT JOIN storehub_mongo.businesses b\n        ON b.name = tr.business\n    LEFT JOIN storehub_mongo.businesses__paymentoptions bpo\n        ON bpo.businesses_foreignkey = b._id\n        AND bpo.paymentid = trp.paymentmethod\n    WHERE\n        tr.business = 'signaturebeefnoodles'\n        AND tr.createdtime >= DATEADD(hour, -8, '2025-01-01')\n        AND tr.createdtime < DATEADD(hour, -8, '2025-07-01')\n        AND tr.status NOT IN ('pendingPayment', 'failed', 'created', 'paymentCancelled')\n        AND tr.iscancelled IS NOT TRUE\n)\nSELECT\n    \"Payment Method\",\n    SUM(CASE\n        WHEN transactiontype = 'Sale' THEN \"Payment Amount\"\n        WHEN transactiontype = 'PreOrder' THEN \"Payment Amount\"\n        WHEN transactiontype = 'Return' THEN -\"Payment Amount\"\n        ELSE 0\n    END) AS \"Net Sales\"\nFROM base\nGROUP BY\n    \"Payment Method\";"
  }
}