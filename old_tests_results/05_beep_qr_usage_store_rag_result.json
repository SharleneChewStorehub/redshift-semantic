{
  "file_name": "05_beep_qr_usage_store.sql",
  "timestamp": "/Users/sharlenechew/redshift-semantic",
  "business_question": "How is the adoption of our Beep QR ordering feature? For each store that has ever used it, show me what percentage of their total in-store sales and transactions came from QR orders last month.",
  "golden_sql": "with q as (\nselect distinct tr.storeid\n    \nfrom storehub_mongo.transactionrecords tr\n\nleft join storehub_mongo.businesses b\n    on tr.business = b.name\n\nwhere CHARINDEX('internal', b.planid) = 0 \n    and CHARINDEX('@storehub.com', b.email) = 0\n    and tr.channel = 3\n    and tr.shippingtype in ('dineIn','takeaway')\n    and tr.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    and b.country in ('MY')\n    and tr.createdtime >= dateadd(hour,-8,'2019-07-01') -- start of Beep QR transactions\n\nselect \n    tr.business,\n    tr.storeid,\n    date_trunc('month', cast(dateadd(hour,8,tr.createdtime) as date)) as month,\n    --count(distinct cast(dateadd(hour,8,tr.createdtime) as date)) as transacting_days,\n    count(distinct tr.receiptnumber) as instore_txn,\n    sum(tr.total) as instore_gmv,\n    count(distinct case when tr.channel = 3 then tr.receiptnumber end) as qrtxn,\n    sum(case when tr.channel = 3 then tr.total end) as qrgmv,\n    case when (qrgmv is not null and instore_gmv > 0) then qrgmv / instore_gmv else 0 end as qr_usage_gmv,\n    case when (qrtxn > 0 and instore_txn > 0) then cast(qrtxn as float) / cast(instore_txn as float) else 0 end as qr_usage_txn\n    \nfrom storehub_mongo.transactionrecords tr\n\nwhere tr.storeid in (select q.storeid from q)\n    and ((tr.channel = 3 and tr.shippingtype in ('dineIn','takeaway')) or tr.channel is null or tr.channel = 2)\n    and tr.transactiontype = 'Sale'\n    and tr.iscancelled is not TRUE\n    and tr.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    --and tr.createdtime >= dateadd(hour,-8,date_trunc('month', cast(getdate() as date)))\n    and tr.createdtime >= \n        CASE \n            WHEN date_trunc('month',dateadd(hour,-8,cast(getdate() as date))) = date_trunc('month',dateadd(hour,-8,cast(getdate()-7 as date))) THEN dateadd(hour,-8,date_trunc('month',cast(getdate() as date)))\n            ELSE dateadd(hour,-8,date_trunc('month',cast(getdate() + INTERVAL '-1 month' as date)))\n        END\n    \n\ngroup by 1,2,3\norder by 3 ASC, 1 ASC",
  "ai_generated_sql": "WITH MonthlyData AS (\r\n    SELECT\r\n        tr.storeid,\r\n        DATE_TRUNC('month', CAST(DATEADD(hour, 8, tr.createdtime) AS DATE)) AS month,\r\n        COUNT(DISTINCT tr.receiptnumber) AS instore_txn,\r\n        SUM(tr.total) AS instore_gmv,\r\n        COUNT(DISTINCT CASE WHEN tr.channel = 3 THEN tr.receiptnumber END) AS qrtxn,\r\n        SUM(CASE WHEN tr.channel = 3 THEN tr.total END) AS qrgmv\r\n    FROM storehub_mongo.transactionrecords tr\r\n    LEFT JOIN storehub_mongo.businesses b ON tr.business = b.name\r\n    WHERE CHARINDEX('internal', b.planid) = 0\r\n        AND CHARINDEX('@storehub.com', b.email) = 0\r\n        AND tr.shippingtype IN ('dineIn', 'takeaway')\r\n        AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\r\n        AND b.country IN ('MY')\r\n        AND tr.createdtime >= DATEADD(hour, -8, '2019-07-01')\r\n        AND DATE_TRUNC('month', CAST(DATEADD(hour, 8, tr.createdtime) AS DATE)) = DATE_TRUNC('month', CAST(DATEADD(hour, 8, GETDATE() + INTERVAL '-1 month') AS DATE))\r\n    GROUP BY 1, 2\r\n),\r\nStoresWithQR AS (\r\n    SELECT DISTINCT tr.storeid\r\n    FROM storehub_mongo.transactionrecords tr\r\n    LEFT JOIN storehub_mongo.businesses b ON tr.business = b.name\r\n    WHERE tr.channel = 3\r\n        AND CHARINDEX('internal', b.planid) = 0\r\n        AND CHARINDEX('@storehub.com', b.email) = 0\r\n        AND tr.shippingtype IN ('dineIn', 'takeaway')\r\n        AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\r\n        AND b.country IN ('MY')\r\n        AND tr.createdtime >= DATEADD(hour, -8, '2019-07-01')\r\n)\r\nSELECT\r\n    md.storeid,\r\n    md.month,\r\n    COALESCE(CAST(md.qrtxn AS FLOAT) / CAST(md.instore_txn AS FLOAT), 0) AS qr_txn_percentage,\r\n    COALESCE(md.qrgmv / md.instore_gmv, 0) AS qr_gmv_percentage\r\nFROM MonthlyData md\r\nWHERE md.storeid IN (SELECT storeid FROM StoresWithQR);",
  "api_result": {
    "success": false,
    "status_code": null,
    "error": "HTTPSConnectionPool(host='metabase.shub.us', port=443): Read timed out. (read timeout=30)",
    "query": "WITH MonthlyData AS (\r\n    SELECT\r\n        tr.storeid,\r\n        DATE_TRUNC('month', CAST(DATEADD(hour, 8, tr.createdtime) AS DATE)) AS month,\r\n        COUNT(DISTINCT tr.receiptnumber) AS instore_txn,\r\n        SUM(tr.total) AS instore_gmv,\r\n        COUNT(DISTINCT CASE WHEN tr.channel = 3 THEN tr.receiptnumber END) AS qrtxn,\r\n        SUM(CASE WHEN tr.channel = 3 THEN tr.total END) AS qrgmv\r\n    FROM storehub_mongo.transactionrecords tr\r\n    LEFT JOIN storehub_mongo.businesses b ON tr.business = b.name\r\n    WHERE CHARINDEX('internal', b.planid) = 0\r\n        AND CHARINDEX('@storehub.com', b.email) = 0\r\n        AND tr.shippingtype IN ('dineIn', 'takeaway')\r\n        AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\r\n        AND b.country IN ('MY')\r\n        AND tr.createdtime >= DATEADD(hour, -8, '2019-07-01')\r\n        AND DATE_TRUNC('month', CAST(DATEADD(hour, 8, tr.createdtime) AS DATE)) = DATE_TRUNC('month', CAST(DATEADD(hour, 8, GETDATE() + INTERVAL '-1 month') AS DATE))\r\n    GROUP BY 1, 2\r\n),\r\nStoresWithQR AS (\r\n    SELECT DISTINCT tr.storeid\r\n    FROM storehub_mongo.transactionrecords tr\r\n    LEFT JOIN storehub_mongo.businesses b ON tr.business = b.name\r\n    WHERE tr.channel = 3\r\n        AND CHARINDEX('internal', b.planid) = 0\r\n        AND CHARINDEX('@storehub.com', b.email) = 0\r\n        AND tr.shippingtype IN ('dineIn', 'takeaway')\r\n        AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\r\n        AND b.country IN ('MY')\r\n        AND tr.createdtime >= DATEADD(hour, -8, '2019-07-01')\r\n)\r\nSELECT\r\n    md.storeid,\r\n    md.month,\r\n    COALESCE(CAST(md.qrtxn AS FLOAT) / CAST(md.instore_txn AS FLOAT), 0) AS qr_txn_percentage,\r\n    COALESCE(md.qrgmv / md.instore_gmv, 0) AS qr_gmv_percentage\r\nFROM MonthlyData md\r\nWHERE md.storeid IN (SELECT storeid FROM StoresWithQR);"
  }
}