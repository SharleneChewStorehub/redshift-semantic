{
  "file_name": "09_thismonth_beep_qr_store.sql",
  "timestamp": "/Users/sharlenechew/redshift-semantic",
  "business_question": "I need to track the monthly performance of our Beep QR feature in Malaysia. Can you generate a report showing the total QR sales volume and transaction count for each of our QR-adopting stores for the last complete month?",
  "golden_sql": "with s as (\nselect\n    b.country,\n    b.subscriptionid,\n    tr.business,\n    tr.storeid,\n    min(dateadd(hour,8,tr.createdtime)) as first_QRtxn\n\nfrom storehub_mongo.transactionrecords tr\n\nleft join storehub_mongo.businesses b\n    on b.name = tr.business\n\nwhere tr.channel = 3\n    and tr.shippingtype in ('dineIn','takeaway')\n    and tr.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    and tr.createdtime >= dateadd(hour,-8,'2019-07-01') \n    and CHARINDEX('internal', b.planid) = 0 \n    and CHARINDEX('@storehub.com', b.email) = 0\n    and b.country = 'MY'\n\ngroup by 1,2,3,4\norder by 5 DESC\n)\n\nselect\n    date_trunc('month', cast(dateadd(hour,8,tr.createdtime)as date)) as \"month\",\n    s.country,\n    tr.business,\n    tr.storeid,\n    cast(s.first_QRtxn as date) as firstqr,\n    date_trunc('month', firstqr) as firstqr_month,\n    count(distinct tr.receiptnumber) as qrtxn,\n    sum(tr.total) as qrgmv\n\nfrom storehub_mongo.transactionrecords tr\n\ninner join s \n    on s.storeid = tr.storeid\n\nwhere tr.channel = 3\n    and tr.shippingtype in ('dineIn','takeaway')\n    and tr.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    --and tr.createdtime >= dateadd(hour,-8,date_trunc('month', cast(getdate() as date)))\n    and tr.createdtime >= \n        CASE \n            WHEN date_trunc('month',dateadd(hour,-8,cast(getdate() as date))) = date_trunc('month',dateadd(hour,-8,cast(getdate()-7 as date))) THEN dateadd(hour,-8,date_trunc('month',cast(getdate() as date)))\n            ELSE dateadd(hour,-8,date_trunc('month',cast(getdate() + INTERVAL '-1 month' as date)))\n        END\n    --and s.first_QRtxn >= date_trunc('month',CAST((getdate() + INTERVAL '-3 month') AS date))\n\ngroup by 1,2,3,4,5,6\norder by 1 ASC, 2 ASC",
  "ai_generated_sql": "SELECT\n    tr.business,\n    tr.storeid,\n    COUNT(DISTINCT tr.receiptnumber) AS qr_transaction_count,\n    SUM(tr.total) AS qr_sales_volume\nFROM storehub_mongo.transactionrecords tr\nINNER JOIN storehub_mongo.businesses b\n    ON b.name = tr.business\nWHERE\n    tr.channel = 3\n    AND tr.shippingtype IN ('dineIn','takeaway')\n    AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    AND b.country = 'MY'\n    AND tr.createdtime >= DATE_TRUNC('month', DATEADD(month, -1, GETDATE()))\n    AND tr.createdtime < DATE_TRUNC('month', GETDATE())\nGROUP BY\n    tr.business,\n    tr.storeid;",
  "api_result": {
    "success": false,
    "status_code": null,
    "error": "HTTPSConnectionPool(host='metabase.shub.us', port=443): Read timed out. (read timeout=30)",
    "query": "SELECT\n    tr.business,\n    tr.storeid,\n    COUNT(DISTINCT tr.receiptnumber) AS qr_transaction_count,\n    SUM(tr.total) AS qr_sales_volume\nFROM storehub_mongo.transactionrecords tr\nINNER JOIN storehub_mongo.businesses b\n    ON b.name = tr.business\nWHERE\n    tr.channel = 3\n    AND tr.shippingtype IN ('dineIn','takeaway')\n    AND tr.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification')\n    AND b.country = 'MY'\n    AND tr.createdtime >= DATE_TRUNC('month', DATEADD(month, -1, GETDATE()))\n    AND tr.createdtime < DATE_TRUNC('month', GETDATE())\nGROUP BY\n    tr.business,\n    tr.storeid;"
  }
}