# Business Metrics Discovery Report

**Analysis Date:** 2025-08-18 01:32:05
**Total Queries Analyzed:** 23 unique metric types found

## Executive Summary

This report presents the analysis of approximately 1000 real-world Metabase queries to discover recurring business metrics. The analysis follows the schema mapping rule where transformations schema tables are treated as their storehub_mongo equivalents.

## Discovered Metrics (Ranked by Frequency)

### **Metric: Subscription Metrics**
* **Found:** 732 times
* **Common Calculations:**
    * `Activated Store Count" from storehub_mongo.businesses b left join storehub_mongo.businesses__qrorderingsettings bq on b._id = bq.businesses_foreignkey where CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and bq.enabledelivery is FALSE and b.isqrorderingenabled is TRUE and b.firstenableqrorderingdat`
    * `Activated Store Count" from storehub_mongo.businesses b left join storehub_mongo.businesses__qrorderingsettings bq on b._id = bq.businesses_foreignkey where CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and bq.enabledelivery is true and bq.firstenabledeliverydat`
    * `Activated Stores" from storehub_mongo.businesses b left join storehub_mongo.businesses__qrorderingsettings bq on b._id = bq.businesses_foreignkey where CHARINDEX('internal', b.planid) = 0 and CHARINDEX('storehub.com', b.email) = 0 and bq.enabledelivery is FALSE and b.isqrorderingenabled is TRUE and b.firstenableqrorderingdat`
    * `Activated Stores" from storehub_mongo.businesses b left join storehub_mongo.businesses__qrorderingsettings bq on b._id = bq.businesses_foreignkey where CHARINDEX('internal', b.planid) = 0 and CHARINDEX('storehub.com', b.email) = 0 and bq.enabledelivery is true and bq.firstenabledeliverydat`
    * `Activated Stores", b.country from storehub_mongo.businesses b left join storehub_mongo.businesses__qrorderingsettings bq on b._id = bq.businesses_foreignkey where b.planid not in ('internal-unlimited-test-plan-2','internal-unlimited-test-plan-thb','internal-unlimited_monthly') and b.email not like '%@storehub.com' and bq.enabledelivery is true and bq.firstenabledeliverydate is not null and date_trunc('month',cast(dateadd(hour,8,bq.firstenabledeliverydate) as date)) BETWEEN date_trunc('month', CAST((getdate() + INTERVAL '-2 months') AS date)) and date_trunc('month', CAST(getdate() AS dat`
    * `CustomerDisplay' and rl."value" = 'On' order by 1 ASC ) select b.name, b.country, b.enableloyalty as enabled_storecredits, b.enablemultipleipads as enabled_MRS, c."value" as enabled_CFD from storehub_mongo.businesses b left join (select distinct businessname, "value" from cfd) c on b.name = c.businessname where {{snippet: Eliminate Internal Accounts}} and b.subscription`
    * `Subscription ID", b.planid as "businesses Plan ID", c.plan_id as "chargebee Plan ID", t.business as "Business Name", COUNT(t._id)/30 as "Txn#", sum(t.total)/30 as "GMV" from storehub_mongo.transactionrecords t left join storehub_mongo.businesses b on b.name = t.business left join chargebeerm.subscriptions c on c.id = b.subscriptionid where cast(dateadd(hour,8,t.createdtime) as date) BETWEEN cast(dateadd(day,-30,getdate()) as date) and CAST(getdate() AS date) and t.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('storehub.com', b.email) = 0 and c.status`
    * `Subscription ID", c.plan_id as "Plan ID", t.business as "Business Name", COUNT(t._id)/30 as "Txn#", sum(t.total)/30 as "GMV" from storehub_mongo.transactionrecords t left join storehub_mongo.businesses b on b.name = t.business left join chargebeerm.subscriptions c on c.id = b.subscriptionid where cast(dateadd(hour,8,t.createdtime) as date) BETWEEN cast(dateadd(day,-30,getdate()) as date) and CAST(getdate() AS date) and t.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('storehub.com', b.email) = 0 and c.status`
    * `Subscription Id", sa."id" as "Addon Id", sa.quantity as "Addon Quantity", s.currency_code as "Currency", cast(sa.unit_price as float)/100 as "Addon Unit Price", cast(sa.amount as float)/100 as "Addon Amount", '' as "Addon Amount In Decimal", '' as "Addon Quantity In Decimal", '' as "Addon Unit Price In Decimal", c.company as "bo_name", c.email as "CB account email", s.status as "CB Status" from chargebeerm.subscriptions s left join chargebeerm.subscriptions__addons sa on s.id = sa."_sdc_source_key_id" left join chargebeerm.customers c on s.customer_id = c.id where lower(sa."id") like '%engage%' and s.status`
    * `activated = 'TRUE' AND {{snippet: Eliminat`
    * ... and 356 more variations

---

### **Metric: Transaction Count**
* **Found:** 589 times
* **Common Calculations:**
    * `COUNT(*)`
    * `COUNT(DISTINCT TR._id)`
    * `COUNT(distinct TR._id) AS "Total Transactions", COUNT(distinct CASE WHEN PO."type" = 'paymentTerminal' THEN TR._id END) AS "GHL Transactions", ROUND(CAST(COUNT(distinct CASE WHEN PO."type" = 'paymentTerminal' THEN TR._id END) AS FLOAT) / COUNT(distinct TR._id)`
    * `Total Transactions`
    * `Transaction Count`
    * `Transaction count`
    * `Txn#`
    * `count(*)`
    * `count(1)`
    * `count(distinct case when CHARINDEX('base', b.planid) = 0 then b._id end) as "active non base plan account", count(distinct case when CHARINDEX('base', b.planid) > 0 then b._id end) as "active base plan account", count(distinct case when basetxn.txn_count is not null then b._id end) as "transacting base plan account", count(distinct case when b.isonlinestorepublished = TRUE then b._id end) as "active accounts with online store published", sum(case when b.isonlinestorepublished = TRUE then bs2.storecount end) as "total published online stores", sum(case when os.store_count is not null then os.store_count end) as "transacting online stores (ecomm)", "active non base plan account" + sum(case when CHARINDEX('base', b.planid) = 0 then b.paidextrastores end) as "total paid store license", sum(case when CHARINDEX('base', b.planid) = 0 then offline.store_count end) as "transacting offline stores", "total paid store license" + sum(case when CHARINDEX('base', b.planid) = 0 then b.paidextraregisters end) as "total paid registers", sum(case when CHARINDEX('base', b.planid) = 0 then offline.register_count end) as "transacting registers" from storehub_mongo.businesses b left join ( select tr.business, count(distinct tr._id)`
    * ... and 6 more variations

---

### **Metric: Online Sales**
* **Found:** 520 times
* **Common Calculations:**
    * `ECommerce`
    * `Ecommerce`
    * `Online Banking' then s.amount end) as "Online Banking", sum(case when s.payment_method = 'Card Payment (International)' then s.amount end) as "Card Payment (International)", sum(case when s.payment_method = 'Card Payment' then s.amount end) as "Card Payment", sum(case when s.payment_method = 'Voucher' then s.amount end) as "Voucher", sum(case when (s.payment_method = '' or s.payment_method is null) then s.total end) as "Other Sales`
    * `Online Banking' then s.amount end) as "Online Banking", sum(case when s.payment_method = 'Card Payment (International)' then s.amount end) as "Card Payment (International)", sum(case when s.payment_method = 'Card Payment' then s.amount end) as "Card Payment", sum(case when s.payment_method = 'Voucher' then s.amount end) as "Voucher", sum(case when (s.payment_method = '' or s.payment_method is null) then s.total end) as "Other Sales" from s left join storehub_mongo.employees e on e._id = s.employeenumber and s.employeenumber <> '' left join store`
    * `Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1 order by 1 offset 0 ) select b."Date" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %" , "Tax", tr."Shipping" as "Shipping Fee", "Service Charge" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" / "Total Transactions`
    * `Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1 order by 1 offset 0 ) select b."Date" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %" , "Tax", tr."Shipping" as "Shipping Fee", "Service Charge" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" / "Total Transactions" AS "Average Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / "Net Sales" * 100 AS "Gross Profit %" , "Total Sales Returned Count", "Total Sales`
    * `Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / "Net Sales" * 100 AS "Gross Profit %" , "Net Sales" / "Total Transactions" AS "Average Net Sales`
    * `Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / "Net Sales" * 100 AS "Gross Profit %" , "Net Sales" / "Total Transactions" AS "Average Net Sales" , "SubTotal", "Rounding" , tr."Shipping" from base b left join transaction tr on b."Date" = tr."Date" and b."Transaction Channel" = tr."Transaction Channel" and b."Store ID" = tr."Store`
    * `Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / "Net Sales" * 100 AS "Gross Profit %" , "Net Sales" / "Total Transactions" AS "Average Net Sales" , "SubTotal", "Rounding" , tr."Shipping" from base b left join transaction tr on b."Date" = tr."Date" and b."Transaction Channel" = tr."Transaction Channel" and b."Store ID" = tr."Store ID" where b."Store`
    * `Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / nullif("Net Sales" * 100,0) AS "Gross Profit %" , "Net Sales" / nullif("Total Transactions",0) AS "Average Net Sales`
    * ... and 362 more variations

---

### **Metric: Offline Sales**
* **Found:** 426 times
* **Common Calculations:**
    * `Channel" = tr."Transaction Channel" and b."Store ID" = tr."Store ID" where b."Store Name" = 'SABA RESTAURANT - JELATEK' order by 1,2`
    * `Channel" = tr."Transaction Channel" and b."Store ID" = tr."Store ID" where b."Store Name" = 'SABA RESTAURANT - PUBLIKA' order by 1,2`
    * `Offline Transactions`
    * `Offline Transactions (last 30 days)", sum(case when tr.channel is Null then tr.total end) as "Offline Transactions (last 30 days) GMV", "Offline Transactions (last 30 days) GMV" / "Offline Transactions`
    * `Offline Transactions", sum (case when storehub_mongo.transactionrecords.channel is Null then storehub_mongo.transactionrecords.total end) as "Offline Transactions GMV", "Offline Transactions GMV" / "Offline Transactions`
    * `Offline' and tr.shippingtype in ('dineIn', 'takeaway') and tr.channel = 3 then 1 else 0 end) as "Beep QR Count - Offline", cast(100 *cast("Beep QR Count - Offline" as varchar)/ cast(ISNULL(NULLIF("Total Beep QR Count",0),1) as varchar) as varchar(4)) + '%' as "Percetage of Beep Offline vs Total Beep QR (%)", sum(case when tr.channel is NULL then 1 else 0 end) as "Offline Sales", cast(100*cast("Total Beep QR Count" as varchar)/ cast(ISNULL(NULLIF("Offline Sales`
    * `Offline' then tr.receiptnumber end) as offline_order, sum(case when tr.paymentmethod = 'Offline' then tr.total end) as offline_gmv, r.past6m_avg as past6m_avg_monthly_qrtxn from s left join storehub_mongo.transactionrecords tr on s.business = tr.business left join r on r.business = s.business where {{snippet: Beep QR Transactions`
    * `Offline' when displaychannel = 1 then 'Ecommerce' when displaychannel = 98 then 'Beep QR' when displaychannel = 99 then 'Beep Delivery' when displaychannel = 10 then 'GrabFood' when displaychannel = 11 then 'ShopeeFood' when displaychannel = 12 then 'FoodPanda' when displaychannel = 100 then 'Lazada' when displaychannel = 101 then 'Shopee' when displaychannel = 102 then 'Zalora' when displaychannel = 103 then 'WooCommerce' when displaychannel = 104 then 'Shopify' when displaychannel = 105 then 'TikTok Shop' end AS "Transaction Channel" ,storeid AS "Store ID" ,storename AS "Store Name" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / nullif("Net Sales" * 100,0) AS "Gross Profit %" , "Net Sales" / nullif("Total Transactions`
    * `Offline' when displaychannel = 1 then 'Ecommerce' when displaychannel = 98 then 'Beep QR' when displaychannel = 99 then 'Beep Delivery' when displaychannel = 10 then 'GrabFood' when displaychannel = 11 then 'ShopeeFood' when displaychannel = 12 then 'FoodPanda' when displaychannel = 100 then 'Lazada' when displaychannel = 101 then 'Shopee' when displaychannel = 102 then 'Zalora' when displaychannel = 103 then 'WooCommerce' when displaychannel = 104 then 'Shopify' when displaychannel = 105 then 'TikTok Shop' end AS "Transaction Channel" ,storeid AS "Store ID" ,storename AS "Store Name" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or tr.channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / nullif("Net Sales" * 100,0) AS "Gross Profit %" , "Net Sales" / nullif("Total Transactions`
    * `Offline' when displaychannel = 1 then 'Ecommerce' when displaychannel = 98 then 'Beep QR' when displaychannel = 99 then 'Beep Delivery' when displaychannel = 10 then 'GrabFood' when displaychannel = 11 then 'ShopeeFood' when displaychannel = 12 then 'FoodPanda' when displaychannel = 100 then 'Lazada' when displaychannel = 101 then 'Shopee' when displaychannel = 102 then 'Zalora' when displaychannel = 103 then 'WooCommerce' when displaychannel = 104 then 'Shopify' when displaychannel = 105 then 'TikTok Shop' end AS "Transaction Channel" ,storeid AS "Store ID" ,storename AS "Store Name" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when channel is NULL then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / "Net Sales" * 100 AS "Gross Profit %" , "Net Sales" / "Total Transactions`
    * ... and 315 more variations

---

### **Metric: Active Customers**
* **Found:** 362 times
* **Common Calculations:**
    * `ACTIVE' then 1 else 0 end) as active_campaign, sum(case when c.status = 'DRAFT' then 1 else 0 end) as draft_campaign, sum(case when c.status = 'PAUSED' then 1 else 0 end) as paused_campaign, sum(case when c.status = 'SUSPENDED' then 1 else 0 end) as suspended_campaign from storehub_mongo.campaigns c left join storehub_mongo.businesses`
    * `ACTIVE' then 1 else 0 end) as active_campaign, sum(case when c.status = 'DRAFT' then 1 else 0 end) as draft_campaign, sum(case when c.status = 'PAUSED' then 1 else 0 end) as paused_campaign, sum(case when c.status = 'SUSPENDED' then 1 else 0 end) as suspended_campaign, cu2."crmcount", cu2."crmphone" from storehub_mongo.campaigns c left join storehub_mongo.businesses`
    * `ACTIVE' then 1 else 0 end) as automated_active, sum(case when c.globalcampaigninformationid <> '64d4d6b30f005152c96d10cb' and c.status = 'DRAFT' then 1 else 0 end) as automated_draft, sum(case when c.globalcampaigninformationid <> '64d4d6b30f005152c96d10cb' and c.status = 'PAUSED' then 1 else 0 end) as automated_paused, sum(case when c.globalcampaigninformationid <> '64d4d6b30f005152c96d10cb' and c.status = 'SUSPENDED' then 1 else 0 end) as automated_suspended, sum(case when c.globalcampaigninformationid = '64d4d6b30f005152c96d10cb' and c.status = 'ACTIVE' then 1 else 0 end) as custom_active, sum(case when c.globalcampaigninformationid = '64d4d6b30f005152c96d10cb' and c.status = 'FINISHED' then 1 else 0 end) as custom_finished, sum(case when c.globalcampaigninformationid = '64d4d6b30f005152c96d10cb' and c.status = 'PAUSED' then 1 else 0 end) as custom_paused, sum(case when c.globalcampaigninformationid = '64d4d6b30f005152c96d10cb' and c.status = 'SUSPENDED' then 1 else 0 end) as custom_suspended from storehub_mongo.campaigns c left join storehub_mongo.businesses`
    * `ACTIVE' then c.globalcampaigninformationid end) as active_campaign_count from storehub_mongo.campaigns c where c.status <> 'DRAFT' and c.globalcampaigninformationid in ('630eeb369ce7f44578cf2cab','630eeb369ce7f44578cf2cac','630eeb369ce7f44578cf2cad','634e466b83568a5b429f03f1','640996dffd94756d7291de0e','6476f9615c354a7a8e883644') group by 1 ), sc as ( select cj.business, min(dateadd(hour,8,cj.createdtime)) as first_sms_sent, max(dateadd(hour,8,cj.createdtime)) as last_sms_sent, count(distinct cj."_id") as total_customer_reach, sum(cj.messageunits) as total_sms_sent, sum(cj.messageunits) * 0.15 as total_sms_cost, count(distinct case when cj.createdtime >= dateadd(hour,-8,cast(getdate()-7 as date)) then cj."_id" end) as total_customer_reach_p7d, sum(case when cj.createdtime >= dateadd(hour,-8,cast(getdate()-7 as date)) then cj.messageunits end) as total_sms_sent_p7d from storehub_mongo.campaignjobs cj where cj.globalCampaignInformationId in ('630eeb369ce7f44578cf2cab','630eeb369ce7f44578cf2cac','630eeb369ce7f44578cf2cad','634e466b83568a5b429f03f1','640996dffd94756d7291de0e','6476f9615c354a7a8e883644') and cj.pushstatus = 'SUCCESS' and cj.createdtime >= '2022-09-23' group by 1 ) select distinct tmp.employeeid, tmp.campaign_published, tmp.total_sms_sent, tmp.total_customer_reach, tmp.total_sms_cost, tmp.first_sms_sent_time, tmp.last_sms_sent_time, tmp.active_campaign_count, tmp.total_sms_sent_p7d, tmp.total_customer_reach_p7d from ( select b.name as bo_account_name, e._id as employeeid, e.firstname, case when CHARINDEX('@storehub.com', e.email) > 0 then true else false end as storehub_employee, coalesce(cp1.campaign_count,0) as campaign_published, coalesce(sc.total_sms_sent,0) as total_sms_sent, coalesce(sc.total_customer_reach,0) as total_customer_reach, coalesce(sc.total_sms_cost,0) as total_sms_cost, sc.first_sms_sent as first_sms_sent_time, sc.last_sms_sent as last_sms_sent_time, case when cp1.active_campaign_count is null then 0 else cp1.active_campaign_count end as active_campaign_count, coalesce(sc.total_sms_sent_p7d,0) as total_sms_sent_p7d, coalesce(sc.total_customer_reach_p7d,0) as total_customer_reach_p7d from storehub_mongo.businesses`
    * `ACTIVE' then c.globalcampaigninformationid end) as active_campaign_count from storehub_mongo.campaigns c where c.status <> 'DRAFT' and c.globalcampaigninformationid in ('630eeb369ce7f44578cf2cab','630eeb369ce7f44578cf2cac','630eeb369ce7f44578cf2cad','634e466b83568a5b429f03f1','640996dffd94756d7291de0e','6476f9615c354a7a8e883644') group by 1 ), sc as ( select cj.business, min(dateadd(hour,8,cj.createdtime)) as first_sms_sent, max(dateadd(hour,8,cj.createdtime)) as last_sms_sent, count(distinct cj."_id") as total_customer_reach, sum(cj.messageunits) as total_sms_sent, sum(cj.messageunits) * 0.15 as total_sms_cost, count(distinct case when cj.createdtime >= dateadd(hour,-8,cast(getdate()-7 as date)) then cj."_id" end) as total_customer_reach_p7d, sum(case when cj.createdtime >= dateadd(hour,-8,cast(getdate()-7 as date)) then cj.messageunits end) as total_sms_sent_p7d from storehub_mongo.campaignjobs cj where cj.globalCampaignInformationId in ('630eeb369ce7f44578cf2cab','630eeb369ce7f44578cf2cac','630eeb369ce7f44578cf2cad','634e466b83568a5b429f03f1','640996dffd94756d7291de0e','6476f9615c354a7a8e883644') and cj.pushstatus = 'SUCCESS' and cj.createdtime >= '2022-09-23' group by 1 ), cbe as ( select b.name, s.status as cb_status, sa."id" as engage_sub from storehub_mongo.businesses b left join chargebeerm.subscriptions s on b.subscriptionid = s."id" left join chargebeerm.subscriptions__addons sa on b.subscriptionid = sa."_sdc_source_key_id" where b.country = 'MY' and {{snippet: Eliminate Internal Accounts}} and lower(sa."id") like '%engage%' union select b.name, s.status as cb_status, sa."id" as engage_sub from storehub_mongo.businesses b left join chargebeeusd.subscriptions s on b.subscriptionid = s."id" left join chargebeeusd.subscriptions__addons sa on b.subscriptionid = sa."_sdc_source_key_id" where b.country in ('PH','TH') and {{snippet: Eliminate Internal Accounts}} and lower(sa."id") like '%engage%' ), t as ( select b.name, cast(b.campaigntrialendtime/1000 || 'second' AS interval) + cast('1970-01-01' as datetime) as engage_trial_end_date, CASE WHEN engage_trial_end_date > getdate() THEN 'ongoing' WHEN b.campaigntrialendtime < EXTRACT(EPOCH FROM '1970-01-02'::DATE) THEN 'subscribed before trial ends' WHEN engage_trial_end_date < getdate() THEN 'ended' END AS engage_trial_status from storehub_mongo.businesses b where {{snippet: Eliminate Internal Accounts}} and b.subscriptionstatus in ('Active') and b.campaigntrialendtime is not null ) select distinct tmp.employeeid, tmp.campaign_published, tmp.total_sms_sent, tmp.total_customer_reach, tmp.total_sms_cost, tmp.first_sms_sent_time, tmp.last_sms_sent_time, tmp.active_campaign_count, tmp.Cashback_CampaignStatus, tmp.WinBackLostCustomers_CampaignStatus, tmp.BirthdayPromotion_CampaignStatus, tmp.WelcomeNewCustomers_CampaignStatus, tmp.BoostGoogleReview_CampaignStatus, tmp.ExpiringCashbackAlert_CampaignStatus, tmp.total_sms_sent_p7d, tmp.total_customer_reach_p7d, tmp.engage_sub_plan, tmp.engage_status, tmp.cashbackexpiry_enabled, tmp.engage_trial_end_date, tmp.engage_trial_start_date from ( select b.name as bo_account_name, e._id as employeeid, e.firstname, case when CHARINDEX('@storehub.com', e.email) > 0 then true else false end as storehub_employee, coalesce(cp1.campaign_count,0) as campaign_published, coalesce(sc.total_sms_sent,0) as total_sms_sent, coalesce(sc.total_customer_reach,0) as total_customer_reach, coalesce(sc.total_sms_cost,0) as total_sms_cost, sc.first_sms_sent as first_sms_sent_time, sc.last_sms_sent as last_sms_sent_time, case when cp1.active_campaign_count is null then 0 else cp1.active_campaign_count end as active_campaign_count, cp2.Cashback_CampaignStatus, cp2.WinBackLostCustomers_CampaignStatus, cp2.BirthdayPromotion_CampaignStatus, cp2.WelcomeNewCustomers_CampaignStatus, cp2.BGR_CampaignStatus as BoostGoogleReview_CampaignStatus, cp2.ExpiringCashbackAlert_CampaignStatus, coalesce(sc.total_sms_sent_p7d,0) as total_sms_sent_p7d, coalesce(sc.total_customer_reach_p7d,0) as total_customer_reach_p7d, case when cbe.engage_sub is null then false else true end as engage_sub, cbe.engage_sub as engage_sub_plan, CASE when cbe.engage_sub is not null then 'subscription active' when cbe.engage_sub is null and t.engage_trial_status is null then 'never tried' when cbe.engage_sub is null and t.engage_trial_status = 'ended' then 'trial ended' when cbe.engage_sub is null and t.engage_trial_status = 'ongoing' then 'in trial' when cbe.engage_sub is null and t.engage_trial_status = 'subscribed before trial ends' then 'churned' end as engage_status, case when b."cashbackexpirationduration.durationnumber" > 0 then true else false end as cashbackexpiry_enabled, t.engage_trial_end_date, b.campaigntrialstartdate as engage_trial_start_date from storehub_mongo.businesses`
    * `ACTIVE' then cp.globalCampaignInformationId end) as "active campaign count", sum(cp.total_customer_reach_p30d) as "total customer reach past30d", sum(cp.total_sms_sent_p30d) as "total sms sent past30d", max(cp.total_cust) as "total crm count", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cab' then cp.total_roi_past30d end) as "cashback roi past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cac' then cp.total_roi_past30d end) as "win back roi past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cad' then cp.total_roi_past30d end) as "bday roi past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cab' then cp.total_repurchase_rate_past30d end) as "cashback avg repurchase rate past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cac' then cp.total_repurchase_rate_past30d end) as "win back avg repurchase rate past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cad' then cp.total_repurchase_rate_past30d end) as "bday avg repurchase rate past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cab' then cp.percent_cust_targeted_p30d end) as "cashback % customer targeted past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cac' then cp.percent_cust_targeted_p30d end) as "win back % customer targeted past30d", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cad' then cp.percent_cust_targeted_p30d end) as "bday % customer targeted past30d", case when "total customer reach past30d" > 0 and "total crm count" > 0 then cast("total customer reach past30d" as float) / cast("total crm count" as float) when "total customer reach past30d" > 0 and ("total crm count" = 0 or "total crm count" is null) then 1 end as "overall % customer targeted past30d", sum(cp.total_customer_reach) as "all time customer reach", sum(cp.total_sms_sent) as "all time sms sent", min(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cab' then cp.first_sms_sent_time end) as "cashback first sms", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cab' then cp.last_sms_sent_time end) as "cashback last sms", min(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cac' then cp.first_sms_sent_time end) as "win back first sms", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cac' then cp.last_sms_sent_time end) as "win back last sms", min(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cad' then cp.first_sms_sent_time end) as "bday first sms", max(case when cp.globalCampaignInformationId = '630eeb369ce7f44578cf2cad' then cp.last_sms_sent_time end) as "bday last sms", min(case when cp.globalCampaignInformationId = '634e466b83568a5b429f03f1' then cp.first_sms_sent_time end) as "bgr first sms", max(case when cp.globalCampaignInformationId = '634e466b83568a5b429f03f1' then cp.last_sms_sent_time end) as "bgr last sms", min(cp.sms_sent_day) as "minimum sms sent day" from ( select c.business, c.globalCampaignInformationId, c.name as campaign_name, c.status as campaign_status, sc.first_sms_sent as first_sms_sent_time, sc.last_sms_sent as last_sms_sent_time, sc.total_customer_reach, sc.total_sms_sent, case when c.globalCampaignInformationId <> '634e466b83568a5b429f03f1' then re.repurchaseTotal / sc.total_sms_cost_p51d else 0 end as total_roi_past30d, sc.total_customer_reach_p30d, sc.total_sms_sent_p30d, sc.total_sms_cost_p30d, case when c.globalCampaignInformationId <> '634e466b83568a5b429f03f1' then cast(re.total_return_customer as float) / cast(sc.total_customer_reach_p51d as float) else 0 end as total_repurchase_rate_past30d, sc.percent_cust_targeted_p30d, sc.total_cust, sc.sms_sent_day from storehub_mongo.campaigns c left join sc on c.business = sc.business and c.globalCampaignInformationId = sc.globalCampaignInformationId left join re on c.business = re.business and c.globalCampaignInformationId = re.globalCampaignInformationId where c.globalCampaignInformationId in ('634e466b83568a5b429f03f1','630eeb369ce7f44578cf2cab','630eeb369ce7f44578cf2cac','630eeb369ce7f44578cf2cad') order by 1 ASC, 2 ASC ) cp left join storehub_mongo.businesses`
    * `Active Stores" from ( select "30d", max("createdtime") as "day", count("business") as "Active Stores" from ( select "business", FLOOR(datediff(day, "createdtime", CAST(getdate() AS date)) / 30) AS "30d", max("createdtime") as "createdtime", sum("Transaction number") as "txn" from ( select cast(dateadd(hour,8,t.createdtime) as date) as "createdtime", t.business as "business", COUNT(t._id) as "Transaction number" from storehub_mongo.transactionrecords t where t.channel = 3 and t.shippingtype in ('delivery', 'pickup') and t.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and t.business in (select b.name from storehub_mongo.businesses`
    * `Active Stores" from ( select "30d", max("createdtime") as "day", count("business") as "Active Stores" from ( select "business", FLOOR(datediff(day, "createdtime", CAST(getdate() AS date)) / 30) AS "30d", max("createdtime") as "createdtime", sum("Transaction number") as "txn" from ( select cast(dateadd(hour,8,t.createdtime) as date) as "createdtime", t.business as "business", COUNT(t._id) as "Transaction number" from storehub_mongo.transactionrecords t where t.channel = 3 and t.shippingtype in ('dineIn', 'takeaway') and t.status not in ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and t.business in (select distinct b.name from storehub_mongo.businesses`
    * `Active Users" from ( select t.consumerid as beep_consumer, count(distinct t.receiptnumber) as beep_txn from storehub_mongo.transactionrecords t where t.business in ( select distinct b.name from storehub_mongo.businesses`
    * `Active' ) b on b._id = bpo.businesses_foreignkey left join storehub_mongo.businesses__stores__location bsl on bpo.stores = bsl.businesses`
    * ... and 175 more variations

---

### **Metric: Beep Transactions**
* **Found:** 326 times
* **Common Calculations:**
    * `BEEP' else null end as "Channel", cast(dateadd(hour,8,tr.createdtime) as date) as "Transaction date", gr.paymentgateway, trp.paymentmethod, count(distinct payoutitems.receiptnumber) AS "# of txn`
    * `BEEP' else null end as "Channel", gr.paymentgateway, trp.paymentmethod, count(distinct payoutitems.receiptnumber) AS "# of txn`
    * `Beep Delivery GMV`
    * `Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' else 'offline' end as "Channel", count(distinct tr.receiptnumber) as totaldailytransactioncount, sum(tr.total) as totaldailytransactionamount, sum(lc.amount) as totaldailyredeemedcashbackamount, count(distinct lc.receiptnumber) as totaldailyredeemedcashbackcount from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__stores bs on bs._id = tr.storeid left join ( select lc.business, lc.amount, lc.receiptnumber, lc.eventtype from storehub_mongo.loyaltychangelogs lc where lc.eventtype = 'expense' and lc.rewardtype = 'cashback' ) lc on lc.receiptnumber = tr.receiptnumber and lc.business = tr.business where tr.business != 'merchandise' and (tr.channel in (1,3) or tr.channel is null) and tr.iscancelled is not true and tr.transactiontype = 'Sale' and {{snippet: Eliminate Internal Accounts}} AND tr.status not in ('cancelled','created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') [[AND b.country = {{country}}]] [[AND b.name = ANY (string_to_array({{account_name}}, ','))]] [[and (tr.createdtime >= dateadd(hour,-8,{{Start_Date}}) and tr.createdtime < dateadd(hour,16+24,{{End_Date}}))]] [[and txn`
    * `Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' when tr.channel = 3 and tr.shippingtype = 'digital' then 'Voucher' else null end as "Channel", date_trunc('week', CAST(tr."createdtime" AS timestamp)) AS "createdtime", avg(case when tr.shippingfee is not null then (tr.total - tr.shippingfee) when tr.shippingfee is null then tr.total else null end) as "Average GMV`
    * `Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' when tr.channel = 3 and tr.shippingtype = 'digital' then 'Voucher' else null end as "Channel", sum(case when pi.cause = 'sell' then tr.total else 0 end) as "Total Transaction Amount", sum(pi.amount) as "Total Payout", sum(case when trav.purchasechannel = 'beep' then 0 when trav._id is not null and pi.cause = 'sell' then trav.value else 0 end) as "Total voucher payout", sum(isnull(gr.fee,0)) - sum(isnull(pso.paymentgatewaycost,0)) as "Total Payment Gateway Cost", sum(isnull(pi.paymentgatewayfee,0)) as "Total Payment Gateway Fee", -("Total Payment Gateway Fee" - "Total Payment Gateway Cost") as "Payment Gateway Revenue", sum(trdi.shippingfee) as "Total Customer paid delivery fee", -sum(trdi.deliveryfee) as "Total Logistic Cost", sum(pi.logisticsfee) as "Total Logistic Fee", -("Total Logistic Fee" - "Total Logistic Cost") as "Total Logistic Revenue", -sum(pi.transactionfee) as "Total Storehub Fee", count(distinct pi.receiptnumber) as "# of txn`
    * `Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' when tr.channel = 3 and tr.shippingtype = 'digital' then 'Voucher' else null end as "Channel", tr.status, tr.isdisbursed as "Payout status", trav.value as "Voucher Discount", tr.discount, case when lcl.eventtype = 'earned' then lcl.amount else null end as "Cashback earned", case when lcl.eventtype = 'expense' then lcl.amount else null end as "Cashback spent", tr.total from ( select tr._id, tr.receiptnumber, tr.business, dateadd(hour,8,tr.createdtime) as createdtime, dateadd(hour,8,tr.fulfilldate) as fulfilldate, tr.channel, tr.shippingtype, tr.iscancelled, tr.isdisbursed, tr.status, tr.discount, tr.total from storehub_mongo.transactionrecords tr where tr.receiptnumber = {{receiptnumber}} [[and tr.channel = {{channel}}]] [[and tr.business = {{accountname}}]] [[and cast(dateadd(hour,8,tr.createdtime) as date) = {{txn`
    * `Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' when tr.channel = 3 and tr.shippingtype = 'digital' then 'Voucher' else null end as "Channel", tr.status, tr.isdisbursed as "Payout status", trav.value as "Voucher Discount", tr.total from ( select tr._id, tr.receiptnumber, tr.business, dateadd(hour,8,tr.createdtime) as createdtime, dateadd(hour,8,tr.fulfilldate) as fulfilldate, tr.channel, tr.shippingtype, tr.iscancelled, tr.isdisbursed, tr.status, tr.total from storehub_mongo.transactionrecords tr where tr.receiptnumber = {{receiptnumber}} [[and tr.channel = {{channel}}]] [[and tr.business = {{accountname}}]] [[and cast(dateadd(hour,8,tr.createdtime) as date) = {{txn`
    * `Beep Delivery' when tr.channel = 3 and tr.shippingtype in ('dineIn','takeaway') then 'Beep QR' when tr.channel = 1 then 'Ecommerce' when tr.channel = 10 then 'GrabFood' when tr.channel = 11 then 'ShopeeFood' when tr.channel = 12 then 'FoodPanda' end as transaction_channel, tr.shippingtype, tr.transactiontype, tr.subtotal, tr.discount, tr.servicecharge, tr.total, tr.tax, tr.roundedamount, tr.shippingfee, tr.employeenumber, tr.customerid, tr.consumerid, tr._id order_id, tr.paymentmethod, case when bpo.name <> '' then bpo.name else trp.paymentmethod end as payment_method, trp.amount, tr.transactionid from storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__paymentoptions bpo on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod) left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id where (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel in (1,10,11, 12)) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and b.country = 'MY' [[and tr.business = {{bo_account_name}}]] [[and (tr.createdtime >= dateadd(hour,0,{{Start_Date}}) and tr.createdtime < dateadd(hour,24,{{End_Date}}))]] ) select s.bo_account_name, s.storename, s.txn`
    * `Beep Delivery' when tr.channel = 3 and tr.shippingtype in ('dineIn','takeaway') then 'Beep QR' when tr.channel = 1 then 'Ecommerce' when tr.channel = 10 then 'GrabFood' when tr.channel = 11 then 'ShopeeFood' when tr.channel = 12 then 'FoodPanda' end as transaction_channel, tr.shippingtype, tr.transactiontype, tr.subtotal, tr.discount, tr.servicecharge, tr.total, tr.tax, tr.roundedamount, tr.shippingfee, tr.employeenumber, tr.customerid, tr.consumerid, tr._id order_id, tr.paymentmethod, case when bpo.name <> '' then bpo.name else trp.paymentmethod end as payment_method, trp.amount, tr.transactionid from storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__paymentoptions bpo on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod) left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id where (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel in (1,10,11, 12)) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and b.country = 'TH' and (tr.createdtime >= dateadd(hour,-8,date'2024-03-03') and tr.createdtime < dateadd(hour,-8,date'2024-03-04')) [[and tr.business = {{bo_account_name}}]] ) select s.bo_account_name, s.storename, s.txn`
    * ... and 238 more variations

---

### **Metric: Delivery Transactions**
* **Found:** 322 times
* **Common Calculations:**
    * `BD merchant count", count(distinct case when tr.shippingtype in ('delivery', 'pickup') then tr.storeid end) as "BD store count", count(distinct case when tr.shippingtype in ('takeaway', 'dineIn') then tr.business end) as "BQR merchant count", count(distinct case when tr.shippingtype in ('takeaway', 'dineIn') then tr.storeid end) as "BQR store count", sum(case when b.country = 'MY' and tr.shippingtype in ('delivery', 'pickup') then tr.total * {{MYR_rate}} when b.country = 'PH' and tr.shippingtype in ('delivery', 'pickup') then tr.total * {{PHP_rate}} when b.country = 'TH' and tr.shippingtype in ('delivery', 'pickup') then tr.total * {{THB_rate}} when b.country = 'SG' and tr.shippingtype in ('delivery', 'pickup') then tr.total end) as "total BD gmv (SGD)", count(distinct case when tr.shippingtype in ('delivery', 'pickup') then tr.receiptnumber end) as "total bd txn", sum(case when b.country = 'MY' and tr.shippingtype in ('takeaway', 'dineIn') then tr.total * {{MYR_rate}} when b.country = 'PH' and tr.shippingtype in ('takeaway', 'dineIn') then tr.total * {{PHP_rate}} when b.country = 'TH' and tr.shippingtype in ('takeaway', 'dineIn') then tr.total * {{THB_rate}} when b.country = 'SG' and tr.shippingtype in ('takeaway', 'dineIn') then tr.total end) as "total BQR gmv (SGD)", count(distinct case when tr.shippingtype in ('takeaway', 'dineIn') then tr.receiptnumber end) as "total bqr txn`
    * `BD total txn#", sum(case when tr.shippingtype = 'delivery' then tr.total end) as "BD total gmv", -sum(case when tr.shippingtype = 'delivery' then (pi.transactionfee) end) as "SH delivery revenue", sum(case when tr.shippingtype = 'pickup' then 1 else 0 end) as "Pickup total txn`
    * `BD txn #", sum(tr.total - tr.shippingfee) as "All BD GMV (Total excl. shipping fee)", count(distinct case when tr.shippingtype = 'delivery' then tr.receiptnumber end) as "Delivery txn #", sum(case when tr.shippingtype = 'delivery' then tr.total - tr.shippingfee end) as "Delivery GMV (excl. shipping fee)", count(distinct case when tr.shippingtype = 'pickup' then tr.receiptnumber end) as "Pickup txn`
    * `BD_txn_count > 0 and s.App_BQR_txn_count = 0 then s.consumerid end) as AppOnly_BD_only, count(case when s.user_type = 'AppOnly' and s.App_BD_txn_count = 0 and s.App_BQR_txn_count > 0 then s.consumerid end) as AppOnly_BQR_only, count(case when s.user_type = 'AppOnly' and s.App_BD_txn_count > 0 and s.App_BQR_txn_count > 0 then s.consumerid end) as AppOnly_BD_BQR, count(case when s.user_type = 'Both' and s.App_BD_txn_count > 0 and s.NonApp_BD_txn_count > 0 and s.App_BQR_txn_count = 0 and s.NonApp_BQR_txn_count = 0 then s.consumerid end) as Both_BD_only, count(case when s.user_type = 'Both' and s.App_BQR_txn_count > 0 and s.NonApp_BQR_txn_count > 0 and s.App_BD_txn_count = 0 and s.NonApp_BD_txn_count = 0 then s.consumerid end) as Both_BQR_only, Both_ALL - Both_BD_only - Both_BQR_only as Both_BD_BQR, count(case when s.user_type = 'NonAppOnly' and s.NonApp_BD_txn_count > 0 and s.NonApp_BQR_txn_count = 0 then s.consumerid end) as NonAppOnly_BD_only, count(case when s.user_type = 'NonAppOnly' and s.NonApp_BD_txn_count = 0 and s.NonApp_BQR_txn_count > 0 then s.consumerid end) as NonAppOnly_BQR_only, count(case when s.user_type = 'NonAppOnly' and s.NonApp_BD_txn_count > 0 and s.NonApp_BQR_txn`
    * `Beep (#)", sum(case when tr.channel = 3 then tr.total else 0 end) as "All Beep ($)", sum(case when tr.channel = 3 and tr.shippingtype = 'delivery' then 1 else 0 end) as "Beep Delivery (#)", sum(case when tr.channel = 3 and tr.shippingtype = 'delivery' then tr.total else 0 end) as "Beep Delivery`
    * `Beep (#)", sum(case when tr.channel = 3 then tr.total else 0 end) as "Beep ($)", sum(case when tr.channel = 3 and tr.shippingtype = 'delivery' then 1 else 0 end) as "Beep Delivery (#)", sum(case when tr.channel = 3 and tr.shippingtype = 'delivery' then tr.total else 0 end) as "Beep Delivery`
    * `Beep Delivery`
    * `Beep Delivery GMV (SGD)" from storehub_mongo.transactionrecords left join storehub_mongo.businesses b on b.name = storehub_mongo.transactionrecords.business where (storehub_mongo.transactionrecords.channel = 3 and storehub_mongo.transactionrecords.shippingtype in('pickup', 'delivery`
    * `Beep Delivery GMV" from storehub_mongo.transactionrecords left join storehub_mongo.businesses on storehub_mongo.businesses.name = storehub_mongo.transactionrecords.business where (storehub_mongo.transactionrecords.channel = 3 and storehub_mongo.transactionrecords.shippingtype in ('delivery`
    * `Beep Delivery Revenue (SGD)" from storehub_mongo.transactionrecords tr left join storehub_mongo.payoutitems pi on tr.receiptnumber = pi.receiptnumber left join storehub_mongo.businesses b on b.name = tr.business where tr.channel = 3 and tr.shippingtype in ('pickup', 'delivery`
    * ... and 271 more variations

---

### **Metric: Net Sales**
* **Found:** 194 times
* **Common Calculations:**
    * `Net Sales`
    * `SUM( CASE WHEN (tr.channel is null or tr.channel = 2) THEN tr.total ELSE 0 END ) AS total_offline_gmv, COUNT( DISTINCT CASE WHEN (tr.channel is null or tr.channel = 2) THEN tr.receiptnumber END ) AS total_offline_txn, SUM(CASE WHEN tr.shippingtype in ('delivery', 'pickup') AND tr.channel = 3 THEN tr.total ELSE 0 END) AS beep_delivery_gmv, COUNT(DISTINCT CASE WHEN tr.shippingtype in ('delivery', 'pickup') AND tr.channel = 3 THEN tr.receiptnumber END) AS beep_delivery_txn, SUM(CASE WHEN tr.shippingtype in ('dineIn', 'takeaway') AND tr.channel = 3 THEN tr.total ELSE 0 END) AS beep_qr_gmv, COUNT(DISTINCT CASE WHEN tr.shippingtype in ('dineIn', 'takeaway') AND tr.channel = 3 THEN tr.receiptnumber END) AS beep_qr_txn FROM storehub_mongo.businesses b LEFT JOIN storehub_mongo.transactionrecords tr ON b.name = tr.business WHERE {{snippet: Eliminate Internal Accounts}} AND b."membershipsetting.activatedat" IS NOT NULL AND tr.iscancelled IS NOT TRUE AND tr.transactiontype = 'Sale' AND ( tr.channel IS NULL OR tr.channel IN (2, 3) ) AND tr.total < 10000000 AND tr.status NOT IN ( 'cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification' ) AND tr.createdtime >= dateadd(hour, -8, cast(getdate() -30 AS date))`
    * `SUM( CASE WHEN TR.business = 'smsupermalls' THEN tr.total * 0.014 ELSE 0 END ) AS "smsupermalls (1.4%)", SUM( CASE WHEN TR.business != 'smsupermalls' THEN tr.total * 0.015 ELSE 0 END ) AS "Other Merchants (1.5%)" FROM "storehub_mongo"."transactionrecords" TR LEFT JOIN "storehub_mongo"."transactionrecords__payments" TRP ON TR._id = TRP.transactionrecords_foreignkey LEFT JOIN storehub_mongo.businesses b ON b.name = TR.business LEFT JOIN "storehub_mongo"."businesses__paymentoptions" PO ON PO.businesses_foreignkey = b._id AND PO.paymentid = TRP.paymentmethod WHERE {{snippet: Eliminate Internal Accounts}} AND b.country = 'PH' AND TR.createdtime >= dateadd(hour,-8,date_trunc('week', cast(getdate() + INTERVAL '-11 week' as date))) AND TR.iscancelled IS NOT TRUE AND TR.transactiontype = 'Sale' AND TR.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') AND TR.total < 10000000 AND po.additionalinfo like '%"qrCodeType":"dynamic","qrCodeProvider":"Modulus Labs - QR Ph"%' GROUP BY date_trunc('week', cast(dateadd(hour,8,tr.createdtime) as date))`
    * `SUM( CASE WHEN TR.business = 'smsupermalls' THEN tr.total * 0.014 ELSE 0 END ) AS "smsupermalls (1.4%)", SUM( CASE WHEN TR.business != 'smsupermalls' THEN tr.total * 0.015 ELSE 0 END ) AS "Other Merchants (1.5%)" FROM "storehub_mongo"."transactionrecords" TR LEFT JOIN "storehub_mongo"."transactionrecords__payments" TRP ON TR._id = TRP.transactionrecords_foreignkey LEFT JOIN storehub_mongo.businesses b ON b.name = TR.business LEFT JOIN "storehub_mongo"."businesses__paymentoptions" PO ON PO.businesses_foreignkey = b._id AND PO.paymentid = TRP.paymentmethod WHERE {{snippet: Eliminate Internal Accounts}} AND b.country = 'PH' AND TR.createdtime >= dateadd(hour,-8,date_trunc('week', cast(getdate() + INTERVAL '-3 week' as date))) AND TR.iscancelled IS NOT TRUE AND TR.transactiontype = 'Sale' AND TR.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') AND TR.total < 10000000 AND po.additionalinfo like '%"qrCodeType":"dynamic","qrCodeProvider":"Modulus Labs - QR Ph"%' GROUP BY date_trunc('week', cast(dateadd(hour,8,tr.createdtime) as date))`
    * `SUM(CASE WHEN PO."type" = 'paymentTerminal' THEN TRP.amount ELSE 0 END) * 0.002 AS "Total Max Revenue (0.2%)" FROM "storehub_mongo"."transactionrecords" TR LEFT JOIN "storehub_mongo"."transactionrecords__payments" TRP ON TR._id = TRP.transactionrecords_foreignkey LEFT JOIN storehub_mongo.businesses b ON b.name = TR.business LEFT JOIN "storehub_mongo"."businesses__paymentoptions" PO ON PO.businesses_foreignkey = b._id AND PO.paymentid = TRP.paymentmethod WHERE {{snippet: Eliminate Internal Accounts}} AND TR.createdtime >= dateadd(hour, -8, cast(getdate() - 21 AS date)) AND TR.iscancelled IS NOT TRUE AND TR.transactiontype = 'Sale' AND TR.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') AND TR.total < 10000000 AND PO."type" = 'paymentTerminal' GROUP BY DATE_TRUNC('week', TR.createdtime)`
    * `SUM(CASE WHEN PO."type" = 'paymentTerminal' THEN TRP.amount ELSE 0 END) AS "Total Amount transacted with GHL", SUM(CASE WHEN PO."type" = 'paymentTerminal' THEN TRP.amount ELSE 0 END) * 0.002 AS "Max Revenue (0.2%)" FROM "storehub_mongo"."transactionrecords" TR LEFT JOIN "storehub_mongo"."transactionrecords__payments" TRP ON TR._id = TRP.transactionrecords_foreignkey LEFT JOIN storehub_mongo.businesses b ON b.name = TR.business LEFT JOIN "storehub_mongo"."businesses__paymentoptions" PO ON PO.businesses_foreignkey = b._id AND PO.paymentid = TRP.paymentmethod WHERE TR.createdtime >= dateadd(hour, -8, cast(getdate() - 7 AS date)) AND TR.iscancelled IS NOT TRUE AND TR.transactiontype = 'Sale' AND TR.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') AND TR.total < 10000000 [[AND b."name" = {{accountname}}]] GROUP BY TR.business HAVING COUNT(DISTINCT CASE WHEN PO."type" = 'paymentTerminal' THEN TR._id END)`
    * `SUM(CASE WHEN PO."type" = 'paymentTerminal' THEN TRP.amount ELSE 0 END) AS "Total GMV" FROM "storehub_mongo"."transactionrecords" TR LEFT JOIN "storehub_mongo"."transactionrecords__payments" TRP ON TR._id = TRP.transactionrecords_foreignkey LEFT JOIN storehub_mongo.businesses b ON b.name = TR.business LEFT JOIN "storehub_mongo"."businesses__paymentoptions" PO ON PO.businesses_foreignkey = b._id AND PO.paymentid = TRP.paymentmethod WHERE {{snippet: Eliminate Internal Accounts}} AND TR.createdtime >= dateadd(hour, -8, cast(getdate() - 21 AS date)) AND TR.iscancelled IS NOT TRUE AND TR.transactiontype = 'Sale' AND TR.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') AND TR.total < 10000000 AND PO."type" = 'paymentTerminal' GROUP BY DATE_TRUNC('week', TR.createdtime)`
    * `SUM(CASE WHEN base.transactiontype = 'Sale' THEN COALESCE(+ base."Payment Amount",0) ELSE COALESCE(0,0) END) AS "Total Sales", SUM(CASE WHEN base.transactiontype = 'Sale' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Transactions", SUM(CASE WHEN base.transactiontype = 'Return'THEN COALESCE(+ base."Payment Amount",0) ELSE COALESCE(0,0) END) AS "Total Sales Returned", SUM(CASE WHEN base.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0, 0) END) AS "Total Items Returned", SUM(CASE WHEN base.transactiontype = 'PreOrder' THEN COALESCE(+ base."Payment Amount",0) ELSE COALESCE(0,0) END) AS "PreOrder Deposits", SUM(CASE WHEN base.transactiontype = 'PreOrder' THEN COALESCE(1,0) ELSE COALESCE(0,0) END)`
    * `SUM(CASE WHEN base.transactiontype = 'Sale' THEN COALESCE(+ base."Payment Amount",0) ELSE COALESCE(0,0) END) AS "Total Sales", SUM(CASE WHEN base.transactiontype = 'Sale' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Transactions", SUM(CASE WHEN base.transactiontype = 'Return'THEN COALESCE(+ base."Payment Amount",0) ELSE COALESCE(0,0) END) AS "Total Sales Returned", SUM(CASE WHEN base.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0, 0) END) AS "Total Items Returned", SUM(CASE WHEN base.transactiontype = 'PreOrder' THEN COALESCE(+ base."Payment Amount",0) ELSE COALESCE(0,0) END) AS "PreOrder Deposits", SUM(CASE WHEN base.transactiontype = 'PreOrder' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "PreOrder Transactions" from base group by 1 )`
    * `SUM(CASE WHEN po.additionalinfo like '%"qrCodeType":"dynamic","qrCodeProvider":"Modulus Labs - QR Ph"%' THEN tr.total ELSE 0 END) AS "Total Amount transacted with QR Ph", SUM(CASE WHEN po.additionalinfo like '%"qrCodeType":"dynamic","qrCodeProvider":"Modulus Labs - QR Ph"%' THEN tr.total ELSE 0 END) * 0.015 AS "Max Revenue (1.5%)" FROM "storehub_mongo"."transactionrecords" TR LEFT JOIN "storehub_mongo"."transactionrecords__payments" TRP ON TR._id = TRP.transactionrecords_foreignkey LEFT JOIN storehub_mongo.businesses b ON b.name = TR.business LEFT JOIN "storehub_mongo"."businesses__paymentoptions" PO ON PO.businesses_foreignkey = b._id AND PO.paymentid = TRP.paymentmethod LEFT JOIN storehub_mongo.businesses__stores BS ON TR.storeid = BS._id WHERE b.country = 'PH' AND TR.createdtime >= dateadd(hour, -8, cast(getdate() - 7 AS date)) AND TR.iscancelled IS NOT TRUE AND TR.transactiontype = 'Sale' AND TR.status NOT IN ('cancelled', 'created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') AND TR.total < 10000000 [[AND b."name" = {{accountname}}]] AND {{snippet: Eliminate Internal Accounts}} GROUP BY TR.business, BS.name HAVING COUNT(DISTINCT CASE WHEN po.additionalinfo like '%"qrCodeType":"dynamic","qrCodeProvider":"Modulus Labs - QR Ph"%' THEN TR._id END)`
    * ... and 55 more variations

---

### **Metric: Tax Amount**
* **Found:** 152 times
* **Common Calculations:**
    * `Tax`
    * `tax`
    * `tax amount`

---

### **Metric: Product Sales**
* **Found:** 119 times
* **Common Calculations:**
    * `COUNT(*) AS "count" FROM "storehub_mongo"."products" LEFT JOIN "storehub_mongo"."businesses" AS "businesses__via__business" ON "storehub_mongo"."products"."business" = "businesses__via__business"."name" WHERE ("businesses__via__business"."name" = {{accountname}}) AND ("storehub_mongo"."products"."isdeleted" = FALSE)`
    * `COUNT(CASE WHEN "storehub_mongo"."products"."minrefunitprice" >= 1 OR "storehub_mongo"."products"."maxrefunitprice" >= 1 THEN 1 END) AS "total_count", COUNT(CASE WHEN "storehub_mongo"."products"."minrefunitprice" >= 1 AND ("storehub_mongo"."products"."maxrefunitprice" IS NULL OR "storehub_mongo"."products"."maxrefunitprice" < 1) THEN 1 END) AS "Min Price only", COUNT(CASE WHEN "storehub_mongo"."products"."maxrefunitprice" >= 1 AND ("storehub_mongo"."products"."minrefunitprice" IS NULL OR "storehub_mongo"."products"."minrefunitprice" < 1) THEN 1 END) AS "Max Price only", COUNT(CASE WHEN "storehub_mongo"."products"."minrefunitprice" >= 1 AND "storehub_mongo"."products"."maxrefunitprice" >= 1 THEN 1 END) AS "Min and Max Price" FROM "storehub_mongo"."products" LEFT JOIN "transformations"."mask_businesses" AS "Mask Businesses - Business" ON "storehub_mongo"."products"."business" = "Mask Businesses - Business"."name" LEFT JOIN "storehub_mongo"."businesses" AS "businesses__via__business" ON "storehub_mongo"."products"."business" = "businesses__via__business"."name" WHERE (NOT (LOWER("businesses__via__business"."email") LIKE '%storehub%') OR ("businesses__via__business"."email" IS NULL)) AND (NOT (LOWER("Mask Businesses - Business"."planid") LIKE '%internal%') OR ("Mask Businesses - Business"."planid" IS NULL)) [[AND "storehub_mongo"."products"."business" = {{accountname}}]] GROUP BY "storehub_mongo"."products"."business", "Mask Businesses - Business"."businesstype" HAVING COUNT(CASE WHEN "storehub_mongo"."products"."minrefunitprice" >= 1 OR "storehub_mongo"."products"."maxrefunitprice" >= 1 THEN 1 END)`
    * `COUNT(rti."*") AS "count", rti."parentproduct_title" AS parentproduct_title, rti."product_category" AS product_category, rti."skunumber" AS skunumber, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."quantity",0) ELSE COALESCE(+rti."quantity",0) END) AS salesItemsCount, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(0,0) ELSE COALESCE(+rti."total",0) END) AS sales, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(+rti."total",0) ELSE COALESCE(0,0) END) AS returns, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."discount",0) ELSE COALESCE(+rti."discount",0) END) AS discount, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."subtotal",0) ELSE COALESCE(+rti."subtotal",0) END) AS subtotal, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS returnsCount, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."tax",0) ELSE COALESCE(+rti."tax",0) END) AS tax, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."cost",0) ELSE COALESCE(+rti."cost",0) END) AS cost, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."quantity",0) ELSE COALESCE(+rti."quantity",0) END) AS quantity, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."roundedamount",0) ELSE COALESCE(+rti."roundedamount",0) END) AS rounding, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."servicecharge",0) ELSE COALESCE(+rti."servicecharge",0) END) AS serviceCharge FROM report_transaction_items rti WHERE rti.status not in ('pendingPayment','failed','created','paymentCancelled') AND rti.iscancelled is not true AND rti.transactiontype <> 'PreOrder' [[AND (rti.createdtime >= dateadd(hour,0,{{Start_Date}}) and rti.createdtime < dateadd(hour,24,{{End_Date}}))]] [[AND rti.business = {{bo_account_name}}]] GROUP BY rti.storename, "month", rti."parentproduct_title", rti."product_category", rti."skunumber" )`
    * `Item from a New Order' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"deleteItemOfNew":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Delete Item from a Saved Open Order' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"deleteItemOfSaved":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Refund' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"refund":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Cancel' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"cancel":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Discount' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"discount":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Re-print/Re-send Receipt' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"reprintReceipt":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Open/Close Shift' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"openCloseShift":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'View/Manage Transactions' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"viewEditTransaction":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} ORDER BY count`
    * `ItemsCount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(0,0) ELSE COALESCE(+tri."total",0) END) AS sales, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(+tri."total",0) ELSE COALESCE(0,0) END) AS returns, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."discount",0) ELSE COALESCE(+tri."discount",0) END) AS discount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."subtotal",0) ELSE COALESCE(+tri."subtotal",0) END) AS subtotal, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS returnsCount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."tax",0) ELSE COALESCE(+tri."tax",0) END) AS tax, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."cost",0) ELSE COALESCE(+tri."cost",0) END) AS cost, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."quantity",0) ELSE COALESCE(+tri."quantity",0) END) AS quantity FROM storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__items tri on tr._id = tri.transactionrecords_foreignkey WHERE tr.business = {{BO_Account`
    * `Product name", i.quantity as "Expected QTY", i.countedqty as "Count`
    * `Product total", sum (case when tr.transactiontype = 'Sale' then tri.tax else -tri.tax end) as "Total Product Tax" from ( select * from storehub_mongo.transactionrecords tr where tr.business = {{account`
    * `count(*) AS "count" FROM "storehub_mongo"."products" left join storehub_mongo.businesses mb on "storehub_mongo"."products"."business" = mb."name" WHERE (lower("storehub_mongo"."products"."title") like '%roti telur%') or (lower("storehub_mongo"."products"."title") like '%roti bomb%') or (lower("storehub_mongo"."products"."title") like '%roti tissue%') or (lower("storehub_mongo"."products"."title") like '%roti kosong%') or (lower("storehub_mongo"."products"."title") like '%maggie goreng%') or (lower("storehub_mongo"."products"."title") like '%maggi goreng%') and mb.businesstype in ('Bar','Cafe','Restaurant','Restuarant','cafe','restaurant','Food Truck') and mb.subscriptionstatus in ('active')`
    * `count(*) AS "count", mb.businesstype as "business type" FROM "storehub_mongo"."products" left join storehub_mongo.businesses mb on "storehub_mongo"."products"."business" = mb."name" WHERE ((lower("storehub_mongo"."products"."business") like '%hotpot%') or (lower("storehub_mongo"."products"."business") like '%steamboat%') or (lower("storehub_mongo"."products"."business") like '%huoguo%')) and mb.businesstype in ('Bar','Cafe','Restaurant','Restuarant','cafe','restaurant','Food Truck') and mb.subscriptionstatus in ('Active') and mb.country in ('MY')`
    * `count(*) as "# Transactions last 30 days", SUM(storehub_mongo.transactionrecords.total) as "Total Transactions last 30 days", SUM(CASE WHEN storehub_mongo.transactionrecords.channel = 1 THEN 1 ELSE 0 END) as "# Online Transactions last 30 days", SUM(CASE WHEN storehub_mongo.transactionrecords.channel = 1 THEN storehub_mongo.transactionrecords.total ELSE 0 END) as "Total Online Transactions last 30 days" from storehub_mongo.transactionrecords where storehub_mongo.transactionrecords.createdtime >= DATEADD(Day,-30,GETDATE()) [[and (storehub_mongo.transactionrecords.createdtime >= dateadd(hour,0,{{Start_Date}}) and storehub_mongo.transactionrecords.createdtime < dateadd(hour,24,{{End_Date}}))]] and storehub_mongo.transactionrecords.iscancelled is not true and storehub_mongo.transactionrecords.transactiontype = 'Sale' AND "storehub_mongo"."transactionrecords"."status" <> 'cancelled' AND "storehub_mongo"."transactionrecords"."status" <> 'failed' AND "storehub_mongo"."transactionrecords"."status" <> 'paymentCancelled' AND "storehub_mongo"."transactionrecords"."status" <> 'pendingPayment' AND "storehub_mongo"."transactionrecords"."status" <> 'pendingVerification' AND "storehub_mongo"."transactionrecords"."status" <> 'created' group by storehub_mongo.transactionrecords.business ) transactionrecords on transactionrecords.business = storehub_mongo.businesses.name LEFT JOIN storehub_mongo.onlinestoreinfos on storehub_mongo.onlinestoreinfos.business = storehub_mongo.businesses.name left join storehub_mongo.onlinestoreinfos__socialmediainfo osismi on osismi.onlinestoreinfos_foreignkey = storehub_mongo.onlinestoreinfos._id left join storehub_mongo.onlinestoreinfos__socialmediainfo__facebook osismif on osismif.onlinestoreinfos_foreignkey = storehub_mongo.onlinestoreinfos._id LEFT JOIN ( SELECT storehub_mongo.products.business, sum(case when storehub_mongo.products.isonline is true then 1 else 0 end) as total_online_product from storehub_mongo.products where storehub_mongo.products.isdeleted is not true group by storehub_mongo.products.business ) products on products.business = storehub_mongo.businesses.name WHERE CHARINDEX('internal', storehub_mongo.businesses.planid) = 0 and CHARINDEX('@storehub.com', storehub_mongo.businesses.email) = 0 AND storehub_mongo.businesses.subscriptionstatus = 'Active' [[AND "storehub_mongo"."businesses"."name" = {{accountname}}]] [[AND "storehub_mongo"."businesses"."country" = {{accountcountry}}]] [[AND storehub_mongo.businesses.isonlinestorepublished = {{isonlinestorepublished}}]] [[and storehub_mongo.businesses.isonline = {{isonline}}]] GROUP BY "storehub_mongo"."businesses"."name", storehub_mongo.businesses.phone, storehub_mongo.businesses.businesstype, "Industry", storehub_mongo.businesses.country, storehub_mongo.businesses.isonlinestorepublished, storehub_mongo.onlinestoreinfos.firstenabledate, storehub_mongo.onlinestoreinfos.firstpublishdate, storehub_mongo.onlinestoreinfos.lastpublishdate, storehub_mongo.onlinestoreinfos.customdomain, storehub_mongo.businesses.isonlinestorepublished, products.total_online_product, transactionrecords."# Transactions last 30 days", transactionrecords."Total Transactions last 30 days", transactionrecords."# Online Transactions last 30 days", transactionrecords."Total Online Transactions last 30 days", osismif.pageid, osismi.instagram, storehub_mongo.businesses.email ORDER BY storehub_mongo.onlinestoreinfos.firstpublishdate DESC )`
    * ... and 95 more variations

---

### **Metric: Revenue**
* **Found:** 110 times
* **Common Calculations:**
    * `SUM(TR.total)`
    * `SUM(tr.total)`
    * `sum(amount)`
    * `sum(tr.total)`

---

### **Metric: Cashback**
* **Found:** 102 times
* **Common Calculations:**
    * `Cashback earned", case when lcl.eventtype = 'expense' then lcl.amount else null end as "Cashback spent", tr.total from ( select tr._id, tr.receiptnumber, tr.business, dateadd(hour,8,tr.createdtime) as createdtime, dateadd(hour,8,tr.fulfilldate) as fulfilldate, tr.channel, tr.shippingtype, tr.iscancelled, tr.isdisbursed, tr.status, tr.discount, tr.total from storehub_mongo.transactionrecords tr where tr.receiptnumber = {{receiptnumber}} [[and tr.channel = {{channel}}]] [[and tr.business = {{accountname}}]] [[and cast(dateadd(hour,8,tr.createdtime) as date) = {{txn`
    * `Cashback reminder' when re.globalCampaignInformationId = '630eeb369ce7f44578cf2cac' then 'Win back lost customers' when re.globalCampaignInformationId = '630eeb369ce7f44578cf2cad' then 'Birthday promotion' end as campaign_name, count(distinct re.campaignjobId) as total_customer_reach, count(distinct re.customerphone) as total_unique_customer_reach, count(case when txncreatedtime BETWEEN re.createdtime and DATEADD('day', {{atrribution_days}}, re.createdtime) then re.txnCustomerid end) as total_return_customer, count(distinct re.txn`
    * `Cashback reminder' when re.globalCampaignInformationId = '630eeb369ce7f44578cf2cac' then 'Win back lost customers' when re.globalCampaignInformationId = '630eeb369ce7f44578cf2cad' then 'Birthday promotion' when re.globalCampaignInformationId = '640996dffd94756d7291de0e' then 'Welcome new customer' end as campaign_name, dateadd(hour,8,re.createdtime) as sms_sent_time, dateadd(hour,8,re.txncreatedtime) as repurchase_txn_time, DATEDIFF(day, re.createdtime, re.txncreatedtime) as days_since_receive_sms, re.total as order_value, ROW_NUMBER() OVER(PARTITION BY re.customerphone, campaign_name, re.createdtime ORDER BY re.txncreatedtime ASC) AS rownum from transformations.report_engage re left join storehub_mongo.customers cust on re.txnCustomerid = cust.customerid and re.business = cust.business where re.globalCampaignInformationId <> '634e466b83568a5b429f03f1' [[and re.business = {{account_name}}]] [[and campaign_name = {{campaign}}]] order by 4 ASC, 5 ASC, 6 ASC, 7 ASC NULLS FIRST ) select distinct s.business as "bo account name", s.firstname, s.customerphone, s.campaign_name as campaign, s.sms_sent_time as "sms sent time", min(s.repurchase_txn_time) as "1st repurchase time", max(case when s.rownum = 1 then s.days_since_receive_sms else null end) as "1st repurchase is x days since sms", max(case when s.rownum = 1 then s.order_value else 0 end) as "1st repurchase order value", MAX(case when s.rownum = 1 then dateadd(hour,8,tr.createdtime) end) as "last txn before repurchase", datediff(day, "last txn before repurchase", "1st repurchase time") as "days since last purchase" from s left join storehub_mongo.transactionrecords tr on tr.business = s.business and tr.customerid = s.txnCustomerid and (tr.channel is null or tr.channel = 3) and tr.transactiontype = 'Sale' and tr.iscancelled is not TRUE and tr.status not in ('cancelled','created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(day,-180,'2022-09-23') and dateadd(hour,8,tr.createdtime) < s.repurchase_txn_time where s.repurchase_txn`
    * `cashback #" , sum(lc.amount) as "claimed cashback amount" from storehub_mongo.loyaltychangelogs lc left join storehub_mongo.businesses b on b.name = lc.business where {{snippet: Eliminate Internal Accounts}} and b.country = 'MY' and lc.eventtime >= dateadd(hour,-8,'2023-03-01') and lc.eventtype = 'earned' and lc.rewardtype = 'cashback' and lc.source = 'REGISTER' and lc.eventtime >= dateadd(hour,-8,cast(getdate()-30 as date)) AND lc.eventtime < dateadd(hour,-8,cast(getdate() as date)) group by 1 ) , sms as ( select cj.business , count(distinct cj._id) as message_sent_count from storehub_mongo.campaignjobs cj left join storehub_mongo.businesses b on b.name = cj.business where {{snippet: Eliminate Internal Accounts}} and b.country = 'MY' and cj.createdtime >= '2022-09-23' and cj.pushstatus = 'SUCCESS' [[and cj.business = {{account_name}}]] and cj.createdtime >= dateadd(hour,-8,cast(getdate()-30 as date)) AND cj.createdtime < dateadd(hour,-8,cast(getdate() as date)) group by 1 ) select coalesce(txn.business,cb.business,sms.business) business , txn.country , txn.subscriptionstatus , txn.planid , txn.businesstype , txn."# of stores" , txn."transacting store#" , txn."Offline (#)" , txn."Offline ($)" , txn."Ecomm (#)" , txn."Ecomm ($)" , txn."Beep QR (#)" , txn."Beep QR ($)" , txn."Beep Delivery (#)" , txn."Beep Delivery ($)" , cb."claimed cashback #" , cb."claimed cashback amount" , sms.message_sent_count , txn."total txn" , txn."total gmv" from txn full join cb on txn.business = cb.business full join sms on txn`
    * `cashback %", bu.addonids, t."total txn`
    * `cashback as ( select cb.business bo_name , txn.storeid , count(distinct cb.receiptnumber) cb_txn_count from storehub_mongo.loyaltychangelogs cb left join ( select receiptnumber,status,storeid from storehub_mongo.transactionrecords where 1=1 [[and createdtime BETWEEN dateadd(hour,0,{{Start_Date}}) and dateadd(hour,24,{{End_Date}}) ]] ) txn on cb.receiptnumber = txn.receiptnumber where 1=1 and cb.eventtype = 'earned' and cb.rewardtype = 'cashback' and txn.status not in ('cancelled','created','failed','paymentCancelled','pendingPayment','pendingVerification') [[and cb.eventtime BETWEEN dateadd(hour,0,{{Start_Date}}) and dateadd(hour,24,{{End_Date}}) ]] group by 1,2 ) select s.bo_name, s.biztype, s.planid, s.storeid, s.storename, id.coordinates, s.state, s.postalcode, s.city, listagg(c.name, '|') as engage_campaign, cj.engage_cust_count, s.enablecashback, cb.cb_txn_count as "cb txn#", s."offline txn#", s."offline gmv", case when s."offline txn#" > 0 then isnull(s."offline gmv",0) / s."offline txn#" else null end as "offline aov", s."qr txn#", s."qr gmv", case when s."qr txn#" > 0 then isnull(s."qr gmv",0) / s."qr txn#" else null end as "qr aov", s."bd txn#", s."bd gmv", case when s."bd txn#" > 0 then isnull(s."bd gmv",0) / s."bd txn`
    * `cashback' AND l.eventtype = 'earned' AND l.eventtime::date BETWEEN getdate()::date - 30 AND getdate()::date - 1 GROUP BY 1,2 ) SELECT CASE WHEN claim_rate < 0.5 THEN '0.00 %' WHEN claim_rate < 10.00 THEN '<10.00%' WHEN claim_rate < 20.00 THEN '<20.00%' ELSE '>=20.00%' END claim_rate , count(distinct business) FROM temp WHERE txn`
    * `cashback_amount' then CONCAT(' ', filtervalue) when segmentsourcefilter.condition = 'GREATER_THAN' and filterFieldKey = 'cashback_amount' then CONCAT('> ', filtervalue) when segmentsourcefilter.condition = 'SMALLER_THAN_EQUAL' then CONCAT(filtervalue, ' ') when segmentsourcefilter.condition = 'SMALLER_THAN' then CONCAT(filtervalue, ' <') when segmentsourcefilter.condition = 'IS' and filterFieldKey = 'birthday' then CONCAT(filtervalue,'days') else concat(segmentsourcefilter.funcname, concat(' - ', concat(segmentsourcefilter.condition, concat(' ', filtervalue)))) end as conditionfilter from ( select name, globalcampaigninformationid, business, case when initialsegmentid is not null and initialsegmentid <> '' then initialsegmentid when segmentid is not null and segmentid <> '' then segmentid end as segmentid from storehub_mongo.campaigns where segmentid is not null ) c left join storehub_mongo.campaignsegments cs on cs._id = c.segmentid left join storehub_mongo.campaignsegments__nestedsource segmentsource on cs._id = segmentsource.campaignsegments_foreignkey left join storehub_mongo.campaignsegments__nestedsource__filters segmentsourcefilter on segmentsource._id = segmentsourcefilter.campaignsegments__nestedsource_foreignkey ), t as ( select tr.business, count(distinct case when tr.channel is null then tr.receiptnumber end) as offlinetxn, sum(case when tr.channel is null then tr.total end) as offlinegmv, count(distinct case when tr.channel = 3 and tr.shippingtype in ('delivery','pickup') then tr.receiptnumber end) as bdtxn, sum(case when tr.channel = 3 and tr.shippingtype in ('delivery','pickup') then tr.total end) as bdgmv, count(distinct case when tr.channel = 3 and tr.shippingtype in ('dineIn','takeaway') then tr.receiptnumber end) as qrtxn, sum(case when tr.channel = 3 and tr.shippingtype in ('dineIn','takeaway') then tr.total end) as qrgmv from storehub_mongo.transactionrecords tr where (tr.channel is null or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway'))) and tr.transactiontype = 'Sale' and tr.iscancelled is not TRUE and tr.status not in ('cancelled','created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') [[and tr.business = {{account_name}}]] [[and (tr.createdtime >= dateadd(hour,0,{{Start_Date}}) and tr.createdtime < dateadd(hour,24,{{End_Date}}))]] group by 1 ) select c.business, b.subscriptionstatus, b.businesstype, b.isqrorderingenabled, c.name as campaign_name, c.status as campaign_status, cust."phone" as customer_with_phone, cust."cb count" as customer_with_cashback, cust."bday count" as customer_with_birthday, b.smscredits as sms_credit_balance, sc.first_sms_sent as first_sms_sent_time, sc.last_sms_sent as last_sms_sent_time, sc.total_unique_customer_reach as total_customer_reach, sc.total_sms_sent, sc.total_sms_cost, case when c.name = 'Cashback Reminder' and customer_with_cashback > 0 then cast(sc.total_unique_customer_reach as float) / cast(customer_with_cashback as float) when c.name = 'Win Back Lost Customers' then cast(sc.total_unique_customer_reach as float) / cast(customer_with_phone as float) when c.name = 'Birthday Promotion' and customer_with_birthday > 0 then cast(sc.total_unique_customer_reach as float) / cast(customer_with_birthday as float) when c.name = 'Welcome New Customers' then cast(sc.total_unique_customer_reach as float) / cast(customer_with_phone as float) end as "% customer targeted", re.repurchaseTotal, re.total_return_customer, case when sc.total_sms_cost > 0 then re.repurchaseTotal / sc.total_sms_cost else 0 end as total_roi, case when sc.total_unique_customer_reach > 0 then cast(re.total_return_customer as float) / cast(sc.total_unique_customer_reach as float) else 0 end as total_repurchase_rate, REGEXP_REPLACE (c.template, '&#39;', '''') as template, max(case when cs.filterFieldKey = 'cashback_amount' then cs.conditionfilter else null end) as cashback_condition, concat(max(case when cs.filterFieldKey = 'lastpurchasedate' and cs.condition in ('SMALLER_THAN_EQUAL','SMALLER_THAN') then concat(cs.conditionfilter, ' d ') else null end), max(case when cs.filterFieldKey = 'lastpurchasedate' and cs.condition in ('GREATER_THAN_EQUAL','GREATER_THAN') then cs.conditionfilter else null end)) as "lastpurchaseday(d)_condition", max(case when cs.filterFieldKey = 'birthday' then cs.conditionfilter else null end) as birthday_condition, dateadd(hour,8,c.starttime) as campaign_start_time, t.offlinetxn, t.offlinegmv, t.bdtxn, t.bdgmv, t.qrtxn`
    * `cashback_enabled" AS cashback_enabled, eb."beep_ordering_enabled" AS qr_enabled, eb."plan" AS subscription_plan, eb."qrdinein_txn_count_past30days" AS qr_txn_count_p30d, eb."qrdinein_txn_value_past30days" AS qr_gmv_p30d, eb."cashbackclaims_count_past30days" AS claimed_cb_count_p30d, eb."cashbackclaims_value_past30days" AS claimed_cb_amount_p30d, eb."qrdinein_txn_count_past7days" AS qr_txn_count_p7d, eb."qrdinein_txn_value_past7days" AS qr_gmv_p7d, eb."cashbackclaims_count_past7days" AS claimed_cb_count_p7d, eb."cashbackclaims_value_past7days" AS claimed_cb_amount_p7d, eb."cashback_campaignstatus", eb."winbacklostcustomers_campaignstatus", eb."birthdaypromotion_campaignstatus", eb."sms_sent_past30days" AS total_sms_sent_past30d, eb."sms_sent_past7days" AS total_sms_sent_p7d, eb."boostgooglereview_campaignstatus", eb."welcomenewcustomers_campaignstatus", eb."expiringcashbackalert_campaignstatus", eb."total_sms_sent_p180d" AS total_sms_sent_p6m, eb."campaign_published", eb."sms_credit_balance", eb."active_campaign_count", eb."engage_status", eb."cashbackexpiry_enabled", eb."crm_count_p7d", eb."crm_count_p30d", eb."bgr_total_sms_sent_p180d" AS bgr_total_sms_sent_p6m, eb."custom_total_sms_sent_p180d" AS custom_total_sms_sent_p6m, eb."engage_trial_end_date", eb."engage_trial_start_date", eb."pos_txn_count_past30days", eb."pos_txn_value_past30days" as offline_gmv_p30d, eb."beepdelivery_txn_count_past30days" AS bd_txn_count_p30d, eb."beepdelivery_txn`
    * `cashback_enabled, eb.beep_ordering_enabled, eb.beep_delivery_enabled, eb.first_enable_qrordering_date, eb.first_enable_cashback_date, eb.bdfirsttxndate, eb.beepqrfirsttxndate, eb.posfirsttxndate, eb.txnmorethanten, eb.pos_txn_count_past30days, eb.beepdelivery_txn_count_past30days, eb.qrdinein_txn_count_past30days, eb.pos_txn_value_past30days, eb.beepdelivery_txn_value_past30days, eb.qrdinein_txn_value_past30days, eb.cashbackclaims_count_past30days, eb.cashback_campaignstatus, eb.winbacklostcustomers_campaignstatus, eb.birthdaypromotion_campaignstatus, eb.boostgooglereview_campaignstatus, eb.welcomenewcustomers_campaignstatus, eb.expiringcashbackalert_campaignstatus, eb.sms_sent_past30days, eb.sms_sent_past7days, eb.pos_txn_count_past7days, eb.beepdelivery_txn_count_past7days, eb.qrdinein_txn_count_past7days, eb.pos_txn_value_past7days, eb.beepdelivery_txn_value_past7days, eb.qrdinein_txn_value_past7days, eb.cashbackclaims_count_past7days, eb.qr_gmv_usage_past30days, eb.qr_gmv_usage_past7days, eb.cashbackclaims_value_past30days, eb.cashbackclaims_value_past7days, eb.qr_txn_usage_past30days, eb.qr_txn`
    * ... and 23 more variations

---

### **Metric: New Customers**
* **Found:** 64 times
* **Common Calculations:**
    * `New Customers" from storehub_mongo.customers where CAST(dateadd(hour,8,storehub_mongo.customers.createdtime) as date) > (getdate() + INTERVAL '-30 day') [[and storehub_mongo.customers`
    * `New Customers' WHEN "storehub_mongo"."campaignjobs"."globalcampaigninformationid" = '630eeb369ce7f44578cf2cad' THEN 'Birthday Promotion' WHEN "storehub_mongo"."campaignjobs"."globalcampaigninformationid" = '630eeb369ce7f44578cf2cac' THEN 'Win Back Lost Customers`
    * `New Customers' then cast(sc.total_unique_customer_reach as float) / cast(customer_with_phone as float) end as "% customer targeted", re.repurchaseTotal, re.total_return_customer, case when sc.total_sms_cost > 0 then re.repurchaseTotal / sc.total_sms_cost else 0 end as total_roi, case when sc.total_unique_customer_reach > 0 then cast(re.total_return_customer as float) / cast(sc.total_unique_customer_reach as float) else 0 end as total_repurchase_rate, REGEXP_REPLACE (c.template, '&#39;', '''') as template, max(case when cs.filterFieldKey = 'cashback_amount' then cs.conditionfilter else null end) as cashback_condition, concat(max(case when cs.filterFieldKey = 'lastpurchasedate' and cs.condition in ('SMALLER_THAN_EQUAL','SMALLER_THAN') then concat(cs.conditionfilter, ' d ') else null end), max(case when cs.filterFieldKey = 'lastpurchasedate' and cs.condition in ('GREATER_THAN_EQUAL','GREATER_THAN') then cs.conditionfilter else null end)) as "lastpurchaseday(d)_condition", max(case when cs.filterFieldKey = 'birthday' then cs.conditionfilter else null end) as birthday_condition, dateadd(hour,8,c.starttime) as campaign_start_time, t.offlinetxn, t.offlinegmv, t.bdtxn, t.bdgmv, t.qrtxn, t.qrgmv from storehub_mongo.campaigns c left join storehub_mongo.businesses b on c.business = b.name left join ( SELECT cu.business AS "business", count(distinct cu.customerid) AS "count", count(distinct cu.phone) as "phone", count(distinct case when cu.storecreditsbalance > 0 then cu.customerid end) as "cb count", count(distinct case when (cu.birthday is not null or co.birthday is not null) then cu.customerid end) as "bday count" FROM storehub_mongo.customers cu left join transformations.mask_consumers co on cu.consumerid = co._id where cu.isdeleted is NOT TRUE group by 1 ) cust on cust."business" = b.name left join sc on c.business = sc.business and c.globalCampaignInformationId = sc.globalCampaignInformationId left join re on c.business = re.business and c.globalCampaignInformationId = re.globalCampaignInformationId left join cs on cs.business = c.business and cs.globalcampaigninformationid = c.globalcampaigninformationid left join t on t.business = c.business where {{snippet: Eliminate Internal Accounts`
    * `New Customers' then cast(sc.total_unique_customer_reach as float) / cast(customer_with_phone as float) end as "% customer targeted", re.repurchaseTotal, re.total_return_customer, re.repurchaseTotal / sc.total_sms_cost as total_roi, cast(re.total_return_customer as float) / cast(sc.total_unique_customer_reach as float) as total_repurchase_rate, REGEXP_REPLACE (c.template, '&#39;', '''') as template, max(case when cs.filterFieldKey = 'cashback_amount' then cs.conditionfilter else null end) as cashback_condition, concat(max(case when cs.filterFieldKey = 'lastpurchasedate' and cs.condition in ('SMALLER_THAN_EQUAL','SMALLER_THAN') then concat(cs.conditionfilter, ' d ') else null end), max(case when cs.filterFieldKey = 'lastpurchasedate' and cs.condition in ('GREATER_THAN_EQUAL','GREATER_THAN') then cs.conditionfilter else null end)) as "lastpurchaseday(d)_condition", max(case when cs.filterFieldKey = 'birthday' then cs.conditionfilter else null end) as birthday_condition, max(case when cs.filterFieldKey = 'cashbackexpirationdate' then cs.conditionfilter else null end) as cashbackexpiry_condition, dateadd(hour,8,c.starttime) as campaign_start_time from storehub_mongo.campaigns c left join storehub_mongo.businesses b on c.business = b.name left join ( SELECT cu.business AS "business", count(distinct cu.customerid) AS "count", count(distinct cu.phone) as "phone", count(distinct case when cu.storecreditsbalance > 0 then cu.customerid end) as "cb count", count(distinct case when (cu.birthday is not null or co.birthday is not null) then cu.customerid end) as "bday count" FROM storehub_mongo.customers cu left join transformations.mask_consumers co on cu.consumerid = co._id where cu.isdeleted is NOT TRUE group by 1 ) cust on cust."business" = b.name left join sc on c.business = sc.business and c.globalCampaignInformationId = sc.globalCampaignInformationId left join re on c.business = re.business and c.globalCampaignInformationId = re.globalCampaignInformationId left join cs on cs.business = c.business and cs.globalcampaigninformationid = c.globalcampaigninformationid where {{snippet: Eliminate Internal Accounts`
    * `New Customers' then cast(sc.unique_customer_reach as float) / cast(customer_with_phone as float) when c.name = 'Expiring Cashback Alert' and customer_with_cashback > 0 then cast(sc.unique_customer_reach as float) / cast(customer_with_cashback as float) end as "% customer targeted", re.sms_repurchaseTotal, re.sms_return_customer, case when sc.sms_cost > 0 then re.sms_repurchaseTotal / sc.sms_cost else 0 end as sms_roi, case when sc.unique_customer_reach > 0 then cast(re.sms_return_customer as float) / cast(sc.unique_customer_reach as float) else 0 end as sms_repurchase_rate, REGEXP_REPLACE (c.template, '&#39;', '''') as template, dateadd(hour,8,c.starttime) as campaign_start_time from storehub_mongo.campaigns c left join storehub_mongo.businesses b on c.business = b.name left join ( SELECT cu.business AS "business", count(distinct cu.customerid) AS "count", count(distinct cu.phone) as "phone", count(distinct case when cu.storecreditsbalance > 0 then cu.customerid end) as "cb count", count(distinct case when (cu.birthday is not null or co.birthday is not null) then cu.customerid end) as "bday count" FROM storehub_mongo.customers cu left join transformations.mask_consumers co on cu.consumerid = co._id where cu.isdeleted is NOT TRUE group by 1 ) cust on cust."business" = b.name left join sc on c.business = sc.business and c.globalCampaignInformationId = sc.globalCampaignInformationId left join re on c.business = re.business and c.globalCampaignInformationId = re.globalCampaignInformationId where {{snippet: Eliminate Internal Accounts`
    * `New Customers') then cast(total_sms_sent as float) / cast(customers_with_phones as float) when total_sms_sent > 0 and customers_with_birthday > 0 and c.name = 'Birthday Promotion' then cast(total_sms_sent as float) / cast(customers_with_birthday as float) else 0 end as "% customer targeted", REGEXP_REPLACE (c.template, '&#39;', '''') as template, dateadd(hour,8,c.starttime) as campaign_start_time from storehub_mongo.campaigns c left join storehub_mongo.campaignjobs cj on c.business = cj.business and c.globalcampaigninformationid = cj.globalcampaigninformationid left join storehub_mongo.businesses b on c.business = b.name left join ( SELECT cu.business AS "business", count(distinct cu.customerid) AS "count", count(distinct cu.phone) as "phone", count(distinct case when cu.storecreditsbalance > 0 then cu.customerid end) as "cb count", count(distinct case when (cu.birthday is not null or co.birthday is not null) then cu.customerid end) as "bday count" FROM storehub_mongo.customers cu left join transformations.mask_consumers co on cu.consumerid = co._id where cu.isdeleted is NOT TRUE group by 1 ) cust on cust."business" = b.name where {{snippet: Eliminate Internal Accounts`
    * `New Members", count(distinct case when c.tags like 'SH_Tier%' and c.createdtime < dateadd(day,-1,dateadd(hour,-8,current_date)) and tr.receiptnumber is not null then c.customerid end) as "Returning Members" from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id left join storehub_mongo.customers`
    * `New Members", count(distinct case when c.tags like 'SH_Tier%' and c.membershipjointime < dateadd(day,-1,dateadd(hour,-8,current_date)) and tr.receiptnumber is not null then c.customerid end) as "Returning Members" from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id left join storehub_mongo.customers c on tr.customerid = c.customerid where 1=1 and (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel in (1,10,11,12)) and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and tr.status not in ('cancelled','created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(day,-1,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(hour,-8,current_date) and tr.total < 10000000 and tr.business = 'sugarandi' group by 1,2,3 order by 1,2,3 ) , five_days as ( select dateadd(day,-1,current_date) as date_id, tr.business, bs.name as storename, count(distinct case when tr.createdtime >= dateadd(day,-5,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-4,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-5)", count(distinct case when tr.createdtime >= dateadd(day,-5,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-4,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-5)", case when "Total Transactions (d-5)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-5)" as float)/"Total Transactions (d-5)"*100,0),'%') end as "(d-5) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-4,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-3,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-4)", count(distinct case when tr.createdtime >= dateadd(day,-4,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-3,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-4)", case when "Total Transactions (d-4)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-4)" as float)/"Total Transactions (d-4)"*100,0),'%') end as "(d-4) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-3,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-2,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-3)", count(distinct case when tr.createdtime >= dateadd(day,-3,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-2,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-3)", case when "Total Transactions (d-3)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-3)" as float)/"Total Transactions (d-3)"*100,0),'%') end as "(d-3) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-2,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-1,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-2)", count(distinct case when tr.createdtime >= dateadd(day,-2,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-1,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-2)", case when "Total Transactions (d-2)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-2)" as float)/"Total Transactions (d-2)"*100,0),'%') end as "(d-2) % Transactions Containing Members" from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id left join storehub_mongo.customers`
    * `New Members", count(distinct case when c.tags like 'SH_Tier%' and c.membershipjointime < dateadd(day,-1,dateadd(hour,-8,current_date)) and tr.receiptnumber is not null then c.customerid end) as "Returning Members" from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id left join storehub_mongo.customers c on tr.customerid = c.customerid where 1=1 and (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway'))) and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and tr.status not in ('cancelled','created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(day,-1,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(hour,-8,current_date) and tr.total < 10000000 and tr.business = 'cafekitsunemalaysia' group by 1,2,3 order by 1,2,3 ) , five_days as ( select dateadd(day,-1,current_date) as date_id, tr.business, bs.name as storename, count(distinct case when tr.createdtime >= dateadd(day,-5,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-4,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-5)", count(distinct case when tr.createdtime >= dateadd(day,-5,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-4,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-5)", case when "Total Transactions (d-5)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-5)" as float)/"Total Transactions (d-5)"*100,0),'%') end as "(d-5) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-4,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-3,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-4)", count(distinct case when tr.createdtime >= dateadd(day,-4,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-3,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-4)", case when "Total Transactions (d-4)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-4)" as float)/"Total Transactions (d-4)"*100,0),'%') end as "(d-4) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-3,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-2,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-3)", count(distinct case when tr.createdtime >= dateadd(day,-3,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-2,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-3)", case when "Total Transactions (d-3)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-3)" as float)/"Total Transactions (d-3)"*100,0),'%') end as "(d-3) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-2,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-1,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-2)", count(distinct case when tr.createdtime >= dateadd(day,-2,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-1,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-2)", case when "Total Transactions (d-2)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-2)" as float)/"Total Transactions (d-2)"*100,0),'%') end as "(d-2) % Transactions Containing Members" from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id left join storehub_mongo.customers`
    * `New Members", count(distinct case when c.tags like 'SH_Tier%' and c.membershipjointime < dateadd(day,-1,dateadd(hour,-8,current_date)) and tr.receiptnumber is not null then c.customerid end) as "Returning Members" from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id left join storehub_mongo.customers c on tr.customerid = c.customerid where 1=1 and (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway'))) and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and tr.status not in ('cancelled','created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(day,-1,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(hour,-8,current_date) and tr.total < 10000000 and tr.business = 'dkunafa' group by 1,2,3 order by 1,2,3 ) , five_days as ( select dateadd(day,-1,current_date) as date_id, tr.business, bs.name as storename, count(distinct case when tr.createdtime >= dateadd(day,-5,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-4,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-5)", count(distinct case when tr.createdtime >= dateadd(day,-5,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-4,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-5)", case when "Total Transactions (d-5)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-5)" as float)/"Total Transactions (d-5)"*100,0),'%') end as "(d-5) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-4,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-3,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-4)", count(distinct case when tr.createdtime >= dateadd(day,-4,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-3,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-4)", case when "Total Transactions (d-4)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-4)" as float)/"Total Transactions (d-4)"*100,0),'%') end as "(d-4) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-3,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-2,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-3)", count(distinct case when tr.createdtime >= dateadd(day,-3,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-2,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-3)", case when "Total Transactions (d-3)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-3)" as float)/"Total Transactions (d-3)"*100,0),'%') end as "(d-3) % Transactions Containing Members", count(distinct case when tr.createdtime >= dateadd(day,-2,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-1,dateadd(hour,-8,current_date)) then tr.receiptnumber end) as "Total Transactions (d-2)", count(distinct case when tr.createdtime >= dateadd(day,-2,dateadd(hour,-8,current_date)) and tr.createdtime < dateadd(day,-1,dateadd(hour,-8,current_date)) and c.tags like 'SH_Tier%' then tr.receiptnumber end) as "Total # Transactions Containing Members (d-2)", case when "Total Transactions (d-2)" = 0 then '0%' else concat(round(cast("Total # Transactions Containing Members (d-2)" as float)/"Total Transactions (d-2)"*100,0),'%') end as "(d-2) % Transactions Containing Members" from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id left join storehub_mongo.customers`
    * ... and 49 more variations

---

### **Metric: Refund Amount**
* **Found:** 58 times
* **Common Calculations:**
    * `SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"deleteItemOfNew":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Delete Item from a Saved Open Order' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"deleteItemOfSaved":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Refund' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"refund":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Cancel' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"cancel":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Discount' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"discount":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Re-print/Re-send Receipt' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"reprintReceipt":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Open/Close Shift' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"openCloseShift":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'View/Manage Transactions' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"viewEditTransaction":"1"%' THEN 1 ELSE 0 END)`
    * `Total Sales Returned`
    * `refund_missing' then 1 else 0 end) as "Total pgw_refund_missing", sum("storehub_mongo"."payoutitems"."amount") AS "sum" FROM ( select * from "storehub_mongo"."payoutitems" WHERE "storehub_mongo"."payoutitems"."payoutstatus" = 'pending' AND "storehub_mongo"."payoutitems"."reconstatus" = 'pending' and storehub_mongo.payoutitems.cause = 'cancel' [[and {{country}}]] [[AND cast(dateadd(hour,8,"storehub_mongo"."payoutitems"."settledat") as date) <= cast(dateadd(hour,8,{{cutoffdate}}) as date)]] ) payoutitems left join ( select * from storehub_mongo.recondiscrepancies rd where rd.discrepancytype = 'pgw_refund_missing`
    * `sum(case when gr._id is not null and payoutitems.reconstatus = 'pending' then 1 else 0 end) as "Total need recon", sum(case when gr._id is null then 1 else 0 end) as "Total no gateway records", sum(case when rd.discrepancytype = 'pgw_refund_missing' then 1 else 0 end) as "Total pgw_refund_missing", sum("storehub_mongo"."payoutitems"."amount") AS "sum" FROM ( select * from "storehub_mongo"."payoutitems" WHERE "storehub_mongo"."payoutitems"."payoutstatus" = 'pending' AND "storehub_mongo"."payoutitems"."reconstatus" = 'pending' and storehub_mongo.payoutitems.cause = 'cancel' [[and {{country}}]] [[AND cast(dateadd(hour,8,"storehub_mongo"."payoutitems"."settledat") as date) <= cast(dateadd(hour,8,{{cutoffdate}}) as date)]] ) payoutitems left join ( select * from storehub_mongo.recondiscrepancies rd where rd.discrepancytype = 'pgw_refund_missing' and rd.isresolved is false ) rd on rd.receiptnumber = storehub_mongo.payoutitems.receiptnumber left join ( select * from storehub_mongo.gatewayrecords gr where gr.transactiontype = 'refund' ) gr on gr.receiptnumber = storehub_mongo.payoutitems.receiptnumber inner join ( select * from storehub_mongo.transactionrecords tr where tr.createdtime > CAST((getdate() + INTERVAL '-180 day') AS date) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') ) tr on tr.receiptnumber = storehub_mongo.payoutitems.receiptnumber left join ( select * from storehub_mongo.transactionrecords__payments trp where trp.paymentmethod != 'Voucher' )`
    * `transactiontype = 'Return' THEN COALESCE(0,0) ELSE COALESCE(+tr.total,0) END) AS "Total Sales", COUNT(*) AS "Total Transactions", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.discount,0) ELSE COALESCE(+tr.discount,0) END) AS "Total Discount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.tax,0) ELSE COALESCE(+tr.tax,0) END) AS "Tax", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.servicecharge,0) ELSE COALESCE(+tr.servicecharge,0) END) AS "Service Charge", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(+tr.total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.subtotal,0) ELSE COALESCE(+tr.subtotal,0) END) AS "SubTotal", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.roundedamount,0) ELSE COALESCE(+tr.roundedamount,0) END) AS "Rounding", SUM(CASE WHEN tr.transactiontype = 'Return'`
    * `transactiontype = 'Return' THEN COALESCE(0,0) ELSE COALESCE(+tr.total,0) END) AS "Total Sales", COUNT(*) AS "Total Transactions", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.discount,0) ELSE COALESCE(+tr.discount,0) END) AS "Total Discount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.tax,0) ELSE COALESCE(+tr.tax,0) END) AS "Tax", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.shippingfee, 0) ELSE COALESCE(+ tr.shippingfee, 0) END) AS "Shipping Fee", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.servicecharge,0) ELSE COALESCE(+tr.servicecharge,0) END) AS "Service Charge", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(+tr.total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(0, 0) ELSE COALESCE(+ tr.pax, 0) END) AS "Pax", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.subtotal,0) ELSE COALESCE(+tr.subtotal,0) END) AS "SubTotal", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.roundedamount,0) ELSE COALESCE(+tr.roundedamount,0) END) AS "Rounding", SUM(CASE WHEN tr.transactiontype = 'Return'`
    * `transactiontype = 'Sale' and storehub_mongo.transactionrecords.status != 'cancelled' and storehub_mongo.transactionrecords.status != 'failed' and storehub_mongo.transactionrecords.status != 'paymentCancelled' and storehub_mongo.transactionrecords.status != 'pendingPayment' and storehub_mongo.transactionrecords.status != 'pendingVerification' then storehub_mongo.transactionrecords.total else 0 end) - SUM(case when storehub_mongo.transactionrecords.channel is null and storehub_mongo.transactionrecords.transactiontype = 'Return'`
    * `transactiontype = 'Sale' then tr.receiptnumber end) as txn_count_sold, count(distinct case when tr.transactiontype = 'Return' then tr.receiptnumber end) as txn_count_return, sum(case when tr.transactiontype = 'Sale' then tr.total end) as total_gmv_sold, sum(case when tr.transactiontype = 'Return' then tr.total end) as total_gmv_return, txn_count_sold - isnull(txn_count_return,0) as total_net_txn_count, total_gmv_sold - isnull(total_gmv_return,0) as total_net_gmv from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on bs._id = tr.storeid WHERE tr.business in ('joeswestern', 'facetofacenoodleshouse', 'juicelab', 'seoulkoreanstreetfood', 'riceon', 'hopecoffee', 'subway', 'saladateliertaylors', 'mybobateahouse', 'jomtarikbistro', 'classicbowl','xoxocoffee','tintojika','theoldbakery','prestigecafe', 'malaco','harihariayam') and tr.storeid in ('633a4f52378c39000766b2a7', '633a539bb537780006036edf', '5935311ca80222a3745165f2', '625636f66d26b300084124eb', '633aa8ceea43070008742e64', '63747d2aa07b6a0008108c24', '63a29c30e677e80008f0470d', '63a2a5a16b6f220007796bc7', '63745ceb7b7f960007de8dc5', '63c76dcefd60c7000810a5c2', '6407ff9a85a8cd000847051b', '642e864d6530b60008775fcc','646dcd32356d2100070d16cc','64dd8370c7e60200074f6f6f','65e1b25906f9de00087db009', '67e13ad10265410007f9821a', '6840821e0260200008147e10') and (tr.channel is null or tr.channel = 2 or tr.channel = 3) and tr.transactiontype in ('Sale','Return'`
    * `transactiontype = 'Sale' then tri.quantity end) AS total_items_sold, sum(case when tr.transactiontype = 'Sale' then tri.total end) as total_item_gross_sales, sum(case when tr.transactiontype = 'Sale' then tri.subtotal end) as total_item_gross_subtotal, sum(case when tr.transactiontype = 'Return' then tri.quantity end) AS total_items_returned, sum(case when tr.transactiontype = 'Return' then tri.total end) as total_sales_returned, total_items_sold - isnull(total_items_returned,0) as total_net_items_sold, total_item_gross_sales - isnull(total_sales_returned,0) as total_net_sales, SUM(CASE WHEN tr.transactiontype = 'Sale' then tri.tax end) as total_tax_sold, SUM(CASE WHEN tr.transactiontype = 'Return' then tri.tax end) as total_tax_returned, total_tax_sold - isnull(total_tax_returned,0) as total_net_tax from storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on bs._id = tr.storeid left join storehub_mongo.transactionrecords__items tri on tr._id = tri.transactionrecords_foreignkey left join storehub_mongo.products p on tri.productid = p.original_id WHERE tr.business in ('joeswestern', 'facetofacenoodleshouse', 'juicelab', 'seoulkoreanstreetfood', 'riceon', 'hopecoffee', 'subway', 'saladateliertaylors', 'mybobateahouse', 'jomtarikbistro', 'classicbowl', 'xoxocoffee', 'tintojika', 'theoldbakery', 'prestigecafe', 'malaco', 'harihariayam') and tr.storeid in ('633a4f52378c39000766b2a7', '633a539bb537780006036edf', '5935311ca80222a3745165f2', '625636f66d26b300084124eb', '633aa8ceea43070008742e64', '63747d2aa07b6a0008108c24', '63a29c30e677e80008f0470d', '63a2a5a16b6f220007796bc7', '63745ceb7b7f960007de8dc5', '63c76dcefd60c7000810a5c2', '6407ff9a85a8cd000847051b', '642e864d6530b60008775fcc','646dcd32356d2100070d16cc','64dd8370c7e60200074f6f6f','65e1b25906f9de00087db009', '67e13ad10265410007f9821a', '6840821e0260200008147e10') and (tr.channel is null or tr.channel = 2 or tr.channel = 3) and tr.transactiontype in ('Sale','Return'`
    * `transactiontype"='Return' THEN COALESCE(-tri."quantity",0) ELSE COALESCE(+tri."quantity",0) END) AS salesItemsCount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(0,0) ELSE COALESCE(+tri."total",0) END) AS sales, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(+tri."total",0) ELSE COALESCE(0,0) END) AS returns, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."discount",0) ELSE COALESCE(+tri."discount",0) END) AS discount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."subtotal",0) ELSE COALESCE(+tri."subtotal",0) END) AS subtotal, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS returnsCount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."tax",0) ELSE COALESCE(+tri."tax",0) END) AS tax, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."cost",0) ELSE COALESCE(+tri."cost",0) END) AS cost, SUM(CASE WHEN tr."transactiontype"='Return'`
    * ... and 6 more variations

---

### **Metric: Discount Amount**
* **Found:** 52 times
* **Common Calculations:**
    * `Discount %`
    * `SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"deleteItemOfNew":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Delete Item from a Saved Open Order' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"deleteItemOfSaved":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Refund' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"refund":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Cancel' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"cancel":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Discount' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"discount":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Re-print/Re-send Receipt' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"reprintReceipt":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'Open/Close Shift' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"openCloseShift":"1"%' THEN 1 ELSE 0 END) AS count FROM "transformations"."mask_businesses__stores" LEFT JOIN "transformations"."mask_businesses" b ON "transformations"."mask_businesses__stores"."businesses_foreignkey" = b."_id" WHERE b.subscriptionstatus = 'Active' AND "transformations"."mask_businesses__stores"."isdeleted" IS NOT TRUE AND {{snippet: Eliminate Internal Accounts}} UNION ALL SELECT 'View/Manage Transactions' AS action_type, SUM(CASE WHEN LOWER("transformations"."mask_businesses__stores"."cashieraccesses") LIKE '%"viewEditTransaction":"1"%' THEN 1 ELSE 0 END)`
    * `SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."quantity",0) ELSE COALESCE(+rti."quantity",0) END) AS salesItemsCount, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(0,0) ELSE COALESCE(+rti."total",0) END) AS sales, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(+rti."total",0) ELSE COALESCE(0,0) END) AS returns, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."discount",0) ELSE COALESCE(+rti."discount",0) END) AS discount, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."subtotal",0) ELSE COALESCE(+rti."subtotal",0) END) AS subtotal, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS returnsCount, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."tax",0) ELSE COALESCE(+rti."tax",0) END) AS tax, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."cost",0) ELSE COALESCE(+rti."cost",0) END) AS cost, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."quantity",0) ELSE COALESCE(+rti."quantity",0) END) AS quantity, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."roundedamount",0) ELSE COALESCE(+rti."roundedamount",0) END) AS rounding, SUM(CASE WHEN rti."transactiontype"='Return' THEN COALESCE(-rti."servicecharge",0) ELSE COALESCE(+rti."servicecharge",0) END) AS serviceCharge FROM report_transaction_items rti WHERE rti.status not in ('pendingPayment','failed','created','paymentCancelled') AND rti.iscancelled is not true AND rti.transactiontype <> 'PreOrder' [[AND (rti.createdtime >= dateadd(hour,0,{{Start_Date}}) and rti.createdtime < dateadd(hour,24,{{End_Date}}))]] [[AND rti.business = {{bo_account_name}}]] GROUP BY rti.storename, "month", rti."parentproduct_title", rti."product_category", rti."skunumber" )`
    * `SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-va."quantity",0) ELSE COALESCE(+va."quantity",0) END) AS variationQuantity, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(0,0) ELSE COALESCE(+rti."total",0) END) AS sales, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(+rti."total",0) ELSE COALESCE(0,0) END) AS returns, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."discount",0) ELSE COALESCE(+rti."discount",0) END) AS discount, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."subtotal",0) ELSE COALESCE(+rti."subtotal",0) END) AS subtotal, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS returnsCount, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."tax",0) ELSE COALESCE(+rti."tax",0) END) AS tax, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."cost",0) ELSE COALESCE(+rti."cost",0) END) AS cost, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."quantity",0) ELSE COALESCE(+rti."quantity",0) END) AS quantity, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."roundedamount",0) ELSE COALESCE(+rti."roundedamount",0) END) AS rounding, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."servicecharge",0) ELSE COALESCE(+rti."servicecharge",0) END) AS serviceCharge FROM report_transaction_items rti JOIN variationvalues va ON va.transactionrecords__items_foreignkey = rti."_id" WHERE rti.status not in ('pendingPayment','failed','created','paymentCancelled') AND rti.iscancelled is not true AND rti.transactiontype <> 'PreOrder' [[AND (rti.createdtime >= dateadd(hour,0,{{Start_Date}}) and rti.createdtime < dateadd(hour,24,{{End_Date}}))]] [[AND rti.business = {{bo_account_name}}]] GROUP BY rti.storename, "month", va."name", va."value" )`
    * `SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."quantity",0) ELSE COALESCE(+tri."quantity",0) END) AS salesItemsCount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(0,0) ELSE COALESCE(+tri."total",0) END) AS sales, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(+tri."total",0) ELSE COALESCE(0,0) END) AS returns, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."discount",0) ELSE COALESCE(+tri."discount",0) END) AS discount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."subtotal",0) ELSE COALESCE(+tri."subtotal",0) END) AS subtotal, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS returnsCount, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."tax",0) ELSE COALESCE(+tri."tax",0) END) AS tax, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."cost",0) ELSE COALESCE(+tri."cost",0) END) AS cost, SUM(CASE WHEN tr."transactiontype"='Return' THEN COALESCE(-tri."quantity",0) ELSE COALESCE(+tri."quantity",0) END) AS quantity FROM storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__items tri on tr._id = tri.transactionrecords_foreignkey WHERE tr.business = {{BO_Account_Name}} [[and (tr.createdtime >= dateadd(hour,0,{{Start_Date}}) and tr.createdtime < dateadd(hour,24,{{End_Date}}))]] [[and tr.storeid = {{Store_id}}]] AND tr.status not in ('pendingPayment','failed','created','paymentCancelled') AND tr.iscancelled is not true AND tr.transactiontype <> 'PreOrder' and tr.total < 10000000 GROUP BY 1,2,3,4,5,6,7 ) select b.employeeid, b.employeename as Name, sum(b.sales + b.tax) as "Actual Sales", sum(b.sales) as "Net Actual Sales", case when sum(b.sales) < 10000 then 'Level 0' when sum(b.sales) < 15000 then 'Level 1' when sum(b.sales) < 20000 then 'Level 2' when sum(b.sales) < 25000 then 'Level 3' when sum(b.sales) < 30000 then 'Level 4' else 'Level 5' end as Level, case when sum(b.sales) < 10000 then null when sum(b.sales) < 15000 then '0.30%' when sum(b.sales) < 20000 then '0.50%' when sum(b.sales) < 25000 then '0.75%' when sum(b.sales) < 30000 then '1.00%' else '1.25%' end as "Commission Rate", case when sum(b.sales) < 10000 then sum(b.sales) when sum(b.sales) < 15000 then sum(b.sales) * 0.003 when sum(b.sales) < 20000 then sum(b.sales) * 0.005 when sum(b.sales) < 25000 then sum(b.sales) * 0.0075 when sum(b.sales) < 30000 then sum(b.sales) * 0.01 else sum(b.sales)`
    * `SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(0,0) ELSE COALESCE(+tr.total,0) END) AS "Total Sales", COUNT(*) AS "Total Transactions", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.discount,0) ELSE COALESCE(+tr.discount,0) END) AS "Total Discount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.tax,0) ELSE COALESCE(+tr.tax,0) END) AS "Tax", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.servicecharge,0) ELSE COALESCE(+tr.servicecharge,0) END) AS "Service Charge", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(+tr.total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.subtotal,0) ELSE COALESCE(+tr.subtotal,0) END) AS "SubTotal", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.roundedamount,0) ELSE COALESCE(+tr.roundedamount,0) END) AS "Rounding", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.cost,0) ELSE COALESCE(+tr.cost,0) END) AS "Total Cost" FROM storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id WHERE tr.business = {{BO_Account_Name}} [[and (tr.createdtime >= dateadd(hour,0,{{Start_Date}}) and tr.createdtime < dateadd(hour,24,{{End_Date}}))]] AND tr.status not in ('pendingPayment','failed','created','paymentCancelled') AND tr.iscancelled is not true AND tr.transactiontype <> 'PreOrder' [[AND tr.storeid = {{Store_id}}]] GROUP BY 1,2,3,4 ORDER BY "Hour" ASC OFFSET 0 ) select tmp."Store Name", tmp."Hour" as "Date / Time", tmp."Total Transactions" as "Transaction", tmp."Net Sales" from ( select b."Store Name" , b."Hour" , b."Transaction Channel" , "Total Sales" , "Total Transactions" , "Total Discount" , COALESCE("Total Discount" / NULLIF("SubTotal",0) *100, 0) AS "Discount %" , "Tax" , "Service Charge" , "Total Sales Returned Count" , "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit" , COALESCE(("Net Sales" - "Total Cost") / NULLIF("Net Sales",0) * 100, 0) AS "Gross Profit %" , COALESCE("Net Sales" / NULLIF("Total Transactions",0), 0) AS "Average Net Sales" , "SubTotal" , "Rounding" from base b order by 2,1,3 )`
    * `SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(0,0) ELSE COALESCE(+tr.total,0) END) AS "Total Sales", COUNT(*) AS "Total Transactions", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.discount,0) ELSE COALESCE(+tr.discount,0) END) AS "Total Discount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.tax,0) ELSE COALESCE(+tr.tax,0) END) AS "Tax", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.shippingfee, 0) ELSE COALESCE(+ tr.shippingfee, 0) END) AS "Shipping Fee", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.servicecharge,0) ELSE COALESCE(+tr.servicecharge,0) END) AS "Service Charge", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(+tr.total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(0, 0) ELSE COALESCE(+ tr.pax, 0) END) AS "Pax", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.subtotal,0) ELSE COALESCE(+tr.subtotal,0) END) AS "SubTotal", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.roundedamount,0) ELSE COALESCE(+tr.roundedamount,0) END) AS "Rounding", SUM(CASE WHEN tr.transactiontype = 'Return' THEN COALESCE(-tr.cost,0) ELSE COALESCE(+tr.cost,0) END) AS "Total Cost" FROM storehub_mongo.transactionrecords tr left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id WHERE tr.business = {{BO_Account_Name}} [[and (tr.createdtime >= dateadd(hour,0,{{Start_Date}}) and tr.createdtime < dateadd(hour,24,{{End_Date}}))]] AND tr.status not in ('pendingPayment','failed','created','paymentCancelled') AND tr.iscancelled is not true AND tr.transactiontype <> 'PreOrder' [[AND tr.storeid = {{Store_id}}]] GROUP BY 1,2,3,4 ORDER BY "month" ASC OFFSET 0 ) select b."Store Name" , b."month" , b."Transaction Channel" , "Total Sales" , "Total Transactions" , "Total Discount" , COALESCE("Total Discount" / NULLIF("SubTotal",0) *100, 0) AS "Discount %" , "Tax" , "Shipping Fee" , "Service Charge" , "Total Sales Returned Count" , "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit" , COALESCE(("Net Sales" - "Total Cost") / NULLIF("Net Sales",0) * 100, 0) AS "Gross Profit %" , COALESCE("Net Sales" / NULLIF("Total Transactions",0), 0)`
    * `SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM report_transactions GROUP BY 1 OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = {{BO_Account_Name}} AND createdtime >= dateadd(hour,-8,date('2021-10-01')) and createdtime < dateadd(hour,-8,date('2022-07-01')) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1 order by 1 offset 0 ) select b."Date" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %" , "Tax", tr."Shipping" as "Shipping Fee", "Service Charge" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" / "Total Transactions" AS "Average Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost")`
    * `SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / nullif("Net Sales" * 100,0) AS "Gross Profit %" , "Net Sales" / nullif("Total Transactions",0)`
    * `SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or tr.channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost") / nullif("Net Sales" * 100,0) AS "Gross Profit %" , "Net Sales" / nullif("Total Transactions",0)`
    * ... and 10 more variations

---

### **Metric: Customer Count**
* **Found:** 42 times
* **Common Calculations:**
    * `count(distinct business)`
    * `customer_count`
    * `total_customers`
    * `unique_customers`

---

### **Metric: Payment Gateway Revenue**
* **Found:** 38 times
* **Common Calculations:**
    * `Gateway Fee" when tmp."Payout reason" in ('cancel','adjustment') then +tmp."Payment Gateway Fee" end) as "Total Payment Gateway Fee" from ( select distinct dateadd(hour,8,t.createdtime) as "Transaction time", dateadd(hour,8,po.bptime) as "Payout time", t.country, t.business, t.subscriptionid, t.receiptnumber as "receipt number", t._id as "transaction id", t.status, case when t.shippingtype in ('dineIn','takeaway') then 'Beep QR' when t.shippingtype in ('delivery','pickup') then 'Beep Delivery' end as beep_channel, t.shippingtype, t.total as "Transaction Amount", po.paymentgateway as "payment gateway", po.cause as "Payout reason", po.amount as "Payout amount", case when trav._id is not null and trav.purchasechannel = 'cleverTapWebhook' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'marketing/%' and trav.remarks not like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - MKT", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'people/%' then trav.value else 0 end as "Voucher payout - People", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'care/%' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks = '' then trav.value when trav._id is not null and trav.purchasechannel = 'systemRefund' then trav.value else 0 end as "Voucher payout - Care", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'product/%' then trav.value else 0 end as "Voucher payout - Product", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - Sold", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks <> '' and (lower(trav.remarks) not like 'product/%' and lower(trav.remarks) not like 'care/%' and lower(trav.remarks) not like 'marketing/%' and lower(trav.remarks) not like 'people/%' and trav.remarks not like '%VBeepGiftVouchers/%') then trav.value when trav._id is not null and trav.purchasechannel = '' then trav.value else 0 end as "Voucher payout - Others", case when trav._id is not null and trav.purchasechannel = 'beep' then trav.value else 0 end as "Merchant Beep Voucher", (case when po.cause = 'sell' then isnull(gr.fee,0) - isnull(pso.paymentgatewaycost,0) else 0 end) as "Payment Gateway Cost", isnull(po.paymentgatewayfee,0) as "Payment Gateway Fee", -("Payment Gateway Fee" - "Payment Gateway Cost") as "Payment Gateway Profit", -(case when po.cause = 'sell' and trdi.courier != 'onfleet' then trdi.deliveryfee else 0 end) as "Logistic Cost (OnFleet excluded)", (case when trdi.courier != 'onfleet' then po.logisticsfee else 0 end) as "Logistic Fee (OnFleet excluded)", -("Logistic Fee (OnFleet excluded)" - "Logistic Cost (OnFleet excluded)") as "Logistic Profit (Onfleet excluded)", -(po.transactionfee) as "Storehub Fee (Transaction Fee)", (case when po.cause = 'sell' then isnull(po.promotionamount,0) else 0 end) as "Storehub Paid Promo Amount", (case when po.cause = 'sell' then isnull(po.refundedamount,0) else 0 end) as "Refunded Amount" from t left join po on po.receiptnumber = t.receiptnumber left join ( select ta._id, ta.voucherid, ta.purchasechannel, vc.remarks, ta.value, ta.transactionrecords_foreignkey, ta.coveredbysh from storehub_mongo.transactionrecords__appliedvoucher ta left join storehub_mongo.vouchers vc on ta.voucherid = vc._id ) trav on trav.transactionrecords_foreignkey = t._id left join storehub_mongo.transactionrecords__deliveryinformation trdi on trdi.transactionrecords_foreignkey = t._id left join ( select * from storehub_mongo.gatewayrecords gr where gr.transactiontype = 'payment' and gr.reconstatus = 'passed' ) gr on gr.receiptnumber = po.receiptnumber left join storehub_mongo.paymentsettlements__orders pso on pso.receiptnumber = t.receiptnumber left join storehub_mongo.transactionrecords__payments trpm on trpm.transactionrecords`
    * `Gateway Fee" when tmp."Payout reason" in ('cancel','adjustment') then +tmp."Payment Gateway Fee" end) as "Total Payment Gateway Fee" from ( select distinct dateadd(hour,8,t.createdtime) as "Transaction time", dateadd(hour,8,po.bptime) as "Payout time", t.country, t.business, t.subscriptionid, t.receiptnumber as "receipt number", t._id as "transaction id", t.status, case when t.shippingtype in ('dineIn','takeaway') then 'Beep QR' when t.shippingtype in ('delivery','pickup') then 'Beep Delivery' end as beep_channel, t.shippingtype, t.total as "Transaction Amount", po.paymentgateway as "payment gateway", po.cause as "Payout reason", po.amount as "Payout amount", case when trav._id is not null and trav.purchasechannel = 'cleverTapWebhook' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'marketing/%' and trav.remarks not like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - MKT", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'people/%' then trav.value else 0 end as "Voucher payout - People", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'care/%' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks = '' then trav.value when trav._id is not null and trav.purchasechannel = 'systemRefund' then trav.value else 0 end as "Voucher payout - Care", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'product/%' then trav.value else 0 end as "Voucher payout - Product", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - Sold", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks <> '' and (lower(trav.remarks) not like 'product/%' and lower(trav.remarks) not like 'care/%' and lower(trav.remarks) not like 'marketing/%' and lower(trav.remarks) not like 'people/%' and trav.remarks not like '%VBeepGiftVouchers/%') then trav.value when trav._id is not null and trav.purchasechannel = '' then trav.value else 0 end as "Voucher payout - Others", case when trav._id is not null and trav.purchasechannel = 'beep' then trav.value else 0 end as "Merchant Beep Voucher", (case when po.cause = 'sell' then isnull(gr.fee,0) - isnull(pso.paymentgatewaycost,0) else 0 end) as "Payment Gateway Cost", isnull(po.paymentgatewayfee,0) as "Payment Gateway Fee", -("Payment Gateway Fee" - "Payment Gateway Cost") as "Payment Gateway Profit", -(po.transactionfee) as "Storehub Fee (Transaction Fee)", (case when po.cause = 'sell' then isnull(po.promotionamount,0) else 0 end) as "Storehub Paid Promo Amount", (case when po.cause = 'sell' then isnull(po.refundedamount,0) else 0 end) as "Refunded Amount" from t left join po on po.receiptnumber = t.receiptnumber left join ( select ta._id, ta.voucherid, ta.purchasechannel, vc.remarks, ta.value, ta.transactionrecords_foreignkey, ta.coveredbysh from storehub_mongo.transactionrecords__appliedvoucher ta left join storehub_mongo.vouchers vc on ta.voucherid = vc._id ) trav on trav.transactionrecords_foreignkey = t._id left join ( select * from storehub_mongo.gatewayrecords gr where gr.transactiontype = 'payment' and gr.reconstatus = 'passed' ) gr on gr.receiptnumber = po.receiptnumber left join storehub_mongo.paymentsettlements__orders pso on pso.receiptnumber = t.receiptnumber left join storehub_mongo.transactionrecords__payments trpm on trpm.transactionrecords`
    * `Gateway Fee", gr.transactionamount as "Gateway payment amount", gr.net as "Gateway Net", gr.transferstatus as "Gateway transfer status", gr.reconstatus as "Gateway Record Recon status", trdi.usestorehublogistics, trdi.deliverydistance as "Actual Distance", ceiling(trdi.deliverydistance) as "Rounded Distance", trdi.ridetypemerchantsetup, trdi.courier, trdi.shippingfee as "Customer paid delivery fee", trdi.deliveryfee as "SH3PL Cost", case when trav.value is not null then trav.value else 0 end as "Voucher value", trav.coveredbysh, case when trav.coveredbysh is not true then 'payout exclude voucher' when trav.coveredbysh is true then 'payout include voucher' else null end as "Voucher Payout", case when trpr.discount is not null then round(trpr.discount * trpr.storehubpaidpercentage, 2) when trip.discount is not null then round(trip.discount * trip.storehubpaidpercentage, 2) else 0 end as "StoreHub bear promo", tr.total as "Transaction total", case when trp.paymentgateway = 'ipay88' and trp.paymentmethod = 'Credit Card MYR' then round(trp.amount * 0.018,2) when trp.paymentgateway = 'ipay88' and trp.paymentmethod != 'Credit Card MYR' then 0.70 when trp.paymentmethod = 'CCPPCreditCard' then round(trp.amount * 0.018,2) when trp.paymentmethod = 'CCPP' then round(trp.amount * 0.018,2) when b.country = 'MY' and tr.channel = 1 and trp.paymentmethod in ('Card Payment', 'Card Payment International', 'Card Payment (International)', 'Credit Card MYR', 'Credit Card (MYR)') then round(trp.amount * 0.018,2) when b.country = 'MY' and tr.channel = 1 and trp.paymentmethod = 'Online Banking' then 0.7 when b.country = 'TH' and tr.channel = 1 and trp.paymentmethod = 'Card Payment' then round(trp.amount * 0.02675,2) when b.country = 'MY' and tr.channel = 1 and trp.paymentmethod = 'GrabPay' then round(trp.amount * 0.015,2) when b.country = 'MY' and tr.channel = 1 and trp.paymentmethod = 'Boost' then round(trp.amount * 0.015,2) when b.country = 'MY' and tr.channel = 1 and trp.paymentmethod = 'Touch&#39;n Go eWallet' then round(trp.amount * 0.015,2) when b.country = 'TH' and tr.channel = 1 and trp.paymentmethod = 'Online Banking' then round(trp.amount * 0.02782,2) when b.country = 'TH' and tr.channel = 1 and trp.paymentmethod = 'LINE Pay' then round(trp.amount * 0.029425,2) when b.country = 'PH' and tr.channel = 1 and trp.paymentmethod = 'Card Payment' then round(trp.amount * 0.037,2) when b.country = 'PH' and tr.channel = 1 and trp.paymentmethod = 'GCash' then round(trp.amount * 0.028,2) when b.country = 'SG' and tr.channel = 1 and trp.paymentmethod = 'Card Payment' then 0 when b.country = 'MY' and tr.channel = 3 and trp.paymentmethod in ('Card Payment', 'Card Payment International', 'Card Payment (International)', 'Credit Card MYR', 'Credit Card (MYR)') and trp.amount * 0.018 < 0.3 then 0.3 when b.country = 'MY' and tr.channel = 3 and trp.paymentmethod in ('Card Payment', 'Card Payment International', 'Card Payment (International)', 'Credit Card MYR', 'Credit Card (MYR)') and trp.amount * 0.018 >= 0.3 then round(trp.amount * 0.018,2) when b.country = 'MY' and tr.channel = 3 and trp.paymentmethod = 'Online Banking' and trp.amount * 0.018 < 0.5 then 0.5 when b.country = 'MY' and tr.channel = 3 and trp.paymentmethod = 'Online Banking' and trp.amount * 0.018 >= 0.5 then round(trp.amount * 0.018,2) when b.country = 'MY' and tr.channel = 3 and trp.paymentmethod = 'GrabPay' then round(trp.amount * 0.015,2) when b.country = 'MY' and tr.channel = 3 and trp.paymentmethod = 'Boost' then round(trp.amount * 0.015,2) when b.country = 'MY' and tr.channel = 3 and trp.paymentmethod = 'Touch&#39;n Go eWallet' then round(trp.amount * 0.015,2) when b.country = 'TH' and tr.channel = 3 and trp.paymentmethod = 'Card Payment' then round(trp.amount * 0.02675,2) when b.country = 'TH' and tr.channel = 3 and trp.paymentmethod = 'Online Banking' then round(trp.amount * 0.02782,2) when b.country = 'TH' and tr.channel = 3 and trp.paymentmethod = 'LINE Pay' then round(trp.amount * 0.029425,2) when b.country = 'PH' and tr.channel = 3 and trp.paymentmethod = 'Card Payment' then round(trp.amount * 0.037,2) when b.country = 'PH' and tr.channel = 3 and trp.paymentmethod = 'GCash' then round(trp.amount * 0.028,2) when b.country = 'SG' and tr.channel = 3 and trp.paymentmethod in ('Card Payment') then round(trp.amount * 0.025+0.20,2) when b.country = 'SG' and tr.channel = 3 and trp.paymentmethod in ('Card Payment International', 'Card Payment (International)', 'Card Payment (AMEX)') then round(trp.amount * 0.035+0.20,2) else 0 end as "Calculated Payment Gateway Charges", pi.paymentgatewayfee as "IST Payment Gateway Fee", case when trdi.courier = 'selfDelivery' then 0 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-01-12' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 5.5) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-01-12' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 8.5) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-01-12' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 8.5) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-01-12' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance <= 5 then 5.5 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-01-12' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance <= 5 then 8.5 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-01-12' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance <= 5 then 8.5 when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 9) when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 12) when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 12) when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance <= 5 then 9 when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance <= 5 then 12 when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19 ' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance <= 5 then 12 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 5.5) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 8.5) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 8.5) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance <= 5 then 5.5 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance <= 5 then 8.5 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-10-19' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance <= 5 then 8.5 when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-06-14' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 9) when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-06-14' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 12) when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-06-14' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 12) when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-06-14' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance <= 5 then 9 when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-06-14' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance <= 5 then 12 when b.country = 'MY' and pi.transactionfeerate < 0.05 and trdi.usestorehublogistics is true and tr.createdtime >= '2020-06-14' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance <= 5 then 12 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime < '2020-10-19' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 9) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime < '2020-10-19' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 12) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime < '2020-10-19' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance > 5 then ("Rounded Distance" - 5 + 12) when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime < '2020-10-19' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance <= 5 then 9 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime < '2020-10-19' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance <= 5 then 12 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime < '2020-10-19' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance <= 5 then 12 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-06-30' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance > 3 then ("Rounded Distance" - 3) * 8 + 49 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-06-30' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance > 1 then ("Rounded Distance") * 20 + 250 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-06-30' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance > 1 then ("Rounded Distance") * 20 + 250 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-06-30' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance <= 3 then 49 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-06-30' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance <= 1 then 270 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-06-30' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance <= 1 then 270 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-03-05' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance > 1 then ("Rounded Distance") * 8 + 60 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-03-05' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance > 1 then ("Rounded Distance") * 25 + 250 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-03-05' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance > 1 then ("Rounded Distance") * 25 + 250 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-03-05' and trdi.ridetypemerchantsetup = 'MOTORCYCLE' and trdi.deliverydistance <= 1 then 68 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-03-05' and trdi.ridetypemerchantsetup = 'CAR' and trdi.deliverydistance <= 1 then 275 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.createdtime >= '2021-03-05' and trdi.ridetypemerchantsetup = '' and trdi.deliverydistance <= 1 then 275 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.expectdeliverydateto is not null and trdi.deliveryfee is null then trdi.shippingfee + 3 when b.country = 'TH' and trdi.usestorehublogistics is true and tr.expectdeliverydateto is not null and trdi.deliveryfee is null then trdi.shippingfee + 25 when b.country = 'PH' and trdi.usestorehublogistics is true and tr.expectdeliverydateto is not null and trdi.deliveryfee is null then trdi.shippingfee + 40 when b.country = 'SG' and trdi.usestorehublogistics is true and tr.expectdeliverydateto is not null and trdi.deliveryfee is null then trdi.shippingfee when trdi.usestorehublogistics is true and trdi.deliveryfee is null then 0 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-04-05' then trdi.deliveryfee + 3 when b.country = 'MY' and trdi.usestorehublogistics is true and tr.createdtime >= '2020-03-25' then trdi.deliveryfee + 2 when b.country = 'MY' and trdi.usestorehublogistics is true then trdi.deliveryfee when b.country = 'TH' and trdi.usestorehublogistics is true then trdi.deliveryfee + 25 when b.country = 'PH' and trdi.usestorehublogistics is true then trdi.deliveryfee + 40 when b.country = 'SG' and trdi.usestorehublogistics is true then trdi.deliveryfee + 0 else 0 end as "Calculated Logistics Fee", pi.logisticsfee as "IST Logistics Fee", case when tr.channel = 1 and (b.country = 'TH' or b.country = 'PH') and tr.createdtime < '2020-06-22' then 0 when tr.channel = 1 then round(tr.total * pi.transactionfeerate,2) when tr.channel = 3 and tr.shippingtype = 'delivery' and tr.createdtime >= '2020-10-19' and trav.coveredbysh is true then round((tr.total - trdi.shippingfee) * pi.transactionfeerate,2) when tr.channel = 3 and tr.shippingtype = 'delivery' and tr.createdtime >= '2020-10-19' then round((trp.amount - trdi.shippingfee) * pi.transactionfeerate,2) when tr.channel = 3 and (tr.shippingtype = 'pickup' or tr.shippingtype = 'dineIn' or tr.shippingtype = 'takeaway') and tr.createdtime >= '2020-10-19' and trav.coveredbysh is true then round(tr.total * pi.transactionfeerate,2) when tr.channel = 3 and (tr.shippingtype = 'pickup' or tr.shippingtype = 'dineIn' or tr.shippingtype = 'takeaway') and tr.createdtime >= '2020-10-19' then round(trp.amount * pi.transactionfeerate,2) else round(tr.total * pi.transactionfeerate,2) end as "Calculated StoreHub Fee", pi.transactionfee as "IST Transaction Fee", case when trav.coveredbysh is true and trp.isonline is true then ("Transaction total" - "Calculated Payment Gateway Charges" - "Calculated Logistics Fee" - "Calculated StoreHub Fee" + "StoreHub bear promo") when trp.isonline is true then ("Transaction total" - "Calculated Payment Gateway Charges" - "Calculated Logistics Fee" - "Calculated StoreHub Fee" - "Voucher value" + "StoreHub bear promo") when trav.coveredbysh is true then (0 - "Calculated StoreHub Fee" - "Calculated Logistics Fee" + "StoreHub bear promo") when trp.isonline is not true then (0 - "Calculated StoreHub Fee" - "Calculated Logistics Fee" - "Voucher value" + "StoreHub bear promo") else null end as "Total Payout Amount", pi.amount as "IST Payout Amount", round(- "IST Payment Gateway Fee" - "Calculated Payment Gateway Charges",2) as "Payment Gateway Fee Recon", round(- "IST Logistics Fee" - "Calculated Logistics Fee",2) as "Logistics Fee Recon", round(- "IST Transaction Fee" - "Calculated StoreHub Fee",2) as "Transaction Fee Recon", round("IST Payout Amount" - "Total Payout Amount",2) as "Payout Recon", pi.reconstatus as "Payout item recon status" from ( select tr._id, tr.receiptnumber, tr.business, dateadd(hour,8,tr.fulfilldate) as fulfilldate, cast(dateadd(hour,8,tr.createdtime) as date) as createdtime, tr.expectdeliverydateto, tr.channel, tr.shippingtype, tr.tableid, tr.iscancelled, tr.isdisbursed, tr.transactiontype, tr.status, tr.total from storehub_mongo.transactionrecords tr where (tr.channel = 1 or tr.channel =3) and tr.iscancelled is not true and tr.transactiontype = 'Sale' and tr."status" <> 'cancelled' AND tr."status" <> 'failed' AND tr."status" <> 'paymentCancelled' AND tr."status" <> 'pendingPayment' AND tr."status" <> 'pendingVerification' AND tr."status" <> 'created' and tr.isdisbursed is not true and ((cast(dateadd(hour,8,tr.fulfilldate) as date) between '2022-01-01' and cast(dateadd(hour,8,{{End_Date}}) as date)) or (tr.shippingtype = 'digital' and (cast(dateadd(hour,8,tr.createdtime) as date) between '2022-01-01' and cast(dateadd(hour,8,{{End_Date}}) as date)))) ) tr inner join ( select b.name, b.country, b.planid from storehub_mongo.businesses b where NOT (lower(b."planid") like '%internal%') [[AND b.country = {{country}}]] [[AND b.name = {{accountName}}]] ) b on b.name = tr.business left join ( select trpr.transactionrecords_foreignkey, trpr.storehubpaidpercentage, case when trpr.discount is not null and trpr.shippingfeediscount is not null then trpr.discount + trpr.shippingfeediscount when trpr.discount is not null then trpr.discount when trpr.shippingfeediscount is not null then trpr.shippingfeediscount else 0 end as discount from storehub_mongo.transactionrecords__promotions trpr where trpr.storehubpaidpercentage is not null and trpr.storehubpaidpercentage != 0 and trpr.data_modified_time > '2022-01-01' ) trpr on trpr.transactionrecords_foreignkey = tr._id left join ( select trip.transactionrecords_foreignkey, trip.storehubpaidpercentage, sum(trip.discount) as "discount" from storehub_mongo.transactionrecords__items__promotions trip where trip.storehubpaidpercentage is not null and trip.storehubpaidpercentage != 0 and trip.data_modified_time > '2022-01-01' group by trip.transactionrecords_foreignkey, trip.storehubpaidpercentage ) trip on trip.transactionrecords_foreignkey = tr._id left join ( select * from storehub_mongo.payoutitems pi where pi.payoutstatus = 'pending' and pi.cause != 'adjustment' ) pi on pi.receiptnumber = tr.receiptnumber left join storehub_mongo.transactionrecords__appliedvoucher trav on trav.transactionrecords_foreignkey = tr._id left join storehub_mongo.gatewayrecords gr on gr.receiptnumber = tr.receiptnumber left join ( select trp.transactionrecords_foreignkey, trp.paymentgateway, trp.paymentmethod, trp.amount, trp.isonline from storehub_mongo.transactionrecords__payments trp where trp.paymentmethod != 'CCPPMPSCB' and trp.paymentmethod != 'cash' and trp.paymentmethod != 'Voucher' and trp.isonline != 'false' ) trp on trp.transactionrecords_foreignkey = tr._id left join ( select trdi.transactionrecords_foreignkey, trdi.deliverydistance, trdi.ridetypemerchantsetup, trdi.shippingfee, trdi.deliveryfee, trdi.usestorehublogistics, trdi.courier from storehub_mongo.transactionrecords__deliveryinformation trdi )trdi on trdi.transactionrecords`
    * `Gateway Record Delay' WHEN pr.status != 'Success' and grr.transactionid is NULL THEN 'Refund Gateway Record Delay' END as delayReason, payoutitems.amount as payoutAmount, pr.provider as paymentProvider, pr.paymentid as providerPaymentId, pr.status as paymentStatus, gpr.transactionid as gatewayPaymentTxnId, gpr.transactionamount as gatewayPaymentAmount, TO_CHAR(gpr.settlementtime, 'YYYY-MM-DD HH24:MI:SS.MSOF') as gatewayPaymentSettletmentTime, grr.transactionid as gatewayRefundTxnId, grr.transactionamount as gatewayRefundAmount, TO_CHAR(grr.settlementtime, 'YYYY-MM-DD HH24:MI:SS.MSOF') as gatewayRefundSettletmentTime from storehub_mongo.payoutitems left join (select paymentrecordid, provider, paymentid, status, receiptnumber, createdat, updatedat from storehub_mongo.paymentrecords) as pr on payoutitems.receiptnumber = pr.receiptnumber and pr.status not in ('Pending', 'Unknown', 'Failed') left join (select paymentrecordid, transactionid, transactionamount, transactiontype, settlementtime from storehub_mongo.gatewayrecords) gpr on pr.paymentrecordid = gpr.paymentrecordid and gpr.transactiontype = 'payment' left join (select paymentrecordid, transactionid, transactionamount, transactiontype, settlementtime from storehub_mongo.gatewayrecords`
    * `Max Revenue`
    * `gateway as "payment gateway", po.cause as "Payout reason", po.amount as "Payout amount", case when trav._id is not null and trav.purchasechannel = 'cleverTapWebhook' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'marketing/%' and trav.remarks not like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - MKT", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'people/%' then trav.value else 0 end as "Voucher payout - People", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'care/%' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks = '' then trav.value when trav._id is not null and trav.purchasechannel = 'systemRefund' then trav.value else 0 end as "Voucher payout - Care", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'product/%' then trav.value else 0 end as "Voucher payout - Product", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - Sold", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks <> '' and (lower(trav.remarks) not like 'product/%' and lower(trav.remarks) not like 'care/%' and lower(trav.remarks) not like 'marketing/%' and lower(trav.remarks) not like 'people/%' and trav.remarks not like '%VBeepGiftVouchers/%') then trav.value when trav._id is not null and trav.purchasechannel = '' then trav.value else 0 end as "Voucher payout - Others", case when trav._id is not null and trav.purchasechannel = 'beep' then trav.value else 0 end as "Merchant Beep Voucher", trav.coveredbysh, (case when po.cause = 'sell' then isnull(gr.fee,0) - isnull(pso.paymentgatewaycost,0) else 0 end) as "Payment Gateway Cost", isnull(po.paymentgatewayfee,0) as "Payment Gateway Fee", -("Payment Gateway Fee" - "Payment Gateway Cost") as "Payment Gateway Profit", (case when po.cause = 'sell' then trdi.shippingfee else 0 end) as "Customer paid delivery fee", -(case when po.cause = 'sell' and trdi.courier != 'onfleet' then trdi.deliveryfee else 0 end) as "Logistic Cost (OnFleet excluded)", (case when trdi.courier != 'onfleet' then po.logisticsfee else 0 end) as "Logistic Fee (OnFleet excluded)", -("Logistic Fee (OnFleet excluded)" - "Logistic Cost (OnFleet excluded)") as "Logistic Profit (Onfleet excluded)", -(po.transactionfee) as "Storehub Fee (Transaction Fee)", (case when trdi.courier = 'onfleet' then po.logisticsfee else 0 end) as "Logistic Fee (OnFleet only)", (case when po.cause = 'sell' then isnull(po.promotionamount,0) else 0 end) as "Storehub Paid Promo Amount", (case when po.cause = 'sell' then isnull(po.refundedamount,0) else 0 end) as "Refunded Amount", (case when po.cause = 'sell' then po.pickupsmsfee else 0 end) as "pick up sms fee" from txn left join po on po.receiptnumber = txn.receiptnumber left join ( select ta._id, ta.voucherid, ta.purchasechannel, vc.remarks, ta.value, ta.transactionrecords_foreignkey, ta.coveredbysh from storehub_mongo.transactionrecords__appliedvoucher ta left join storehub_mongo.vouchers vc on ta.voucherid = vc._id ) trav on trav.transactionrecords_foreignkey = txn._id left join storehub_mongo.transactionrecords__deliveryinformation trdi on trdi.transactionrecords_foreignkey = txn._id left join ( select * from storehub_mongo.gatewayrecords gr where gr.transactiontype = 'payment' and gr.reconstatus = 'passed' ) gr on gr.receiptnumber = po.receiptnumber left join storehub_mongo.paymentsettlements__orders pso on pso.receiptnumber = txn.receiptnumber left join storehub_mongo.transactionrecords__payments trpm on trpm.transactionrecords`
    * `gateway as "payment gateway", po.cause as "Payout reason", po.amount as "Payout amount", case when trav._id is not null and trav.purchasechannel = 'cleverTapWebhook' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'marketing/%' and trav.remarks not like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - MKT", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'people/%' then trav.value else 0 end as "Voucher payout - People", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'care/%' then trav.value when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks = '' then trav.value when trav._id is not null and trav.purchasechannel = 'systemRefund' then trav.value else 0 end as "Voucher payout - Care", case when trav._id is not null and trav.purchasechannel = 'ist' and lower(trav.remarks) like 'product/%' then trav.value else 0 end as "Voucher payout - Product", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks like '%VBeepGiftVouchers/%' then trav.value else 0 end as "Voucher payout - Sold", case when trav._id is not null and trav.purchasechannel = 'ist' and trav.remarks <> '' and (lower(trav.remarks) not like 'product/%' and lower(trav.remarks) not like 'care/%' and lower(trav.remarks) not like 'marketing/%' and lower(trav.remarks) not like 'people/%' and trav.remarks not like '%VBeepGiftVouchers/%') then trav.value when trav._id is not null and trav.purchasechannel = '' then trav.value else 0 end as "Voucher payout - Others", case when trav._id is not null and trav.purchasechannel = 'beep' then trav.value else 0 end as "Merchant Beep Voucher", trav.coveredbysh, (case when po.cause = 'sell' then isnull(gr.fee,0) - isnull(pso.paymentgatewaycost,0) else 0 end) as "Payment Gateway Cost", isnull(po.paymentgatewayfee,0) as "Payment Gateway Fee", -("Payment Gateway Fee" - "Payment Gateway Cost") as "Payment Gateway Profit", (case when po.cause = 'sell' then trdi.shippingfee else 0 end) as "Customer paid delivery fee", -(case when po.cause = 'sell' and trdi.courier != 'onfleet' then trdi.deliveryfee else 0 end) as "Logistic Cost (OnFleet excluded)", (case when trdi.courier != 'onfleet' then po.logisticsfee else 0 end) as "Logistic Fee (OnFleet excluded)", -("Logistic Fee (OnFleet excluded)" - "Logistic Cost (OnFleet excluded)") as "Logistic Profit (Onfleet excluded)", -(po.transactionfee) as "Storehub Fee (Transaction Fee)", (case when trdi.courier = 'onfleet' then po.logisticsfee else 0 end) as "Logistic Fee (OnFleet only)", (case when po.cause = 'sell' then isnull(po.promotionamount,0) else 0 end) as "Storehub Paid Promo Amount", (case when po.cause = 'sell' then isnull(po.refundedamount,0) else 0 end) as "Refunded Amount", (case when po.cause = 'sell' then po.pickupsmsfee else 0 end) as "pick up sms fee", einv.companyname, einv.phone, einv.email, einv.country, einv.countrycode, einv.state, einv.statecode, einv.city, einv.postalcode, einv.street1, einv.street2, einv.tin, einv.sstid, einv.brn, einv.individualidtype, einv.individualidvalue, einv.industry, einv.msiccode, einv.msicdescription from txn left join po on po.receiptnumber = txn.receiptnumber left join ( select ta._id, ta.voucherid, ta.purchasechannel, vc.remarks, ta.value, ta.transactionrecords_foreignkey, ta.coveredbysh from storehub_mongo.transactionrecords__appliedvoucher ta left join storehub_mongo.vouchers vc on ta.voucherid = vc._id ) trav on trav.transactionrecords_foreignkey = txn._id left join storehub_mongo.transactionrecords__deliveryinformation trdi on trdi.transactionrecords_foreignkey = txn._id left join ( select * from storehub_mongo.gatewayrecords gr where gr.transactiontype = 'payment' and gr.reconstatus = 'passed' ) gr on gr.receiptnumber = po.receiptnumber left join storehub_mongo.paymentsettlements__orders pso on pso.receiptnumber = txn.receiptnumber left join storehub_mongo.transactionrecords__payments trpm on trpm.transactionrecords`
    * `gateway, gr.transactionid as "Payment Gateway ID", tr.isdisbursed, rd.discrepancytype, rdlg.transactiontype as "Gateway record type", rdlg.transactionamount as "Gateway amount", rdlp.payouttype as "Payout type", rdlp.paidamount as "Payout amount", rdlp.settledat FROM "storehub_mongo"."recondiscrepancies" rd left join ( select * from storehub_mongo.transactionrecords tr where tr.createdtime > CAST((getdate() + INTERVAL '-90 day') AS date) ) tr on tr.receiptnumber = rd.receiptnumber left join storehub_mongo.businesses on storehub_mongo.businesses.name = tr.business left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.gatewayrecords gr on gr.receiptnumber = rd.receiptnumber left join storehub_mongo.recondiscrepancies__logs rdl on rdl.recondiscrepancies_foreignkey = rd._id left join storehub_mongo.recondiscrepancies__logs__gatewayrecords`
    * `gateway, trp.paymentmethod, count(distinct payoutitems.receiptnumber) AS "# of txn", sum(case when gr._id is not null and payoutitems.reconstatus = 'pending' then 1 else 0 end) as "Total need recon", sum(case when gr._id is null then 1 else 0 end) as "Total no gateway records", sum(case when rd.discrepancytype = 'pgw_pay_missing' then 1 else 0 end) as "Total pgw_pay_missing", sum("storehub_mongo"."payoutitems"."amount") AS "sum" FROM ( select * from "storehub_mongo"."payoutitems" WHERE "storehub_mongo"."payoutitems"."payoutstatus" = 'pending' AND "storehub_mongo"."payoutitems"."reconstatus" = 'pending' and storehub_mongo.payoutitems.cause = 'sell' [[and {{country}}]] [[AND cast(dateadd(hour,8,"storehub_mongo"."payoutitems"."settledat") as date) <= cast(dateadd(hour,8,{{cutoffdate}}) as date)]] ) payoutitems left join ( select * from storehub_mongo.recondiscrepancies rd where rd.discrepancytype = 'pgw_pay_missing' and rd.isresolved is false ) rd on rd.receiptnumber = storehub_mongo.payoutitems.receiptnumber left join ( select * from storehub_mongo.gatewayrecords gr where gr.transactiontype = 'payment' ) gr on gr.receiptnumber = storehub_mongo.payoutitems.receiptnumber inner join ( select * from storehub_mongo.transactionrecords tr ) tr on tr.receiptnumber = storehub_mongo.payoutitems.receiptnumber left join ( select * from storehub_mongo.transactionrecords__payments trp where trp.paymentmethod != 'Voucher' ) trp on trp.transactionrecords`
    * `gateway, trp.paymentmethod, count(distinct payoutitems.receiptnumber) AS "# of txn", sum(case when gr._id is not null and payoutitems.reconstatus = 'pending' then 1 else 0 end) as "Total need recon", sum(case when gr._id is null then 1 else 0 end) as "Total no gateway records", sum(case when rd.discrepancytype = 'pgw_refund_missing' then 1 else 0 end) as "Total pgw_refund_missing", sum("storehub_mongo"."payoutitems"."amount") AS "sum" FROM ( select * from "storehub_mongo"."payoutitems" WHERE "storehub_mongo"."payoutitems"."payoutstatus" = 'pending' AND "storehub_mongo"."payoutitems"."reconstatus" = 'pending' and storehub_mongo.payoutitems.cause = 'cancel' [[and {{country}}]] [[AND cast(dateadd(hour,8,"storehub_mongo"."payoutitems"."settledat") as date) <= cast(dateadd(hour,8,{{cutoffdate}}) as date)]] ) payoutitems left join ( select * from storehub_mongo.recondiscrepancies rd where rd.discrepancytype = 'pgw_refund_missing' and rd.isresolved is false ) rd on rd.receiptnumber = storehub_mongo.payoutitems.receiptnumber left join ( select * from storehub_mongo.gatewayrecords gr where gr.transactiontype = 'refund' ) gr on gr.receiptnumber = storehub_mongo.payoutitems.receiptnumber inner join ( select * from storehub_mongo.transactionrecords tr where tr.createdtime > CAST((getdate() + INTERVAL '-180 day') AS date) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') ) tr on tr.receiptnumber = storehub_mongo.payoutitems.receiptnumber left join ( select * from storehub_mongo.transactionrecords__payments trp where trp.paymentmethod != 'Voucher' ) trp on trp.transactionrecords`
    * ... and 19 more variations

---

### **Metric: Shipping Fees**
* **Found:** 32 times
* **Common Calculations:**
    * `Delivery' when displaychannel = 10 then 'GrabFood' when displaychannel = 11 then 'ShopeeFood' when displaychannel = 12 then 'FoodPanda' when displaychannel = 100 then 'Lazada' when displaychannel = 101 then 'Shopee' when displaychannel = 102 then 'Zalora' when displaychannel = 103 then 'WooCommerce' when displaychannel = 104 then 'Shopify' when displaychannel = 105 then 'TikTok Shop' end AS "Transaction Channel" ,storeid AS "Store ID" ,storename AS "Store Name" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost`
    * `Delivery' when displaychannel = 10 then 'GrabFood' when displaychannel = 11 then 'ShopeeFood' when displaychannel = 12 then 'FoodPanda' when displaychannel = 100 then 'Lazada' when displaychannel = 101 then 'Shopee' when displaychannel = 102 then 'Zalora' when displaychannel = 103 then 'WooCommerce' when displaychannel = 104 then 'Shopify' when displaychannel = 105 then 'TikTok Shop' end AS "Transaction Channel" ,storeid AS "Store ID" ,storename AS "Store Name" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or tr.channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost`
    * `Delivery' when displaychannel = 10 then 'GrabFood' when displaychannel = 11 then 'ShopeeFood' when displaychannel = 12 then 'FoodPanda' when displaychannel = 100 then 'Lazada' when displaychannel = 101 then 'Shopee' when displaychannel = 102 then 'Zalora' when displaychannel = 103 then 'WooCommerce' when displaychannel = 104 then 'Shopify' when displaychannel = 105 then 'TikTok Shop' end AS "Transaction Channel" ,storeid AS "Store ID" ,storename AS "Store Name" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when channel is NULL then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost`
    * `Delivery' when displaychannel = 10 then 'GrabFood' when displaychannel = 11 then 'ShopeeFood' when displaychannel = 12 then 'FoodPanda' when displaychannel = 100 then 'Lazada' when displaychannel = 101 then 'Shopee' when displaychannel = 102 then 'Zalora' when displaychannel = 103 then 'WooCommerce' when displaychannel = 104 then 'Shopify' when displaychannel = 105 then 'TikTok Shop' end AS "Transaction Channel" ,storeid AS "Store ID" ,storename AS "Store Name" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = {{BO_Account_Name}} AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = {{BO_Account_Name}} AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1,2,3 order by 1 offset 0 ) select b."Date" , b."Store Name" , b."Transaction Channel" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %", "Tax", "Service Charge" , "Total Sales Returned Count", "Total Sales Returned Amount" , "Total Sales" - "Tax" - "Service Charge" - "Rounding" - "Total Sales Returned Amount" AS "Net Sales" , "Net Sales" - "Total Cost" AS "Gross Profit", ("Net Sales" - "Total Cost`
    * `Shipping Fee`
    * `delivery fee", -(case when po.cause = 'sell' and trdi.courier != 'onfleet' then trdi.deliveryfee else 0 end) as "Logistic Cost (OnFleet excluded)", (case when trdi.courier != 'onfleet' then po.logisticsfee else 0 end) as "Logistic Fee (OnFleet excluded)", -("Logistic Fee (OnFleet excluded)" - "Logistic Cost`
    * `delivery fee", -sum(case when trdi.courier != 'onfleet' then trdi.deliveryfee else 0 end) as "Total Logistic Cost (OnFleet excluded)", sum(case when trdi.courier != 'onfleet' then pi.logisticsfee else 0 end) as "Total Logistic Fee (OnFleet excluded)", -("Total Logistic Fee (OnFleet excluded)" - "Total Logistic Cost`
    * `delivery' then 'Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' when tr.channel = 3 and tr.shippingtype = 'digital' then 'Voucher' else null end as "Channel", case when tr.expectdeliverydateto > '2000-01-01' then 'Pre-order' else null end as "Pre-order", trdi.usestorehublogistics, trdi.deliverydistance as "Actual Distance", ceiling(trdi.deliverydistance) as "Rounded Distance", trdi.ridetypemerchantsetup, trdi.courier, trdi.shippingfee as "Customer paid delivery fee", trdi.deliveryfee as "SH3PL Cost`
    * `delivery' then 'Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' when tr.channel = 3 and tr.shippingtype = 'digital' then 'Voucher' else null end as "Channel", case when tr.expectdeliverydateto > '2000-01-01' then 'Pre-order' else null end as "Pre-order", trp.paymentmethod, trp.isonline, trp.amount as "Payment Amount", gr.fee as "Gateway Fee", gr.transactionamount as "Gateway payment amount", gr.net as "Gateway Net", gr.transferstatus as "Gateway transfer status", gr.reconstatus as "Gateway Record Recon status", trdi.usestorehublogistics, trdi.deliverydistance as "Actual Distance", ceiling(trdi.deliverydistance) as "Rounded Distance", trdi.ridetypemerchantsetup, trdi.courier, trdi.shippingfee as "Customer paid delivery fee", trdi.deliveryfee as "SH3PL Cost`
    * `delivery' then 'Beep Delivery' when tr.channel = 3 and tr.shippingtype = 'pickup' then 'Beep Pick Up' when tr.channel = 3 and tr.shippingtype = 'dineIn' then 'Beep In Store' when tr.channel = 3 and tr.shippingtype = 'takeaway' then 'Beep Takeaway' when tr.channel = 3 and tr.shippingtype = 'digital' then 'Voucher' else null end as "Channel", sum(case when pi.cause = 'sell' then tr.total else 0 end) as "Total Transaction Amount", sum(pi.amount) as "Total Payout", sum(case when trav.purchasechannel = 'beep' then 0 when trav._id is not null and pi.cause = 'sell' then trav.value else 0 end) as "Total voucher payout", sum(isnull(gr.fee,0)) - sum(isnull(pso.paymentgatewaycost,0)) as "Total Payment Gateway Cost", sum(isnull(pi.paymentgatewayfee,0)) as "Total Payment Gateway Fee", -("Total Payment Gateway Fee" - "Total Payment Gateway Cost") as "Payment Gateway Revenue", sum(trdi.shippingfee) as "Total Customer paid delivery fee", -sum(trdi.deliveryfee) as "Total Logistic Cost", sum(pi.logisticsfee) as "Total Logistic Fee", -("Total Logistic Fee" - "Total Logistic Cost`
    * ... and 14 more variations

---

### **Metric: Average Order Value**
* **Found:** 31 times
* **Common Calculations:**
    * `AOV`
    * `Average Cost" , COALESCE("Item Net Sales" / NULLIF(t."count",0), 0) AS "Average Net Sales" , "Item Net Sales" - t.cost AS "Gross Profit" , COALESCE(("Item Net Sales" - t.cost) / NULLIF("Item Net Sales",0) * 100, 0) AS "Gross Profit %" from ( SELECT rti.storename, date_trunc('month',cast(dateadd(hour,8,rti.createdtime) as date)) AS "month", COUNT(rti."*") AS "count", va."name" AS variation_name, va."value" AS variation_value, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-va."quantity",0) ELSE COALESCE(+va."quantity",0) END) AS variationQuantity, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(0,0) ELSE COALESCE(+rti."total",0) END) AS sales, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(+rti."total",0) ELSE COALESCE(0,0) END) AS returns, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."discount",0) ELSE COALESCE(+rti."discount",0) END) AS discount, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."subtotal",0) ELSE COALESCE(+rti."subtotal",0) END) AS subtotal, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS returnsCount, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."tax",0) ELSE COALESCE(+rti."tax",0) END) AS tax, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."cost",0) ELSE COALESCE(+rti."cost",0) END) AS cost, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."quantity",0) ELSE COALESCE(+rti."quantity",0) END) AS quantity, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."roundedamount",0) ELSE COALESCE(+rti."roundedamount",0) END) AS rounding, SUM(CASE WHEN rti.transactiontype = 'Return' THEN COALESCE(-rti."servicecharge",0) ELSE COALESCE(+rti."servicecharge",0) END) AS serviceCharge FROM report_transaction_items rti JOIN variationvalues va ON va.transactionrecords__items_foreignkey = rti."_id" WHERE rti.status not in ('pendingPayment','failed','created','paymentCancelled') AND rti.iscancelled is not true AND rti.transactiontype <> 'PreOrder' [[AND (rti.createdtime >= dateadd(hour,0,{{Start_Date}}) and rti.createdtime < dateadd(hour,24,{{End_Date}}))]] [[AND rti.business = {{bo_account_name}}]] GROUP BY rti.storename, "month", va."name", va."value`
    * `Average Net Sales`
    * `AverageTransactionValue, SUM(FT.total) AS TotalQRPhGMV FROM FilteredTransactions FT INNER JOIN "storehub_mongo"."transactionrecords__payments" TRP ON FT._id = TRP.transactionrecords_foreignkey INNER JOIN storehub_mongo.businesses b ON b.name = FT.business INNER JOIN QRPhPaymentOptions PO ON b._id = PO.businesses_foreignkey AND TRP.paymentmethod = PO.paymentid WHERE b.country = 'PH' [[AND b."name" = {{accountname}}]] AND {{snippet: Eliminate Internal Accounts}} GROUP BY FT.business ) SELECT CASE WHEN AverageTransactionValue BETWEEN 0 AND 100 THEN '0 - 100' WHEN AverageTransactionValue BETWEEN 100.01 AND 200 THEN '100.01 - 200' WHEN AverageTransactionValue BETWEEN 200.01 AND 300 THEN '200.01 - 300' WHEN AverageTransactionValue BETWEEN 300.01 AND 400 THEN '300.01 - 400' WHEN AverageTransactionValue BETWEEN 400.01 AND 500 THEN '400.01 - 500' WHEN AverageTransactionValue BETWEEN 500.01 AND 600 THEN '500.01 - 600' WHEN AverageTransactionValue BETWEEN 600.01 AND 700 THEN '600.01 - 700' WHEN AverageTransactionValue BETWEEN 700.01 AND 800 THEN '700.01 - 800' WHEN AverageTransactionValue BETWEEN 800.01 AND 900 THEN '800.01 - 900' WHEN AverageTransactionValue BETWEEN 900.01 AND 1000 THEN '900.01 - 1000' WHEN AverageTransactionValue >= 1000.01 THEN '1000.01 and above' END AS "Average Transaction Value Tier", SUM(TotalQRPhGMV) AS "Total GMV Volume", COUNT(*) AS "Number of Merchants" FROM MerchantMetrics GROUP BY "Average Transaction Value Tier" ORDER BY MIN(AverageTransactionValue`
    * `aov`

---

### **Metric: Service Charge**
* **Found:** 30 times
* **Common Calculations:**
    * `Service Charge`
    * `servicecharge, CASE WHEN version = 1 THEN revenue ELSE total END AS total, tax, subtotal, cost, CASE WHEN version = 1 THEN (discount - shippingfeediscount) ELSE discount END AS discount, roundedamount, transactiontype, status, iscancelled, createdtime, pax from storehub_mongo.transactionrecords tr where tr.business = {{BO_Account_Name}} AND tr.createdtime >= dateadd(hour,-8,date('2022-10-01')) and createdtime < dateadd(hour,-8,date('2023-07-01')) AND tr.status not in ('pendingPayment','failed','created','paymentCancelled') AND tr.iscancelled is not true AND tr.transactiontype <> 'PreOrder' ) , base as ( SELECT date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) AS "Date" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(0,0) ELSE COALESCE(+total,0) END) AS "Total Sales" ,COUNT(*) AS "Total Transactions" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-discount,0) ELSE COALESCE(+discount,0) END) AS "Total Discount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-tax,0) ELSE COALESCE(+tax,0) END) AS "Tax" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM report_transactions GROUP BY 1 OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfeediscount from storehub_mongo.transactionrecords tr where business = {{BO_Account_Name}} AND createdtime >= dateadd(hour,-8,date('2021-10-01')) and createdtime < dateadd(hour,-8,date('2022-07-01')) AND transactiontype <> 'PreOrder' and paymentmethod = 'Online' AND status not in ('pendingPayment','failed','created','paymentCancelled') and iscancelled is not true group by 1 order by 1 offset 0 ) select b."Date" , "Total Sales", "Total Transactions", "Total Discount", "Total Discount"/"SubTotal"*100 AS "Discount %" , "Tax", tr."Shipping" as "Shipping Fee`
    * `servicecharge, tr.total, tr.tax, tr.roundedamount, tr.shippingfee, tr.employeenumber, tr.customerid, tr.consumerid, tr._id order_id, tr.paymentmethod, case when bpo.name <> '' then bpo.name else trp.paymentmethod end as payment_method, trp.amount, tr.transactionid from storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__paymentoptions bpo on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod) left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id where (tr.channel is null or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel = 10 or tr.channel = 11 or tr.channel = 12) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and b.country = 'MY' and tr.business = 'moltenchocolatecafe' [[and tr.createdtime >= {{Start_Date}} and tr.createdtime < {{End_Date}}]] ) select s.bo_account_name, s.storename, s.txn_createdtime, s.receiptnumber, s.transactionid, s.status, s.iscancelled, s.transaction_channel, s.shippingtype, s.transactiontype, case when s.transaction_channel = 'FoodPanda' then 'FoodPanda customer' when s.transaction_channel = 'GrabFood' then 'GrabFood customer' when s.transaction_channel = 'ShopeeFood' then 'ShopeeFood customer' else concat(c.firstname, concat(' ', c.lastname)) end as customer_name, concat(e.firstname, concat(' ', e.lastname)) as employee_name, s.subtotal, s.tax, s.servicecharge, s.subtotal + s.tax + s.servicecharge as gross_sales, s.discount, s.shippingfee`
    * `servicecharge, tr.total, tr.tax, tr.roundedamount, tr.shippingfee, tr.employeenumber, tr.customerid, tr.consumerid, tr._id order_id, tr.paymentmethod, case when bpo.name <> '' then bpo.name else trp.paymentmethod end as payment_method, trp.amount, tr.transactionid from storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__paymentoptions bpo on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod) left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id where (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel = 10 or tr.channel = 11 or tr.channel = 12) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(hour,-8,'2021-05-13') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and b.country = 'MY' and tr.business = 'moltenchocolatecafe' and tr.createdtime >= dateadd(hour,-8,cast(getdate()-1 as date)) and tr.createdtime < dateadd(hour,-8,cast(getdate() as date)) ) select s.bo_account_name, s.storename, s.txn_createdtime, s.receiptnumber, s.transactionid, s.status, s.iscancelled, s.transaction_channel, s.shippingtype, s.transactiontype, case when s.transaction_channel = 'FoodPanda' then 'FoodPanda customer' when s.transaction_channel = 'GrabFood' then 'GrabFood customer' when s.transaction_channel = 'ShopeeFood' then 'ShopeeFood customer' else concat(c.firstname, concat(' ', c.lastname)) end as customer_name, concat(e.firstname, concat(' ', e.lastname)) as employee_name, s.subtotal, s.tax, s.servicecharge, s.subtotal + s.tax + s.servicecharge as gross_sales, s.discount, s.shippingfee`
    * `servicecharge, tr.total, tr.tax, tr.roundedamount, tr.shippingfee, tr.employeenumber, tr.customerid, tr.consumerid, tr._id order_id, tr.paymentmethod, case when bpo.name <> '' then bpo.name else trp.paymentmethod end as payment_method, trp.amount, tr.transactionid from storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__paymentoptions bpo on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod) left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id where (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel in (1,10,11, 12)) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and b.country = 'MY' [[and tr.business = {{bo_account_name}}]] [[and (tr.createdtime >= dateadd(hour,0,{{Start_Date}}) and tr.createdtime < dateadd(hour,24,{{End_Date}}))]] ) select s.bo_account_name, s.storename, s.txn_createdtime, s.receiptnumber, s.status, s.iscancelled, s.transaction_channel, s.shippingtype, s.transactiontype, concat(e.firstname, concat(' ', e.lastname)) as employee_name, s.subtotal, s.tax, s.servicecharge, s.discount, s.shippingfee`
    * `servicecharge, tr.total, tr.tax, tr.roundedamount, tr.shippingfee, tr.employeenumber, tr.customerid, tr.consumerid, tr._id order_id, tr.paymentmethod, case when bpo.name <> '' then bpo.name else trp.paymentmethod end as payment_method, trp.amount, tr.transactionid from storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__paymentoptions bpo on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod) left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id where (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel in (1,10,11, 12)) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(hour,-8,'2022-01-01') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and b.country = 'TH' and (tr.createdtime >= dateadd(hour,-8,date'2024-03-03') and tr.createdtime < dateadd(hour,-8,date'2024-03-04')) [[and tr.business = {{bo_account_name}}]] ) select s.bo_account_name, s.storename, s.txn_createdtime, s.receiptnumber, s.status, s.iscancelled, s.transaction_channel, s.shippingtype, s.transactiontype, concat(e.firstname, concat(' ', e.lastname)) as employee_name, s.subtotal, s.tax, s.servicecharge, s.discount, s.shippingfee`
    * `servicecharge, tr.total, tr.tax, tr.roundedamount, tr.shippingfee, tr.employeenumber, tr.customerid, tr.consumerid, tr._id order_id, tr.paymentmethod, case when bpo.name <> '' then bpo.name else trp.paymentmethod end as payment_method, trp.amount, tr.transactionid from storehub_mongo.transactionrecords tr left join storehub_mongo.transactionrecords__payments trp on trp.transactionrecords_foreignkey = tr._id left join storehub_mongo.businesses b on b.name = tr.business left join storehub_mongo.businesses__paymentoptions bpo on (bpo.businesses_foreignkey = b._id and bpo.paymentid = trp.paymentmethod) left join storehub_mongo.businesses__stores bs on tr.storeid = bs._id where (tr.channel is null or tr.channel = 2 or (tr.channel = 3 and tr.shippingtype in ('delivery','pickup','dineIn','takeaway')) or tr.channel in (1,10,11, 12)) and tr.status not in ('created', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification') and tr.createdtime >= dateadd(hour,-8,'2024-01-01') and CHARINDEX('internal', b.planid) = 0 and CHARINDEX('@storehub.com', b.email) = 0 and b.country = 'TH' [[and (tr.createdtime >= dateadd(hour,0,{{Start_Date}}) and tr.createdtime < dateadd(hour,24,{{End_Date}}))]] [[and tr.business = {{bo_account_name}}]] ) select s.bo_account_name, s.storename, s.txn_createdtime, s.receiptnumber, s.status, s.iscancelled, s.transaction_channel, s.shippingtype, s.transactiontype, REGEXP_REPLACE (REGEXP_REPLACE (concat(e.firstname, concat(' ', e.lastname)), '&#39;', ''''), '%7C;', ' - ') as employee_name, s.subtotal, s.tax, s.servicecharge, s.discount, s.shippingfee`
    * `servicecharge, tr.total, tr.tax, tr.subtotal, tr.cost, tr.discount, CASE WHEN (tr.channel is null or tr.channel = 2) THEN 0 ELSE tr.channel END AS channel, tr.roundedamount, tr.paymentmethod, tr.employeenumber, tr.transactiontype, tr.status, tr.iscancelled, tr.createdtime, tr.modifiedtime, tr.customerid, tr.pax, tr.data_modified_time as real_data_modified_time, tr.shippingtype, CASE WHEN (tr.channel is null or tr.channel = 2) THEN 0 WHEN tr.channel = 3 and tr.shippingtype in ('dineIn', 'takeaway') THEN 98 WHEN tr.channel = 3 and tr.shippingtype in ('delivery', 'pickup') THEN 99 ELSE tr.channel END AS displaychannel, 0.00 AS shippingfee`
    * `servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfee`
    * `servicecharge,0) ELSE COALESCE(+servicecharge,0) END) AS "Service Charge" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(1,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Count" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(+total,0) ELSE COALESCE(0,0) END) AS "Total Sales Returned Amount" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-subtotal,0) ELSE COALESCE(+subtotal,0) END) AS "SubTotal" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-roundedamount,0) ELSE COALESCE(+roundedamount,0) END) AS "Rounding" ,SUM(CASE WHEN transactiontype='Return' THEN COALESCE(-cost,0) ELSE COALESCE(+cost,0) END) AS "Total Cost" FROM transformations.report_transactions WHERE business = 'saba' AND createdtime BETWEEN dateadd(day,-1,dateadd(hour,-8,current_date)) and dateadd(day,-1,dateadd(hour,16,current_date)) AND status not in ('pendingPayment','failed','created','paymentCancelled') AND iscancelled is not true AND transactiontype <> 'PreOrder' GROUP BY 1,2,3,4 ORDER BY "Transaction Channel" ASC OFFSET 0 ) , transaction as ( select date_trunc('day',cast(dateadd(hour,8,createdtime) as date)) "Date" , case when (channel is NULL or tr.channel = 2) then 'Offline' when channel = 1 then 'Ecommerce' when channel = 3 and shippingtype in ('dineIn', 'takeaway') then 'Beep QR' when channel = 3 and shippingtype in ('delivery', 'pickup') then 'Beep Delivery' when channel = 10 then 'GrabFood' when channel = 11 then 'ShopeeFood' when channel = 12 then 'FoodPanda' when channel = 100 then 'Lazada' when channel = 101 then 'Shopee' when channel = 102 then 'Zalora' when channel = 103 then 'WooCommerce' when channel = 104 then 'Shopify' when channel = 105 then 'TikTok Shop' end AS "Transaction Channel" , storeid AS "Store ID" , sum(shippingfee) "Shipping" , sum(shippingfeediscount) shippingfee`
    * ... and 4 more variations

---

### **Metric: Gross Profit**
* **Found:** 18 times
* **Common Calculations:**
    * `Gross Profit`

---

### **Metric: Conversion Rate**
* **Found:** 6 times
* **Common Calculations:**
    * `claim_count , count (distinct t._id) txn_count , claim_count::float*100/txn_count claim_rate FROM storehub_mongo.businesses b INNER JOIN storehub_mongo.transactionrecords t ON t.business = b.name AND t.iscancelled is not true AND t.transactiontype = 'Sale' AND t.status NOT IN ('cancelled', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification', 'created') AND t.createdtime::date BETWEEN getdate()::date - 30 AND getdate()::date - 1 AND t.createdtime::date >= b.lastenablecashbackdate::date AND b.planid not like '%internal%' AND b.subscriptionstatus = 'Active' AND b.country = 'MY' AND b.enablecashback LEFT JOIN storehub_mongo.loyaltychangelogs l ON l.business = t.business AND l.receiptnumber = t.receiptnumber AND l.rewardtype = 'cashback' AND l.eventtype = 'earned' AND l.eventtime::date BETWEEN getdate()::date - 30 AND getdate()::date - 1 GROUP BY 1,2 ) SELECT CASE WHEN claim_rate < 0.5 THEN '0.00 %' WHEN claim_rate < 10.00 THEN '<10.00%' WHEN claim_rate < 20.00 THEN '<20.00%' ELSE '>=20.00%' END claim_rate`
    * `claim_count , count (distinct t._id) txn_count , claim_count::float*100/txn_count claim_rate FROM storehub_mongo.businesses b INNER JOIN storehub_mongo.transactionrecords t ON t.business = b.name AND t.iscancelled is not true AND t.transactiontype = 'Sale' AND t.status NOT IN ('cancelled', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification', 'created') AND t.createdtime::date BETWEEN getdate()::date - 30 AND getdate()::date - 1 AND t.createdtime::date >= b.lastenablecashbackdate::date AND b.planid not like '%internal%' AND b.subscriptionstatus = 'Active' AND b.country = 'PH' AND b.enablecashback LEFT JOIN storehub_mongo.loyaltychangelogs l ON l.business = t.business AND l.receiptnumber = t.receiptnumber AND l.rewardtype = 'cashback' AND l.eventtype = 'earned' AND l.eventtime::date BETWEEN getdate()::date - 30 AND getdate()::date - 1 GROUP BY 1,2 ) SELECT CASE WHEN claim_rate < 0.5 THEN '0.00 %' WHEN claim_rate < 10.00 THEN '<10.00%' WHEN claim_rate < 20.00 THEN '<20.00%' ELSE '>=20.00%' END claim_rate`
    * `claim_count , count (distinct t._id) txn_count , claim_count::float*100/txn_count claim_rate FROM storehub_mongo.businesses b INNER JOIN storehub_mongo.transactionrecords t ON t.business = b.name AND t.iscancelled is not true AND t.transactiontype = 'Sale' AND t.status NOT IN ('cancelled', 'failed', 'paymentCancelled', 'pendingPayment', 'pendingVerification', 'created') AND t.createdtime::date BETWEEN getdate()::date - 30 AND getdate()::date - 1 AND t.createdtime::date >= b.lastenablecashbackdate::date AND b.planid not like '%internal%' AND b.subscriptionstatus = 'Active' AND b.country = 'TH' AND b.enablecashback LEFT JOIN storehub_mongo.loyaltychangelogs l ON l.business = t.business AND l.receiptnumber = t.receiptnumber AND l.rewardtype = 'cashback' AND l.eventtype = 'earned' AND l.eventtime::date BETWEEN getdate()::date - 30 AND getdate()::date - 1 GROUP BY 1,2 ) SELECT CASE WHEN claim_rate < 0.5 THEN '0.00 %' WHEN claim_rate < 10.00 THEN '<10.00%' WHEN claim_rate < 20.00 THEN '<20.00%' ELSE '>=20.00%' END claim_rate`
    * `claimed cashback #", sum(case when lc.eventtype = 'earned' then lc.amount end) as "claimed cashback amount", count(distinct case when lc.eventtype = 'expense' then lc.receiptnumber end) as "redeemed cashback #", -sum(case when lc.eventtype = 'expense' then lc.amount end) as "redeemed cashback amount", "redeemed cashback amount" / "claimed cashback amount" as "cashback utilisation rate`
    * `claimed cashback amount (SGD)", -sum(case when lc.eventtype = 'expense' and b.country = 'MY' then lc.amount * {{myr_rate}} when lc.eventtype = 'expense' and b.country = 'PH' then lc.amount * {{php_rate}} when lc.eventtype = 'expense' and b.country = 'TH' then lc.amount * {{thb_rate}} when lc.eventtype = 'expense' and b.country = 'SG' then lc.amount end) as "redeemed cashback amount (SGD)", "redeemed cashback amount (SGD)" / "claimed cashback amount (SGD)" as "cashback utilisation rate`

---

### **Metric: Commission**
* **Found:** 1 times
* **Common Calculations:**
    * `Commission Rate`

---


## Methodology

### Schema Mapping Applied
The following schema mappings were applied during analysis:
* `transformations.mask_businesses`  `storehub_mongo.businesses`
* `transformations.mask_employees`  `storehub_mongo.employees`
* `transformations.mask_customers`  `storehub_mongo.customers`

### Pattern Recognition
Metrics were identified using regex patterns that match common SQL aggregation functions and business calculation patterns. The analysis focused on:
* SUM, COUNT, AVG aggregations
* CASE WHEN conditional logic
* Mathematical operations (subtraction, division)
* Business-specific field names and operations

### Limitations
* Complex nested queries may not be fully captured
* Dynamic SQL or programmatically generated queries may be missed
* Business logic embedded in application code is not included
